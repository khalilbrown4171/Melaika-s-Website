<!DOCTYPE html>

<html lang="en">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Ancient Civilizations Virtual Field Trip</title>

    <!-- Load Tailwind CSS -->

    <script src=https://cdn.tailwindcss.com></script>

    <link href=https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap rel="stylesheet">

    <style>

        /* Custom styles for aesthetic font and a richer, darker theme */

        body {

            font-family: 'Inter', sans-serif;

            background-color: #1a202c; /* Dark background for immersive feel */

            color: #e2e8f0;

        }

        header {

            background-color: #2d3748; /* Darker grey header */

        }

        h1, h2, h3 {

            color: #ffffff;

        }

        .hotspot-card {

            transition: all 0.3s ease;

            cursor: pointer;

            min-height: 250px;

            background-color: #2d3748; /* Card background */

            border-color: #4a5568;

        }

        .hotspot-card:hover {

            transform: translateY(-4px);

            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);

            border-color: #4299e1; /* Blue hover border */

        }

       

        /* Hotspot Completion State */

        .completed {

            border-color: #38a169 !important; /* Green 600 */

            background-color: #2f4744 !important; /* Darker green background */

        }

 

        /* Modal Styles - The Field Trip Viewer */

        .modal {

            display: none;

            position: fixed;

            z-index: 1000;

            left: 0;

            top: 0;

            width: 100%;

            height: 100%;

            overflow: auto;

            background-color: rgba(0, 0, 0, 0.95);

            justify-content: center;

            align-items: center;

        }

        .modal-content {

            background-color: #2d3748;

            margin: auto;

            padding: 24px;

            border-radius: 16px;

            width: 95%;

            max-width: 1000px;

            position: relative;

            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8);

            border: 2px solid #4a5568;

        }

        .close-btn {

            color: #a0aec0;

            position: absolute;

            top: 15px;

            right: 25px;

            font-size: 36px;

            font-weight: bold;

            line-height: 1;

        }

        .close-btn:hover,

        .close-btn:focus {

            color: #ffffff;

            text-decoration: none;

            cursor: pointer;

        }

 

        /* Canvas container for 16:9 aspect ratio */

        .aspect-visualization {

            aspect-ratio: 16 / 9;

        }

    </style>

</head>

<body class="p-4 md:p-8">

 

    <div id="app" class="max-w-7xl mx-auto">

       

        <!-- HEADER AND LANGUAGE SELECTOR -->

        <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 p-4 rounded-xl shadow-2xl">

            <h1 class="text-3xl font-bold text-white mb-4 sm:mb-0">Ancient Civilizations Virtual Field Trip</h1>

 

            <div class="flex flex-col md:flex-row items-start md:items-center space-y-4 md:space-y-0 md:space-x-8">

                <div class="flex items-center space-x-4">

                    <div id="db-status" class="px-3 py-1 text-xs font-medium rounded-full"></div>

                   

                    <p id="choose-language" class="text-gray-400"></p>

                    <select id="language-selector" class="p-2 border border-gray-600 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-700 text-white">

                        <option value="en">English (en)</option>

                        <option value="es">Espa√±ol (es)</option>

                        <option value="fr">Fran√ßais (fr)</option>

                    </select>

                </div>

            </div>

        </header>

 

        <!-- MAIN NAVIGATION & TIMER -->

        <div class="flex flex-wrap gap-4 mb-8">

            <button id="explore-mode-btn" class="flex-1 min-w-[150px] px-4 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-150"></button>

            <button id="teacher-view-btn" class="flex-1 min-w-[150px] px-4 py-3 bg-gray-600 text-white font-semibold rounded-lg shadow-md hover:bg-gray-700 transition duration-150"></button>

            <div id="session-timer" class="flex-1 min-w-[150px] flex items-center justify-center bg-yellow-900 text-yellow-300 font-bold p-3 rounded-lg shadow-inner"></div>

            <button id="export-analytics-btn" class="flex-1 min-w-[150px] px-4 py-3 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition duration-150">Export Analytics</button>

        </div>

       

        <!-- STUDENT EXPLORE MODE (FIELD TRIP DESTINATIONS) -->

        <div id="explore-mode-view">

            <h2 class="text-2xl font-semibold text-gray-200 mb-6">Field Trip Destinations: Engineering Adaptation</h2>

            <div id="hotspots-container" class="grid md:grid-cols-3 gap-6 mb-12">

               

                <!-- Maya Hotspot -->

                <div id="maya-river-card" data-hotspot-id="maya_river" class="hotspot-card interaction-card p-6 rounded-xl shadow-lg border-t-4 border-gray-600">

                    <div class="flex justify-between items-start mb-3">

                        <h3 class="text-xl font-bold text-white" id="maya-river-title"></h3>

                        <button class="play-voiceover-btn text-2xl text-purple-400 hover:text-purple-300 transition duration-150" data-hotspot="maya_river">üéôÔ∏è</button>

                    </div>

                    <p class="text-sm text-gray-400 mb-4" id="maya-river-short"></p>

                    <div class="space-y-3">

                        <div class="p-3 bg-green-900 rounded-lg text-sm interaction-prompt text-green-200" id="maya-river-prompt"></div>

                    </div>

                    <div class="mt-4 text-sm font-semibold text-green-400 hidden" id="maya-river-status">FIELD TRIP COMPLETED</div>

                </div>

 

                <!-- Aztec Hotspot -->

                <div id="aztec-chinampa-card" data-hotspot-id="aztec_chinampa" class="hotspot-card interaction-card p-6 rounded-xl shadow-lg border-t-4 border-gray-600">

                    <div class="flex justify-between items-start mb-3">

                        <h3 class="text-xl font-bold text-white" id="aztec-chinampa-title"></h3>

                        <button class="play-voiceover-btn text-2xl text-purple-400 hover:text-purple-300 transition duration-150" data-hotspot="aztec_chinampa">üéôÔ∏è</button>

                    </div>

                    <p class="text-sm text-gray-400 mb-4" id="aztec-chinampa-short"></p>

                    <div class="space-y-3">

                        <div class="p-3 bg-red-900 rounded-lg text-sm interaction-prompt text-red-200" id="aztec-chinampa-prompt"></div>

                    </div>

                    <div class="mt-4 text-sm font-semibold text-green-400 hidden" id="aztec-chinampa-status">FIELD TRIP COMPLETED</div>

                </div>

 

                <!-- Inca Hotspot -->

                <div id="inca-terrace-card" data-hotspot-id="inca_terrace" class="hotspot-card interaction-card p-6 rounded-xl shadow-lg border-t-4 border-gray-600">

                    <div class="flex justify-between items-start mb-3">

                        <h3 class="text-xl font-bold text-white" id="inca-terrace-title"></h3>

                        <button class="play-voiceover-btn text-2xl text-purple-400 hover:text-purple-300 transition duration-150" data-hotspot="inca_terrace">üéôÔ∏è</button>

                    </div>

                    <p class="text-sm text-gray-400 mb-4" id="inca-terrace-short"></p>

                    <div class="space-y-3">

                        <div class="p-3 bg-blue-900 rounded-lg text-sm interaction-prompt text-blue-200" id="inca-terrace-prompt"></div>

                    </div>

                    <div class="mt-4 text-sm font-semibold text-green-400 hidden" id="inca-terrace-status">FIELD TRIP COMPLETED</div>

                </div>

            </div>

 

            <!-- RESPONSE FRAME ACTIVITY -->

            <div class="bg-indigo-900 p-6 rounded-xl shadow-inner border-t-2 border-indigo-700">

                <h2 class="text-xl font-bold text-indigo-200 mb-4" id="response-frame-title"></h2>

               

                <p id="save-status" class="text-sm text-gray-400 mb-4">Saving status: Waiting for input...</p>

 

                <div class="space-y-4">

                    <!-- Central Idea Input -->

                    <div class="bg-gray-800 p-4 rounded-lg shadow-md">

                        <p class="text-gray-300 mb-2 font-semibold" id="central-idea-frame"></p>

                        <input type="text" data-field="centralIdea" id="central-idea-input" placeholder="Start your summary here..." class="assignment-input w-full p-2 border border-gray-600 rounded-md focus:ring-indigo-500 focus:border-indigo-500 bg-gray-700 text-white">

                    </div>

                   

                    <!-- Detail 1 Input -->

                    <div class="bg-gray-800 p-4 rounded-lg shadow-md">

                        <p class="text-gray-300 mb-2 font-semibold" id="detail-prompt-1"></p>

                        <input type="text" data-field="detail1" id="detail-1-input" placeholder="Explain your first supporting detail and its evidence..." class="assignment-input w-full p-2 border border-gray-600 rounded-md focus:ring-indigo-500 focus:border-indigo-500 bg-gray-700 text-white">

                    </div>

 

                    <!-- Detail 2 Input -->

                    <div class="bg-gray-800 p-4 rounded-lg shadow-md">

                        <p class="text-gray-300 mb-2 font-semibold" id="detail-prompt-2"></p>

                        <input type="text" data-field="detail2" id="detail-2-input" placeholder="Explain your second supporting detail and its evidence..." class="assignment-input w-full p-2 border border-gray-600 rounded-md focus:ring-indigo-500 focus:border-indigo-500 bg-gray-700 text-white">

                    </div>

                </div>

            </div>

        </div>

 

        <!-- TEACHER VIEW MODE -->

        <div id="teacher-view-content" class="hidden">

            <h2 class="text-3xl font-bold text-gray-200 mb-6 border-b border-gray-600 pb-2">Teacher Dashboard: Student Submissions</h2>

            <div id="submissions-list" class="space-y-6">

                <p class="text-gray-500" id="loading-submissions">Loading student submissions...</p>

                <!-- Submission cards will be inserted here -->

            </div>

        </div>

    </div>

 

    <!-- MODAL FOR FIELD TRIP VIEWER (VISUALIZATION) -->

    <div id="visualization-modal" class="modal">

        <div class="modal-content">

            <span class="close-btn" id="modal-close-btn">&times;</span>

            <h3 class="text-2xl font-bold mb-4 text-white" id="modal-title"></h3>

           

            <!-- CANVAS CONTAINER where the visualization will be dynamically drawn -->

            <div id="canvas-wrapper" class="aspect-visualization relative rounded-xl mb-4 border-4 border-gray-600 shadow-2xl overflow-hidden">

                <!-- Placeholder Image for context, overlaid by dynamic Canvas -->

                <img id="scene-image" class="absolute inset-0 w-full h-full object-cover opacity-30" src=https://placehold.co/900x500/1e293b/a5b4fc?text=Field+Trip+Destination+Context onerror="this.src='https://placehold.co/900x500/1e293b/a5b4fc?text=Field+Trip+Destination+Context'" alt="Context image for the ancient site">

                <canvas id="visualization-canvas" class="w-full h-full absolute inset-0"></canvas>

            </div>

           

            <p id="modal-narration" class="text-gray-300 text-lg leading-relaxed"></p>

            <p class="mt-4 text-md font-semibold text-purple-400" id="modal-interaction-prompt"></p>

        </div>

    </div>

 

    <!-- Firebase SDK Imports -->

    <script type="module">

        import { initializeApp } from https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js;

        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js;

        import { getFirestore, doc, setDoc, onSnapshot, collection } from https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js;

        import { setLogLevel } from https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js;

       

        // Set log level for debugging

        setLogLevel('debug');

 

        // Global variables provided by the environment

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;

        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

 

        let db = null;

        let auth = null;

        let currentUserId = null;

        let isDbConnected = false;

        let animationFrameId = null; // To control the canvas animation loop

 

        // --- Core Application Data (for Localization and Structure) ---

        const APP_DATA = {

            "locale": "en",

            "ui": {

                "choose_language": { "en": "Language:", "es": "Idioma:", "fr": "Langue:" },

                "explore_mode": { "en": "Start Field Trip", "es": "Comenzar Viaje", "fr": "D√©marrer l'Excursion" },

                "teacher_view": { "en": "Teacher Dashboard", "es": "Panel del Profesor", "fr": "Tableau de Bord du Professeur" },

                "response_frame_title": { "en": "Assignment: Synthesize Adaptation Strategies", "es": "Tarea: Sintetizar Estrategias de Adaptaci√≥n", "fr": "Devoir: Synth√©tiser les Strat√©gies d'Adaptation" },

                "session_timer": { "en": "Time Remaining: {mm}:{ss}", "es": "Tiempo Restante: {mm}:{ss}", "fr": "Temps Restant: {mm}:{ss}" }

            },

            "hotspots": {

                "maya_river": {

                    "title": { "en": "Maya: Cenotes (Water & Trade Hub)", "es": "Maya: Cenotes (Agua y Comercio)", "fr": "Maya: C√©notes (Eau et Commerce)" },

                    "short": { "en": "Explore the natural water sources critical for survival and trade in the Yucat√°n.", "es": "Explore las fuentes de agua naturales cr√≠ticas para la supervivencia y el comercio en Yucat√°n.", "fr": "Explorez les sources d'eau naturelles cruciales pour la survie et le commerce au Yucat√°n." },

                    "scene_url": https://placehold.co/900x500/165511/F0F0F0?text=Maya+Yucatan+Jungle+Site,

                    "narration": {

                        "en": "The Mayan civilization thrived in the dense, tropical rainforest of the Yucat√°n Peninsula, where surface rivers were scarce. To adapt, they relied heavily on **Cenotes**, natural pits formed by the collapse of limestone bedrock, which exposed deep underground water. These Cenotes were not only essential for **drinking and agriculture**, but also served as vital **ceremonial sites and trade hubs**, connecting settlements across the region.",

                        "es": "La civilizaci√≥n Maya prosper√≥ en la densa selva tropical de la Pen√≠nsula de Yucat√°n, donde los r√≠os superficiales eran escasos. Para adaptarse, dependieron en gran medida de los **Cenotes**, pozos naturales formados por el colapso de la roca caliza que expon√≠an agua subterr√°nea profunda. Estos Cenotes no solo eran esenciales para **beber y la agricultura**, sino que tambi√©n serv√≠an como **sitios ceremoniales y centros comerciales** vitales, conectando asentamientos a lo largo de la regi√≥n.",

                        "fr": "La civilisation Maya a prosp√©r√© dans la dense for√™t tropicale de la p√©ninsule du Yucat√°n, o√π les rivi√®res de surface √©taient rares. Pour s'adapter, ils ont fortement d√©pendu des **C√©notes**, des fosses naturelles form√©es par l'effondrement du socle calcaire qui exposaient de profondes nappes d'eau souterraines. Ces C√©notes √©taient non seulement essentiels pour **la boisson et l'agriculture**, mais servaient √©galement de **sites c√©r√©moniels vitaux et de carrefours commerciaux**, reliant les colonies √† travers la r√©gion."

                    },

                    "interaction": { "type": "placeResource", "prompt": { "en": "Click to place a Trade Post and log your observation.", "es": "Haga clic para colocar un Puesto Comercial y registrar su observaci√≥n.", "fr": "Cliquez pour placer un Poste de Commerce et enregistrer votre observation." } },

                },

                "aztec_chinampa": {

                    "title": { "en": "Aztec: Chinampas (Floating Gardens)", "es": "Azteca: Chinampas (Jardines Flotantes)", "fr": "Azt√®que: Chinampas (Jardins Flottants)" },

                    "short": { "en": "Study the ingenious agricultural system that fed the massive capital of Tenochtitlan.", "es": "Estudie el ingenioso sistema agr√≠cola que aliment√≥ la enorme capital de Tenochtitlan.", "fr": "√âtudiez le syst√®me agricole ing√©nieux qui a nourri la capitale massive de Tenochtitlan." },

                    "scene_url": https://placehold.co/900x500/104351/F0F0F0?text=Aztec+Lake+Texcoco+Site,

                    "narration": {

                        "en": "The Aztec capital, Tenochtitlan, was built on a swampy island in Lake Texcoco. To overcome the lack of arable land and feed a growing population of hundreds of thousands, the Aztecs engineered **Chinampas**, or 'floating gardens'. These were highly fertile, rectangular plots of land created by layering mud, vegetation, and decaying matter onto the lakebed, providing **multiple harvests a year** and a stable food supply.",

                        "es": "La capital Azteca, Tenochtitlan, fue construida en una isla pantanosa en el Lago Texcoco. Para superar la falta de tierra cultivable y alimentar a una poblaci√≥n creciente de cientos de miles, los Aztecas ingeniaron **Chinampas**, o 'jardines flotantes'. Eran parcelas de tierra rectangulares y muy f√©rtiles creadas al superponer barro, vegetaci√≥n y materia en descomposici√≥n sobre el lecho del lago, proporcionando **m√∫ltiples cosechas al a√±o** y un suministro estable de alimentos.",

                        "fr": "La capitale Azt√®que, Tenochtitlan, a √©t√© construite sur une √Æle mar√©cageuse du lac Texcoco. Pour pallier le manque de terres arables et nourrir une population croissante de centaines de milliers d'habitants, les Azt√®ques ont con√ßu les **Chinampas**, ou 'jardines flottants'. Il s'agissait de parcelles de terre rectangulaires tr√®s fertiles, cr√©√©es en superposant de la boude, de la v√©g√©tation et de la mati√®re en d√©composition sur le fond du lac, permettant **plusieurs r√©coltes par an** et un approvisionnement alimentaire stable."

                    },

                    "interaction": { "type": "buildChinampa", "prompt": { "en": "Click to simulate building a Chinampa and log your observation.", "es": "Haga clic para simuler la construcci√≥n de una Chinampa et enregistrer votre observation.", "fr": "Cliquez pour simuler la construction d'une Chinampa et enregistrer votre observation." } },

                },

                "inca_terrace": {

                    "title": { "en": "Inca: Terrace Farming (Andes)", "es": "Inca: Cultivo en Terrazas (Andes)", "fr": "Inca: Agriculture en Terrasses (Andes)" },

                    "short": { "en": "View the engineering marvel of stable, high-altitude agriculture in the steep Andean mountains.", "es": "Vea la maravilla de ingenier√≠a de la agricultura estable a gran altura en las escarpadas monta√±as andinas.", "fr": "D√©couvrez la merveille d'ing√©nierie de l'agriculture stable en haute altitude dans les montagnes abruptes." },

                    "scene_url": https://placehold.co/900x500/5A5A5A/F0F0F0?text=Inca+Andes+Mountain+Site,

                    "narration": {

                        "en": "Living high in the **Andes Mountains**, the Inca faced the extreme challenge of steep slopes and variable climate. Their solution was **terrace farming**. By constructing massive stone walls to create flat, stepped fields, they not only stabilized the mountain slopes against **erosion** but also created **microclimates**. These tiered systems captured and conserved precious rainfall, allowing them to cultivate crops like potatoes and quinoa efficiently at altitudes up to 12,000 feet.",

                        "es": "Viviendo en lo alto de las **Monta√±as de los Andes**, los Incas enfrentaron el desaf√≠o extremo de las laderas empinadas y el clima variable. Su soluci√≥n fue la **agricultura en terrazas**. Al construir enormes muros de piedra para crear campos planos y escalonados, no solo estabilizaron las laderas contra la **erosi√≥n**, sino que tambi√©n crearon **microclimas**. Estos sistemas escalonados captaban y conservaban las preciosas lluvias, permiti√©ndoles cultivar eficientemente cosechas como la papa y la quinua a altitudes de hasta 12,000 pies.",

                        "fr": "Vivant en altitude dans les **montagnes des Andes**, les Incas ont √©t√© confront√©s au d√©fi extr√™me des pentes raides et d'un climat variable. Leur solution fut l'**agriculture en terrasses**. En construisant des murs de pierre massifs pour cr√©er des champs plats et √©tag√©s, ils ont non seulement stabilis√© les pentes contre l'**√©rosion**, mais ont √©galement cr√©√© des **microclimats**. Ces syst√®mes √©tag√©s captaient et conservaient les pr√©cieuses eaux de pluie, leur permettant de cultiver efficacement des cultures comme la pomme de terre et le quinoa √† des altitudes allant jusqu'√† 12 000 pieds."

                    },

                    "interaction": { "type": "buildTerrace", "prompt": { "en": "Click to simulate building a Terrace and log your observation.", "es": "Haga clic para simular la construcci√≥n de una Terraza y registrar su observaci√≥n.", "fr": "Cliquez pour simuler la construction d'une Terraza y enregistrer su observation." } },

                }

            },

            "sentence_frames": {

                "central_idea": {

                    "en": "The primary way ancient civilizations adapted to their environments was by __________.",

                    "es": "La forma principal en que las civilizaciones antiguas se adaptaron a sus entornos fue mediante __________.",

                    "fr": "La principale fa√ßon dont les civilisations antiques se sont adapt√©es √† leurs environnements fut de __________."

                },

                "detail_prompt": {

                    "en": "The first key detail that supports this idea is the use of ______ by the ______ civilization, which addressed the challenge of ______.",

                    "es": "El primer detalle clave que apoya esta idea es el uso de ______ por la civilizaci√≥n de los ______, que abord√≥ el desaf√≠o de ______.",

                    "fr": "Le premier d√©tail cl√© qui soutient cette id√©e est l'utilisation de ______ por la civilisation ______, qui a relev√© le d√©fi de ______."

                }

            }

        };

 

        // --- Firebase Initialization and Authentication ---

 

        async function initializeFirebase() {

            const dbStatusEl = document.getElementById('db-status');

            dbStatusEl.textContent = 'Connecting...';

            dbStatusEl.className = 'px-3 py-1 text-xs font-medium rounded-full bg-gray-600 text-gray-200';

           

            if (!firebaseConfig) {

                dbStatusEl.textContent = 'DB Error: No Config';

                dbStatusEl.className = 'px-3 py-1 text-xs font-medium rounded-full bg-red-800 text-red-200';

                console.error("Firebase config is missing.");

                return;

            }

 

            try {

                const app = initializeApp(firebaseConfig);

                db = getFirestore(app);

                auth = getAuth(app);

 

                if (initialAuthToken) {

                    await signInWithCustomToken(auth, initialAuthToken);

                } else {

                    await signInAnonymously(auth);

                }

 

                await new Promise(resolve => onAuthStateChanged(auth, user => {

                    if (user) {

                        currentUserId = user.uid;

                    } else {

                        currentUserId = crypto.randomUUID();

                    }

                    isDbConnected = true;

                    dbStatusEl.textContent = `User ID: ${currentUserId.substring(0, 8)}...`;

                    dbStatusEl.className = 'px-3 py-1 text-xs font-medium rounded-full bg-green-700 text-green-100';

                    resolve();

                }));

 

                loadWork();

 

            } catch (error) {

                dbStatusEl.textContent = 'DB Error: Auth Failed';

                dbStatusEl.className = 'px-3 py-1 text-xs font-medium rounded-full bg-red-800 text-red-200';

                console.error("Firebase initialization or authentication failed:", error);

            }

        }

       

        // --- Firestore Data Paths and Functions ---

       

        function getStudentWorkDocRef() {

            if (!db || !currentUserId) return null;

            return doc(db, 'artifacts', appId, 'users', currentUserId, 'responseFrames', 'mainAssignment');

        }

 

        function getTeacherCollectionRef() {

            if (!db) return null;

            return collection(db, 'artifacts', appId, 'public', 'data', 'studentResponses');

        }

 

        async function saveWork(field, value, completedHotspots) {

            if (!isDbConnected || !currentUserId) {

                console.warn("Database not connected. Cannot save work.");

                return;

            }

 

            const docRef = getStudentWorkDocRef();

            const teacherDocRef = doc(getTeacherCollectionRef(), currentUserId);

           

            const saveStatusEl = document.getElementById('save-status');

            saveStatusEl.textContent = 'Saving...';

 

            const updateData = {};

            if (field) updateData[field] = value;

            if (completedHotspots) updateData.completedHotspots = completedHotspots;

           

            try {

                const timestamp = new Date().toISOString();

                updateData.lastUpdated = timestamp;

                updateData.userId = currentUserId;

 

                await setDoc(docRef, updateData, { merge: true });

                await setDoc(teacherDocRef, updateData, { merge: true });

 

                saveStatusEl.textContent = `Saved automatically at ${new Date().toLocaleTimeString()}`;

            } catch (error) {

                saveStatusEl.textContent = 'Save Failed!';

                console.error("Error saving work to Firestore:", error);

            }

        }

 

        function loadWork() {

            if (!isDbConnected || !currentUserId) return;

 

            const docRef = getStudentWorkDocRef();

           

            onSnapshot(docRef, (docSnap) => {

                if (docSnap.exists()) {

                    const data = docSnap.data();

                   

                    if (data.centralIdea) document.getElementById('central-idea-input').value = data.centralIdea;

                    if (data.detail1) document.getElementById('detail-1-input').value = data.detail1;

                    if (data.detail2) document.getElementById('detail-2-input').value = data.detail2;

                   

                    if (data.completedHotspots) {

                        Object.keys(data.completedHotspots).forEach(hotspotId => {

                            if (data.completedHotspots[hotspotId] === true) {

                                const cardId = hotspotId.replace(/_/g, '-') + '-card';

                                const card = document.getElementById(cardId);

                               

                                if (card) {

                                    card.classList.add('completed');

                                    const statusElementId = hotspotId.replace(/_/g, '-') + '-status';

                                    const statusElement = document.getElementById(statusElementId);

                                    if(statusElement) statusElement.classList.remove('hidden');

                                }

                            }

                        });

                    }

                }

            }, (error) => {

                console.error("Error loading work in real-time:", error);

            });

        }

 

        // --- UI/Localization & Event Handlers ---

 

        let currentLocale = APP_DATA.locale;

        let audioCtx = null;

        let ttsAudio = null;

 

        function initAudio() {

            if (!audioCtx) {

                try {

                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();

                } catch (e) {

                    console.error("Audio Context initialization failed:", e);

                }

            }

            if (audioCtx && audioCtx.state === 'suspended') {

                audioCtx.resume().catch(e => console.error("Failed to resume AudioContext:", e));

            }

        }

 

        function getLocalizedText(path, locale = currentLocale) {

            const parts = path.split('.');

            let data = APP_DATA;

            for (const part of parts) {

                if (data && data.hasOwnProperty(part)) {

                    data = data[part];

                } else {

                    return `[Missing Text: ${path}]`;

                }

            }

            if (typeof data === 'object' && data !== null && data.hasOwnProperty(locale)) {

                return data[locale];

            }

            return data;

        }

 

        function render() {

            document.getElementById('choose-language').textContent = getLocalizedText('ui.choose_language');

            document.getElementById('explore-mode-btn').textContent = getLocalizedText('ui.explore_mode');

            document.getElementById('teacher-view-btn').textContent = getLocalizedText('ui.teacher_view');

            document.getElementById('response-frame-title').textContent = getLocalizedText('ui.response_frame_title');

 

            Object.entries(APP_DATA.hotspots).forEach(([id, data]) => {

                const elementIdBase = id.replace(/_/g, '-');

               

                const titleEl = document.getElementById(`${elementIdBase}-title`);

                const shortEl = document.getElementById(`${elementIdBase}-short`);

                const promptEl = document.getElementById(`${elementIdBase}-prompt`);

 

                if (titleEl) titleEl.textContent = data.title[currentLocale];

                if (shortEl) shortEl.textContent = data.short[currentLocale];

                if (promptEl) promptEl.textContent = data.interaction.prompt[currentLocale];

            });

 

            document.getElementById('central-idea-frame').textContent = getLocalizedText('sentence_frames.central_idea', currentLocale);

            const detailPrompt = getLocalizedText('sentence_frames.detail_prompt', currentLocale);

            document.getElementById('detail-prompt-1').textContent = detailPrompt.replace(/______|______/g, '_________');

            document.getElementById('detail-prompt-2').textContent = detailPrompt.replace(/______|______/g, '_________');

        }

       

        // --- Canvas Visualization Logic ---

 

        let offset = 0; // Global animation offset

       

        /** Draws the visualization based on the hotspot ID. */

        function drawVisualization(hotspotId, canvas, ctx) {

            if (!ctx) return;

 

            // Clear Canvas with a semi-transparent black overlay for context depth

            ctx.fillStyle = 'rgba(0, 0, 0, 0.4)';

            ctx.fillRect(0, 0, canvas.width, canvas.height);

           

            const W = canvas.width;

            const H = canvas.height;

            const P = 10; // Padding for labels

           

            // Safety check for size

            if (W <= 0 || H <= 0) {

                stopVisualization();

                return;

            }

 

            // Increment global offset for shared animation elements

            offset += 0.03;

 

            try {

                if (hotspotId === 'aztec_chinampa') {

                    // --- AZTEC CHINAMPA VISUALIZATION ---

                    const waterLevel = H * 0.75;

                    const chinampaHeight = H * 0.18;

                    const chinampaTopY = waterLevel - chinampaHeight;

                    const chinampaWidth = W * 0.7;

                    const chinampaX = (W - chinampaWidth) / 2;

                    const plantGrowth = (Math.sin(offset * 0.8) * 0.5 + 0.5) * chinampaHeight * 0.6;

 

                    // Draw Water (Animated Wave)

                    ctx.fillStyle = '#0077b6';

                    ctx.fillRect(0, waterLevel, W, H - waterLevel);

                    ctx.beginPath();

                    ctx.moveTo(0, waterLevel);

                    for (let i = 0; i < W; i += 5) {

                        const wave = Math.sin((i * 0.02) + offset) * 3;

                        ctx.lineTo(i, waterLevel + wave);

                    }

                    ctx.lineTo(W, waterLevel);

                    ctx.lineTo(W, H);

                    ctx.lineTo(0, H);

                    ctx.closePath();

                    ctx.fillStyle = '#00b4d8';

                    ctx.fill();

 

                    // Draw Chinampa Cross-section

                    // Base mud/reeds (Submerged)

                    ctx.fillStyle = '#4B3621';

                    ctx.fillRect(chinampaX, chinampaTopY + chinampaHeight - 10, chinampaWidth, 10);

 

                    // Fertile Soil Layer (Top layer)

                    ctx.fillStyle = '#8B4513';

                    ctx.fillRect(chinampaX, chinampaTopY, chinampaWidth, chinampaHeight);

                   

                    // Water absorption animation (Simplified flow line)

                    ctx.strokeStyle = '#45B3E0';

                    ctx.lineWidth = 3;

                    ctx.beginPath();

                    ctx.moveTo(chinampaX - 20, waterLevel + 10);

                    ctx.lineTo(chinampaX, chinampaTopY + chinampaHeight - 5);

                    ctx.stroke();

 

                    // Animated Crops

                    const plantX = chinampaX + chinampaWidth / 2;

                    ctx.fillStyle = '#38761d';

                    ctx.fillRect(plantX - 2, chinampaTopY - plantGrowth, 4, plantGrowth);

                    ctx.beginPath();

                    ctx.arc(plantX, chinampaTopY - plantGrowth, 8, 0, Math.PI * 2, false);

                    ctx.fill();

 

                    // Draw Labels

                    ctx.font = 'bold 16px Inter';

                    ctx.fillStyle = '#FFFFFF';

                    ctx.fillText('Floating Garden (Chinampa)', chinampaX + P, chinampaTopY + 20);

                    ctx.fillText('Fertile Soil', chinampaX + P, chinampaTopY + 45);

                    ctx.fillStyle = '#000000';

                    ctx.fillText('Lake Water', P, waterLevel + 20);

 

                } else if (hotspotId === 'maya_river') {

                    // --- MAYA CENOTE VISUALIZATION ---

                    const groundLevel = H * 0.4;

                    const jungleColor = '#1e8449';

                    const cenoteWater = '#45B3E0';

                    const caveRock = '#8D6E63';

 

                    // 1. Jungle Canopy (Top section)

                    ctx.fillStyle = jungleColor;

                    ctx.fillRect(0, 0, W, groundLevel);

                    ctx.fillStyle = 'rgba(0,0,0,0.1)';

                    ctx.fillRect(0, 0, W, groundLevel);

                   

                    // 2. Underground Cross-section (Bottom half)

                    ctx.fillStyle = caveRock;

                    ctx.fillRect(0, groundLevel, W, H - groundLevel);

 

                    // 3. Cenote Water Body

                    const cenoteX = W * 0.5;

                    const cenoteY = H * 0.75;

                    const cenoteRadius = W * 0.3;

                   

                    ctx.beginPath();

                    ctx.arc(cenoteX, cenoteY, cenoteRadius, 0, Math.PI * 2, false);

                    ctx.fillStyle = cenoteWater;

                    ctx.fill();

 

                    // 4. Sinkhole Opening (Top view)

                    const sinkholeWidth = W * 0.15;

                    ctx.fillStyle = cenoteWater;

                    ctx.beginPath();

                    ctx.ellipse(cenoteX, groundLevel, sinkholeWidth / 2, 10, 0, 0, Math.PI * 2);

                    ctx.fill();

 

                    // 5. Animated Water Drop (Movement from surface to cenote)

                    const dropX = cenoteX;

                    const dropY = groundLevel + (Math.sin(offset * 2) * 0.5 + 0.5) * (cenoteY - groundLevel - 10);

                    ctx.fillStyle = '#FFFFFF';

                    ctx.beginPath();

                    ctx.arc(dropX, dropY, 5, 0, Math.PI * 2);

                    ctx.fill();

                   

                    // 6. Trade Activity (Moving on surface)

                    const tradeX = (W * 0.1) + (Math.abs(Math.cos(offset * 0.3)) * W * 0.8);

                    const tradeY = groundLevel - 20;

                    ctx.fillStyle = '#D4AF37'; // Gold

                    ctx.font = '24px Inter';

                    ctx.fillText('T', tradeX, tradeY); // 'T' for Trade

 

                    // Draw Labels

                    ctx.font = 'bold 16px Inter';

                    ctx.fillStyle = '#FFFFFF';

                    ctx.fillText('Cenote (Fresh Water Source)', cenoteX - 100, cenoteY - cenoteRadius + 30);

                    ctx.fillStyle = '#FFFFFF';

                    ctx.fillText('Jungle Surface', P, 30);

 

 

                } else if (hotspotId === 'inca_terrace') {

                    // --- INCA TERRACE FARMING VISUALIZATION ---

                    const mountainColor = '#8D6E63';

                    const terraceSoil = '#5A3E31';

                    const terracePlant = '#6AA84F';

                   

                    // 1. Mountain Profile

                    ctx.fillStyle = mountainColor;

                    ctx.beginPath();

                    ctx.moveTo(W, H);

                    ctx.lineTo(W, H * 0.2);

                    ctx.lineTo(W * 0.1, H);

                    ctx.closePath();

                    ctx.fill();

 

                    // 2. Draw Terraces

                    const numTerraces = 4;

                    const terraceGap = H * 0.15;

 

                    for (let i = 0; i < numTerraces; i++) {

                        const startY = H * 0.95 - (i * terraceGap);

                        const width = W * (0.9 - i * 0.2);

                        const startX = W * 0.05 + i * W * 0.05;

 

                        // Stone Wall (Retaining)

                        ctx.fillStyle = '#3E2723';

                        ctx.fillRect(startX, startY, width, 15);

                        

                        // Soil Level (Microclimate layer)

                        ctx.fillStyle = terraceSoil;

                        ctx.fillRect(startX, startY - 30, width, 30);

                       

                        // Crops (Animated height)

                        ctx.fillStyle = terracePlant;

                        const plantHeight = 2 + (Math.sin(offset * 0.5 + i * 1) * 0.5 + 0.5) * 8;

                        for (let j = 0; j < 15; j++) {

                            const plantX = startX + 5 + j * (width / 16);

                            ctx.fillRect(plantX, startY - plantHeight, 2, plantHeight);

                        }

 

                        // Irrigation Channel (Side view, Animated flow)

                        if (i < numTerraces - 1) {

                            ctx.fillStyle = '#3498DB';

                            const waterX = startX + width - 10;

                            ctx.fillRect(waterX, startY - terraceGap + 20, 5, terraceGap - 5);

                           

                            // Animated Water Flow dot

                            ctx.fillStyle = '#FFFFFF';

                            const flowY = startY - 5 - (offset * 10) % (terraceGap - 5);

                            ctx.beginPath();

                            ctx.arc(waterX + 2, flowY, 2, 0, Math.PI * 2);

                            ctx.fill();

                        }

                       

                        // Label for Terrace

                        ctx.font = '14px Inter';

                        ctx.fillStyle = '#FFFFFF';

                        ctx.fillText(`Terrace ${i+1}`, startX + P, startY - 10);

                    }

                   

                    // Label for Mountain

                    ctx.font = 'bold 20px Inter';

                    ctx.fillStyle = '#FFFFFF';

                    ctx.fillText('Andes Slopes', W * 0.7, H * 0.15);

                }

            } catch (e) {

                console.error("[Visualization ERROR] An error occurred during drawing. Stopping animation loop:", e);

                stopVisualization();

                return;

            }

 

            // Request next frame

            animationFrameId = requestAnimationFrame(() => drawVisualization(hotspotId, canvas, ctx));

        }

 

        function stopVisualization() {

            if (animationFrameId) {

                cancelAnimationFrame(animationFrameId);

                animationFrameId = null;

            }

        }

       

        // --- Hotspot Manager Logic ---

 

        function handleInteraction(type) {

            let message;

            switch(type) {

                case "buildChinampa": message = "Chinampa built!"; break;

                case "buildTerrace": message = "Terrace completed!"; break;

                case "placeResource": message = "Trade post placed!"; break;

                default: message = "Action completed."; break;

            }

            console.log(`[UIManager Message]: ${message}`);

            logAction(type);

        }

       

        // Function to handle canvas resizing

        function resizeCanvas(canvas) {

            const wrapper = document.getElementById('canvas-wrapper');

            if (wrapper) {

                canvas.width = wrapper.clientWidth;

                canvas.height = wrapper.clientHeight;

            }

        }

 

        function onHotspotClick(hotspotId) {

            initAudio();

 

            const data = APP_DATA.hotspots[hotspotId];

            const narration = data.narration[currentLocale];

            const interactionPrompt = data.interaction.prompt[currentLocale];

            const title = data.title[currentLocale];

            const sceneUrl = data.scene_url;

 

            // 1. Setup Modal Content

            document.getElementById('modal-title').textContent = title;

            document.getElementById('modal-narration').textContent = narration;

            document.getElementById('modal-interaction-prompt').textContent = interactionPrompt;

            document.getElementById('scene-image').src = sceneUrl;

           

            const canvas = document.getElementById('visualization-canvas');

            const ctx = canvas.getContext('2d');

           

            if (!ctx) return;

 

            // Set canvas size for responsiveness BEFORE drawing

            resizeCanvas(canvas);

           

            // Start the unified visualization function

            stopVisualization();

            offset = 0;

            drawVisualization(hotspotId, canvas, ctx);

 

 

            // 2. Show Modal

            document.getElementById('visualization-modal').style.display = 'flex';

 

            // 3. Mark as Completed & Save State

            const cardId = hotspotId.replace(/_/g, '-') + '-card';

            const statusId = hotspotId.replace(/_/g, '-') + '-status';

 

            const card = document.getElementById(cardId);

            const statusEl = document.getElementById(statusId);

 

            if (card) card.classList.add('completed');

            if (statusEl) statusEl.classList.remove('hidden');

 

            handleInteraction(data.interaction.type);

 

            const completedHotspots = {};

            document.querySelectorAll('.hotspot-card').forEach(c => {

                const id = c.getAttribute('data-hotspot-id');

                completedHotspots[id] = c.classList.contains('completed');

            });

            saveWork(null, null, completedHotspots);

        }

       

        function base64ToArrayBuffer(base64) {

            // FIX: Corrected variable name from 'base6brite64' to 'base64'

            const binaryString = atob(base64);

            const len = binaryString.length;

            const bytes = new Uint8Array(len);

            for (let i = 0; i < len; i++) {

                bytes[i] = binaryString.charCodeAt(i);

            }

            return bytes.buffer;

        }

 

        function pcmToWav(pcm16, sampleRate) {

            const numChannels = 1;

            const bytesPerSample = 2;

            const blockAlign = numChannels * bytesPerSample;

            const byteRate = sampleRate * blockAlign;

            const dataSize = pcm16.length * bytesPerSample;

           

            const buffer = new ArrayBuffer(44 + dataSize);

            const dataView = new DataView(buffer);

 

            function writeString(view, offset, str) {

                for (let i = 0; i < str.length; i++) {

                    view.setUint8(offset + i, str.charCodeAt(i));

                }

            }

           

            // RIFF chunk

            writeString(dataView, 0, 'RIFF');

            dataView.setUint32(4, 36 + dataSize, true); // ChunkSize

            writeString(dataView, 8, 'WAVE');

 

            // FMT sub-chunk

            writeString(dataView, 12, 'fmt ');

            dataView.setUint32(16, 16, true);  // Subchunk1Size (16 for PCM)

            dataView.setUint16(20, 1, true);   // AudioFormat (1 for PCM)

            dataView.setUint16(22, numChannels, true);

            dataView.setUint32(24, sampleRate, true);

            dataView.setUint32(28, byteRate, true);

            dataView.setUint16(32, blockAlign, true);

            dataView.setUint16(34, 16, true);  // BitsPerSample

 

            // Data sub-chunk

            writeString(dataView, 36, 'data');

            dataView.setUint32(40, dataSize, true);

 

            let offset = 44;

            for (let i = 0; i < pcm16.length; i++) {

                dataView.setInt16(offset, pcm16[i], true); // PCM data (Little Endian)

                offset += 2;

            }

 

            return new Blob([dataView], { type: 'audio/wav' });

        }

 

 

        async function playVoiceover(hotspotId, button) {

            initAudio();

 

            const narrationText = APP_DATA.hotspots[hotspotId].narration[currentLocale];

            const apiKey = "";

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

 

            if (ttsAudio) {

                ttsAudio.pause();

                ttsAudio.remove();

                ttsAudio = null;

                document.querySelectorAll('.play-voiceover-btn').forEach(btn => btn.textContent = 'üéôÔ∏è');

               

                if (button.textContent === '‚ñ†') return;

            }

           

            button.textContent = '...';

 

            const payload = {

                contents: [{ parts: [{ text: narrationText }] }],

                generationConfig: {

                    responseModalities: ["AUDIO"],

                    speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Leda" } } },

                },

                model: "gemini-2.5-flash-preview-tts"

            };

 

            try {

                let response = null;

                for (let i = 0; i < 3; i++) {

                    response = await fetch(apiUrl, {

                        method: 'POST',

                        headers: { 'Content-Type': 'application/json' },

                        body: JSON.stringify(payload)

                    });

                    if (response.ok) break;

                    await new Promise(r => setTimeout(r, Math.pow(2, i) * 1000));

                }

               

                if (!response || !response.ok) throw new Error(`TTS API failed with status: ${response.status}`);

 

                const result = await response.json();

                const part = result?.candidates?.[0]?.content?.parts?.[0];

                const audioData = part?.inlineData?.data;

                const mimeType = part?.inlineData?.mimeType;

 

                if (audioData && mimeType && mimeType.startsWith("audio/")) {

                    const match = mimeType.match(/rate=(\d+)/);

                    const sampleRate = match ? parseInt(match[1], 10) : 16000;

                    

                    const pcmData = base64ToArrayBuffer(audioData);

                    const pcm16 = new Int16Array(pcmData);

                    const wavBlob = pcmToWav(pcm16, sampleRate);

                    const audioUrl = URL.createObjectURL(wavBlob);

 

                    ttsAudio = new Audio(audioUrl);

                   

                    ttsAudio.play().catch(e => {

                        console.error("Audio playback failed (check browser autoplay policy):", e);

                        button.textContent = 'üîá';

                    });

                    

                    button.textContent = '‚ñ†';

                    

                    ttsAudio.onended = () => {

                        button.textContent = 'üéôÔ∏è';

                        ttsAudio.remove();

                        ttsAudio = null;

                    };

                } else {

                    console.error("TTS Response:", result);

                    throw new Error("Invalid audio response format.");

                }

 

            } catch (error) {

                console.error("Error generating voiceover:", error);

                button.textContent = '‚ùå';

            }

        }

 

 

        // --- Analytics Manager Functions ---

       

        let analyticsEvents = [];

 

        function logAction(action) {

            const timestamp = new Date().toISOString();

            const pos = {x: 0.0, y: 0.0, z: 0.0};

            const ev = `${timestamp}|${action}|${pos.x.toFixed(2)},${pos.y.toFixed(2)},${pos.z.toFixed(2)}`;

            analyticsEvents.push(ev);

        }

 

        function exportAnalytics() {

            const header = "Timestamp|Action|Position_X,Position_Y,Position_Z";

            const csvData = [header, ...analyticsEvents].join('\n');

           

            console.log("--- ANALYTICS EXPORT (CSV) ---");

            console.log(csvData);

            console.log("------------------------------");

        }

 

        // --- Teacher View Logic (omitted for brevity, functional in original) ---

       

        let unsubscribeTeacher = null;

 

        function setViewMode(mode) {

            const exploreView = document.getElementById('explore-mode-view');

            const teacherView = document.getElementById('teacher-view-content');

            const exploreBtn = document.getElementById('explore-mode-btn');

            const teacherBtn = document.getElementById('teacher-view-btn');

 

            if (mode === 'teacher') {

                exploreView.classList.add('hidden');

                teacherView.classList.remove('hidden');

                exploreBtn.classList.replace('bg-blue-600', 'bg-blue-900');

                teacherBtn.classList.replace('bg-gray-600', 'bg-gray-700');

                renderTeacherDashboard();

            } else {

                teacherView.classList.add('hidden');

                exploreView.classList.remove('hidden');

                exploreBtn.classList.replace('bg-blue-900', 'bg-blue-600');

                teacherBtn.classList.replace('bg-gray-700', 'bg-gray-600');

 

                if (unsubscribeTeacher) {

                    unsubscribeTeacher();

                    unsubscribeTeacher = null;

                }

            }

        }

 

        function renderTeacherDashboard() {

            if (!isDbConnected) {

                document.getElementById('loading-submissions').textContent = "Database not connected. Cannot load submissions.";

                return;

            }

 

            const teacherCollection = getTeacherCollectionRef();

            const submissionsList = document.getElementById('submissions-list');

            submissionsList.innerHTML = '<p class="text-gray-500" id="loading-submissions">Loading student submissions...</p>';

 

            unsubscribeTeacher = onSnapshot(teacherCollection, (querySnapshot) => {

                const submissions = [];

                querySnapshot.forEach((doc) => {

                    submissions.push(doc.data());

                });

 

                submissionsList.innerHTML = '';

 

                if (submissions.length === 0) {

                    submissionsList.innerHTML = '<p class="text-gray-600 font-semibold">No student submissions found yet.</p>';

                    return;

                }

 

                submissions.forEach(sub => {

                    const card = document.createElement('div');

                    card.className = 'bg-gray-800 p-5 rounded-lg shadow-md border-l-4 border-indigo-500';

 

                    const completedCount = sub.completedHotspots ? Object.values(sub.completedHotspots).filter(v => v).length : 0;

                   

                    card.innerHTML = `

                        <p class="text-sm font-bold text-indigo-400 mb-2">Student ID: ${sub.userId || 'N/A'} (Last Updated: ${new Date(sub.lastUpdated).toLocaleTimeString()})</p>

                        <p class="text-xs text-gray-400 mb-3">Field Trips Completed: ${completedCount}/3</p>

                        <div class="space-y-3">

                            <p class="font-semibold text-gray-300">Central Idea:</p>

                            <div class="bg-gray-700 p-3 rounded-md text-gray-200">${sub.centralIdea || 'No response.'}</div>

                            <p class="font-semibold text-gray-300">Detail 1:</p>

                            <div class="bg-gray-700 p-3 rounded-md text-gray-200">${sub.detail1 || 'No response.'}</div>

                            <p class="font-semibold text-gray-300">Detail 2:</p>

                            <div class="bg-gray-700 p-3 rounded-md text-gray-200">${sub.detail2 || 'No response.'}</div>

                        </div>

                    `;

                    submissionsList.appendChild(card);

                });

 

            }, (error) => {

                console.error("Error fetching teacher submissions:", error);

                submissionsList.innerHTML = '<p class="text-red-500">Error loading submissions. Check console for details.</p>';

            });

        }

 

 

        // --- Timer Functions ---

 

        const TOTAL_SECONDS = 15 * 60;

        let secondsRemaining = TOTAL_SECONDS;

        let timerInterval = null;

 

        function formatTime(totalSeconds) {

            const minutes = Math.floor(totalSeconds / 60);

            const seconds = totalSeconds % 60;

            return { mm: String(minutes).padStart(2, '0'), ss: String(seconds).padStart(2, '0') };

        }

 

        function updateTimer() {

            const timerEl = document.getElementById('session-timer');

           

            if (secondsRemaining <= 0) {

                clearInterval(timerInterval);

                const time = formatTime(0);

                const template = getLocalizedText('ui.session_timer');

                timerEl.textContent = template.replace('{mm}', time.mm).replace('{ss}', time.ss);

                return;

            }

 

            secondsRemaining--;

 

            const time = formatTime(secondsRemaining);

            const template = getLocalizedText('ui.session_timer');

           

            timerEl.textContent = template.replace('{mm}', time.mm).replace('{ss}', time.ss);

 

            if (secondsRemaining <= 60) {

                timerEl.classList.replace('bg-yellow-900', 'bg-red-900');

                timerEl.classList.replace('text-yellow-300', 'text-red-300');

            } else if (secondsRemaining > 60 && timerEl.classList.contains('bg-red-900')) {

                timerEl.classList.replace('bg-red-900', 'bg-yellow-900');

                timerEl.classList.replace('text-red-300', 'text-yellow-300');

            }

        }

       

        function startTimer() {

            if (timerInterval) clearInterval(timerInterval);

            secondsRemaining = TOTAL_SECONDS;

            timerInterval = setInterval(updateTimer, 1000);

            updateTimer();

        }

 

        // --- Event Listeners and Setup ---

 

        window.onload = function() {

            initializeFirebase();

            render();

            startTimer();

 

            // 1. Language Selector

            document.getElementById('language-selector').addEventListener('change', (e) => {

                currentLocale = e.target.value;

                render();

            });

 

            // 2. Input Change Listeners (for auto-saving work)

            document.querySelectorAll('.assignment-input').forEach(input => {

                input.addEventListener('input', (e) => {

                    const field = e.target.getAttribute('data-field');

                    saveWork(field, e.target.value);

                });

            });

 

            // 3. Hotspot Interaction Listeners

            document.querySelectorAll('.hotspot-card').forEach(card => {

                card.addEventListener('click', (e) => {

                    if (e.target.closest('.play-voiceover-btn')) return;

                   

                    const hotspotId = card.getAttribute('data-hotspot-id');

                    onHotspotClick(hotspotId);

                });

            });

 

            // 4. Voiceover Listeners

            document.querySelectorAll('.play-voiceover-btn').forEach(button => {

                button.addEventListener('click', (e) => {

                    e.stopPropagation();

                    const hotspotId = button.getAttribute('data-hotspot');

                    playVoiceover(hotspotId, button);

                });

            });

 

            // 5. Modal Close Listener

            const modal = document.getElementById('visualization-modal');

           

            document.getElementById('modal-close-btn').addEventListener('click', () => {

                modal.style.display = 'none';

                stopVisualization();

            });

            window.addEventListener('click', (e) => {

                if (e.target === modal) {

                    modal.style.display = 'none';

                    stopVisualization();

                }

            });

           

            // 6. Handle window resize event

            window.addEventListener('resize', () => {

                const canvas = document.getElementById('visualization-canvas');

                if (modal.style.display === 'flex') {

                    resizeCanvas(canvas);

                    const titleText = document.getElementById('modal-title').textContent;

                    let hotspotId = Object.keys(APP_DATA.hotspots).find(key => titleText.includes(APP_DATA.hotspots[key].title[currentLocale].split(':')[1].trim()));

                   

                    if (animationFrameId && hotspotId) {

                        stopVisualization();

                        const ctx = canvas.getContext('2d');

                        if (ctx) drawVisualization(hotspotId, canvas, ctx);

                    }

                }

            });

 

 

            // 7. View Mode Listeners

            document.getElementById('explore-mode-btn').addEventListener('click', () => setViewMode('explore'));

            document.getElementById('teacher-view-btn').addEventListener('click', () => setViewMode('teacher'));

           

            // 8. Export Analytics Listener

            document.getElementById('export-analytics-btn').addEventListener('click', exportAnalytics);

        }

    </script>

</body>

</html>

 

Melaika Brown

Executive Director

Division of Equity and Organizational Development

signature_1198700065

 

 

From: Brown, Melaika A <Melaika_A_Brown@mcpsmd.org>
Date: Saturday, November 29, 2025 at 12:31‚ÄØPM
To: khalilbrown4171@gmail.com <khalilbrown4171@gmail.com>
Subject: Re: code

 

 

Melaika Brown

Executive Director

Division of Equity and Organizational Development

signature_496487766

 

 

From: Brown, Melaika A <Melaika_A_Brown@mcpsmd.org>
Date: Saturday, November 29, 2025 at 12:30‚ÄØPM
To: khalilbrown4171@gmail.com <khalilbrown4171@gmail.com>
Subject: code

<!DOCTYPE html>

<html lang="en">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Ancient Civilizations Virtual Field Trip</title>

    <script src=https://cdn.tailwindcss.com></script>

    <link href=https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap rel="stylesheet">

    <style>

        /* Custom styles for aesthetic font and a richer, darker theme */

        body {

            font-family: 'Inter', sans-serif;

            background-color: #1a202c; /* Dark background for immersive feel */

            color: #e2e8f0;

        }

        header {

            background-color: #2d3748; /* Darker grey header */

        }

        h1, h2, h3 {

            color: #ffffff;

        }

        .hotspot-card {

            transition: all 0.3s ease;

            cursor: pointer;

            min-height: 250px;

            background-color: #2d3748; /* Card background */

            border-color: #4a5568;

        }

        .hotspot-card:hover {

            transform: translateY(-4px);

            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);

            border-color: #4299e1; /* Blue hover border */

        }

       

        /* Hotspot Completion State */

        .completed {

            border-color: #38a169 !important; /* Green 600 */

            background-color: #2f4744 !important; /* Darker green background */

        }

 

        /* Modal Styles - The Field Trip Viewer */

        .modal {

            display: none;

            position: fixed;

            z-index: 1000;

            left: 0;

            top: 0;

            width: 100%;

            height: 100%;

            overflow: auto;

            background-color: rgba(0, 0, 0, 0.95);

            /* Added flex properties to center the modal content */

            display: flex; /* CRITICAL FIX: Changed from 'none' to 'flex' by JS, but 'flex' is needed when visible */

            justify-content: center;

            align-items: center;

        }

        .modal-content {

            background-color: #2d3748;

            margin: auto;

            padding: 24px;

            border-radius: 16px;

            width: 95%;

            max-width: 1000px;

            position: relative;

            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8);

            border: 2px solid #4a5568;

        }

        .close-btn {

            color: #a0aec0;

            position: absolute;

            top: 15px;

            right: 25px;

            font-size: 36px;

            font-weight: bold;

            line-height: 1;

        }

        .close-btn:hover,

        .close-btn:focus {

            color: #ffffff;

            text-decoration: none;

            cursor: pointer;

        }

 

        /* Canvas container for 16:9 aspect ratio */

        .aspect-visualization {

            aspect-ratio: 16 / 9;

        }

    </style>

</head>

<body class="p-4 md:p-8">

 

    <div id="app" class="max-w-7xl mx-auto">

       

        <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 p-4 rounded-xl shadow-2xl">

            <h1 class="text-3xl font-bold text-white mb-4 sm:mb-0">Ancient Civilizations Virtual Field Trip</h1>

 

            <div class="flex flex-col md:flex-row items-start md:items-center space-y-4 md:space-y-0 md:space-x-8">

                <div class="flex items-center space-x-4">

                    <div id="db-status" class="px-3 py-1 text-xs font-medium rounded-full"></div>

                   

                    <p id="choose-language" class="text-gray-400"></p>

                    <select id="language-selector" class="p-2 border border-gray-600 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-700 text-white">

                        <option value="en">English (en)</option>

                        <option value="es">Espa√±ol (es)</option>

                        <option value="fr">Fran√ßais (fr)</option>

                    </select>

                </div>

            </div>

        </header>

 

        <div class="flex flex-wrap gap-4 mb-8">

            <button id="explore-mode-btn" class="flex-1 min-w-[150px] px-4 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-150"></button>

            <button id="teacher-view-btn" class="flex-1 min-w-[150px] px-4 py-3 bg-gray-600 text-white font-semibold rounded-lg shadow-md hover:bg-gray-700 transition duration-150"></button>

            <div id="session-timer" class="flex-1 min-w-[150px] flex items-center justify-center bg-yellow-900 text-yellow-300 font-bold p-3 rounded-lg shadow-inner"></div>

            <button id="export-analytics-btn" class="flex-1 min-w-[150px] px-4 py-3 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition duration-150">Export Analytics</button>

        </div>

       

        <div id="explore-mode-view">

            <h2 class="text-2xl font-semibold text-gray-200 mb-6">Field Trip Destinations: Engineering Adaptation</h2>

            <div id="hotspots-container" class="grid md:grid-cols-3 gap-6 mb-12">

               

                <div id="maya-river-card" data-hotspot-id="maya_river" class="hotspot-card interaction-card p-6 rounded-xl shadow-lg border-t-4 border-gray-600">

                    <div class="flex justify-between items-start mb-3">

                        <h3 class="text-xl font-bold text-white" id="maya-river-title"></h3>

                        <button class="play-voiceover-btn text-2xl text-purple-400 hover:text-purple-300 transition duration-150" data-hotspot="maya_river">üéôÔ∏è</button>

                    </div>

                    <p class="text-sm text-gray-400 mb-4" id="maya-river-short"></p>

                    <div class="space-y-3">

                        <div class="p-3 bg-green-900 rounded-lg text-sm interaction-prompt text-green-200" id="maya-river-prompt"></div>

                    </div>

                    <div class="mt-4 text-sm font-semibold text-green-400 hidden" id="maya-river-status">FIELD TRIP COMPLETED</div>

                </div>

 

                <div id="aztec-chinampa-card" data-hotspot-id="aztec_chinampa" class="hotspot-card interaction-card p-6 rounded-xl shadow-lg border-t-4 border-gray-600">

                    <div class="flex justify-between items-start mb-3">

                        <h3 class="text-xl font-bold text-white" id="aztec-chinampa-title"></h3>

                        <button class="play-voiceover-btn text-2xl text-purple-400 hover:text-purple-300 transition duration-150" data-hotspot="aztec_chinampa">üéôÔ∏è</button>

                    </div>

                    <p class="text-sm text-gray-400 mb-4" id="aztec-chinampa-short"></p>

                    <div class="space-y-3">

                        <div class="p-3 bg-red-900 rounded-lg text-sm interaction-prompt text-red-200" id="aztec-chinampa-prompt"></div>

                    </div>

                    <div class="mt-4 text-sm font-semibold text-green-400 hidden" id="aztec-chinampa-status">FIELD TRIP COMPLETED</div>

                </div>

 

                <div id="inca-terrace-card" data-hotspot-id="inca_terrace" class="hotspot-card interaction-card p-6 rounded-xl shadow-lg border-t-4 border-gray-600">

                    <div class="flex justify-between items-start mb-3">

                        <h3 class="text-xl font-bold text-white" id="inca-terrace-title"></h3>

                        <button class="play-voiceover-btn text-2xl text-purple-400 hover:text-purple-300 transition duration-150" data-hotspot="inca_terrace">üéôÔ∏è</button>

                    </div>

                    <p class="text-sm text-gray-400 mb-4" id="inca-terrace-short"></p>

                    <div class="space-y-3">

                        <div class="p-3 bg-blue-900 rounded-lg text-sm interaction-prompt text-blue-200" id="inca-terrace-prompt"></div>

                    </div>

                    <div class="mt-4 text-sm font-semibold text-green-400 hidden" id="inca-terrace-status">FIELD TRIP COMPLETED</div>

                </div>

            </div>

 

            <div class="bg-indigo-900 p-6 rounded-xl shadow-inner border-t-2 border-indigo-700">

                <h2 class="text-xl font-bold text-indigo-200 mb-4" id="response-frame-title"></h2>

               

                <p id="save-status" class="text-sm text-gray-400 mb-4">Saving status: Waiting for input...</p>

 

                <div class="space-y-4">

                    <div class="bg-gray-800 p-4 rounded-lg shadow-md">

                        <p class="text-gray-300 mb-2 font-semibold" id="central-idea-frame"></p>

                        <input type="text" data-field="centralIdea" id="central-idea-input" placeholder="Start your summary here..." class="assignment-input w-full p-2 border border-gray-600 rounded-md focus:ring-indigo-500 focus:border-indigo-500 bg-gray-700 text-white">

                    </div>

                   

                    <div class="bg-gray-800 p-4 rounded-lg shadow-md">

                        <p class="text-gray-300 mb-2 font-semibold" id="detail-prompt-1"></p>

                        <input type="text" data-field="detail1" id="detail-1-input" placeholder="Explain your first supporting detail and its evidence..." class="assignment-input w-full p-2 border border-gray-600 rounded-md focus:ring-indigo-500 focus:border-indigo-500 bg-gray-700 text-white">

                    </div>

 

                    <div class="bg-gray-800 p-4 rounded-lg shadow-md">

                        <p class="text-gray-300 mb-2 font-semibold" id="detail-prompt-2"></p>

                        <input type="text" data-field="detail2" id="detail-2-input" placeholder="Explain your second supporting detail and its evidence..." class="assignment-input w-full p-2 border border-gray-600 rounded-md focus:ring-indigo-500 focus:border-indigo-500 bg-gray-700 text-white">

                    </div>

                </div>

            </div>

        </div>

 

        <div id="teacher-view-content" class="hidden">

            <h2 class="text-3xl font-bold text-gray-200 mb-6 border-b border-gray-600 pb-2">Teacher Dashboard: Student Submissions</h2>

            <div id="submissions-list" class="space-y-6">

                <p class="text-gray-500" id="loading-submissions">Loading student submissions...</p>

                </div>

        </div>

    </div>

 

    <div id="visualization-modal" class="modal">

        <div class="modal-content">

            <span class="close-btn" id="modal-close-btn">&times;</span>

            <h3 class="text-2xl font-bold mb-4 text-white" id="modal-title"></h3>

           

            <div id="canvas-wrapper" class="aspect-visualization relative rounded-xl mb-4 border-4 border-gray-600 shadow-2xl overflow-hidden">

                <img id="scene-image" class="absolute inset-0 w-full h-full object-cover opacity-30" src=https://placehold.co/900x500/1e293b/a5b4fc?text=Field+Trip+Destination+Context onerror="this.src='https://placehold.co/900x500/1e293b/a5b4fc?text=Field+Trip+Destination+Context'" alt="Context image for the ancient site">

                <canvas id="visualization-canvas" class="w-full h-full absolute inset-0"></canvas>

            </div>

           

            <p id="modal-narration" class="text-gray-300 text-lg leading-relaxed"></p>

            <p class="mt-4 text-md font-semibold text-purple-400" id="modal-interaction-prompt"></p>

        </div>

    </div>

 

    <script type="module">

        import { initializeApp } from https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js;

        import { getAuth, signInAnonymously, onAuthStateChanged } from https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js;

        // CRITICAL FIX: Removed signInWithCustomToken as it's not used in the public flow

        import { getFirestore, doc, setDoc, onSnapshot, collection, query, limit } from https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js;

        import { setLogLevel } from https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js;

       

        // Set log level for debugging

        setLogLevel('debug');

 

        // Global variables provided by the environment

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id-12345';

        // Use a safe default for firebase config if it's not defined

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {

            apiKey: "AIzaSyDEFAULTKEY", // Placeholder

            authDomain: "default-project.firebaseapp.com", // Placeholder

            projectId: "default-project-12345", // Placeholder

            storageBucket: "default-project-12345.appspot.com", // Placeholder

            messagingSenderId: "123456789012", // Placeholder

            appId: appId // Placeholder

        };

        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

 

        let db = null;

        let auth = null;

        let currentUserId = null;

        let isDbConnected = false;

        let animationFrameId = null; // To control the canvas animation loop

        let sessionStartTime = Date.now();

        let timerInterval = null;

        let completedHotspots = {}; // CRITICAL FIX: Initialize completedHotspots object

 

        // --- Core Application Data (for Localization and Structure) ---

        const APP_DATA = {

            "locale": "en",

            "ui": {

                "choose_language": { "en": "Language:", "es": "Idioma:", "fr": "Langue:" },

                "explore_mode": { "en": "Start Field Trip", "es": "Comenzar Viaje", "fr": "D√©marrer l'Excursion" },

                "teacher_view": { "en": "Teacher Dashboard", "es": "Panel del Profesor", "fr": "Tableau de Bord du Professeur" },

                "response_frame_title": { "en": "Assignment: Synthesize Adaptation Strategies", "es": "Tarea: Sintetizar Estrategias de Adaptaci√≥n", "fr": "Devoir: Synth√©tiser les Strat√©gies d'Adaptation" },

                "session_timer": { "en": "Time Remaining: {mm}:{ss}", "es": "Tiempo Restante: {mm}:{ss}", "fr": "Temps Restant: {mm}:{ss}" },

                "export_analytics": { "en": "Export Analytics", "es": "Exportar Anal√≠ticas", "fr": "Exporter l'Analyse" }, // Added export button text

                "loading_submissions": { "en": "Loading student submissions...", "es": "Cargando entregas de estudiantes...", "fr": "Chargement des soumissions..." } // Added submissions text

            },

            "hotspots": {

                "maya_river": {

                    "title": { "en": "Maya: Cenotes (Water & Trade Hub)", "es": "Maya: Cenotes (Agua y Comercio)", "fr": "Maya: C√©notes (Eau et Commerce)" },

                    "short": { "en": "Explore the natural water sources critical for survival and trade in the Yucat√°n.", "es": "Explore las fuentes de agua naturales cr√≠ticas para la supervivencia y el comercio en Yucat√°n.", "fr": "Explorez les sources d'eau naturelles cruciales pour la survie et le commerce au Yucat√°n." },

                    "scene_url": https://placehold.co/900x500/165511/F0F0F0?text=Maya+Yucatan+Jungle+Site,

                    "narration": {

                        "en": "The Mayan civilization thrived in the dense, tropical rainforest of the Yucat√°n Peninsula, where surface rivers were scarce. To adapt, they relied heavily on **Cenotes**, natural pits formed by the collapse of limestone bedrock, which exposed deep underground water. These Cenotes were not only essential for **drinking and agriculture**, but also served as vital **ceremonial sites and trade hubs**, connecting settlements across the region.",

                        "es": "La civilizaci√≥n Maya prosper√≥ en la densa selva tropical de la Pen√≠nsula de Yucat√°n, donde los r√≠os superficiales eran escasos. Para adaptarse, dependieron en gran medida de los **Cenotes**, pozos naturales formados por el colapso de la roca caliza que expon√≠an agua subterr√°nea profunda. Estos Cenotes no solo eran esenciales para **beber y la agricultura**, sino que tambi√©n serv√≠an como **sitios ceremoniales y centros comerciales** vitales, conectando asentamientos a lo largo de la regi√≥n.",

                        "fr": "La civilisation Maya a prosp√©r√© dans la dense for√™t tropicale de la p√©ninsule du Yucat√°n, o√π les rivi√®res de surface √©taient rares. Pour s'adapter, ils ont fortement d√©pendu des **C√©notes**, des fosses naturelles form√©es par l'effondrement du socle calcaire qui exposaient de profondes nappes d'eau souterraines. Ces C√©notes √©taient non seulement essentiels pour **la boisson et l'agriculture**, mais servaient √©galement de **sites c√©r√©moniels vitaux et de carrefours commerciaux**, reliant les colonies √† travers la r√©gion."

                    },

                    "interaction": { "type": "placeResource", "prompt": { "en": "Click to place a Trade Post and log your observation.", "es": "Haga clic para colocar un Puesto Comercial y registrar su observaci√≥n.", "fr": "Cliquez pour placer un Poste de Commerce et enregistrer votre observation." } },

                },

                "aztec_chinampa": {

                    "title": { "en": "Aztec: Chinampas (Floating Gardens)", "es": "Azteca: Chinampas (Jardines Flotantes)", "fr": "Azt√®que: Chinampas (Jardins Flottants)" },

                    "short": { "en": "Study the ingenious agricultural system that fed the massive capital of Tenochtitlan.", "es": "Estudie el ingenioso sistema agr√≠cola que aliment√≥ la enorme capital de Tenochtitlan.", "fr": "√âtudiez le syst√®me agricole ing√©nieux qui a nourri la capitale massive de Tenochtitlan." },

                    "scene_url": https://placehold.co/900x500/104351/F0F0F0?text=Aztec+Lake+Texcoco+Site,

                    "narration": {

                        "en": "The Aztec capital, Tenochtitlan, was built on a swampy island in Lake Texcoco. To overcome the lack of arable land and feed a growing population of hundreds of thousands, the Aztecs engineered **Chinampas**, or 'floating gardens'. These were highly fertile, rectangular plots of land created by layering mud, vegetation, and decaying matter onto the lakebed, providing **multiple harvests a year** and a stable food supply.",

                        "es": "La capital Azteca, Tenochtitlan, fue construida en una isla pantanosa en el Lago Texcoco. Para superar la falta de tierra cultivable y alimentar a una poblaci√≥n creciente de cientos de miles, los Aztecas ingeniaron **Chinampas**, o 'jardines flotantes'. Eran parcelas de tierra rectangulares y muy f√©rtiles creadas al superponer barro, vegetaci√≥n y materia en descomposici√≥n sobre el lecho del lago, proporcionando **m√∫ltiples cosechas al a√±o** y un suministro estable de alimentos.",

                        "fr": "La capitale Azt√®que, Tenochtitlan, a √©t√© construite sur une √Æle mar√©cageuse du lac Texcoco. Pour pallier le manque de terres arables et nourrir une population croissante de centaines de milliers d'habitants, les Azt√®ques ont con√ßu les **Chinampas**, ou 'jardines flottants'. Il s'agissait de parcelles de terre rectangulaires tr√®s fertiles, cr√©√©es en superposant de la boude, de la v√©g√©tation et de la mati√®re en d√©composition sur le fond du lac, permettant **plusieurs r√©coltes par an** et un approvisionnement alimentaire stable."

                    },

                    "interaction": { "type": "buildChinampa", "prompt": { "en": "Click to simulate building a Chinampa and log your observation.", "es": "Haga clic para simuler la construcci√≥n de una Chinampa et enregistrer votre observation.", "fr": "Cliquez pour simuler la construction d'une Chinampa et enregistrer votre observation." } },

                },

                "inca_terrace": {

                    "title": { "en": "Inca: Terrace Farming (Andes)", "es": "Inca: Cultivo en Terrazas (Andes)", "fr": "Inca: Agriculture en Terrasses (Andes)" },

                    "short": { "en": "View the engineering marvel of stable, high-altitude agriculture in the steep Andean mountains.", "es": "Vea la maravilla de ingenier√≠a de la agricultura estable a gran altura en las escarpadas monta√±as andinas.", "fr": "D√©couvrez la merveille d'ing√©nierie de l'agriculture stable en haute altitude dans les montagnes abruptes." },

                    "scene_url": https://placehold.co/900x500/5A5A5A/F0F0F0?text=Inca+Andes+Mountain+Site,

                    "narration": {

                        "en": "Living high in the **Andes Mountains**, the Inca faced the extreme challenge of steep slopes and variable climate. Their solution was **terrace farming**. By constructing massive stone walls to create flat, stepped fields, they not only stabilized the mountain slopes against **erosion** but also created **microclimates**. These tiered systems captured and conserved precious rainfall, allowing them to cultivate crops like potatoes and quinoa efficiently at altitudes up to 12,000 feet.",

                        "es": "Viviendo en lo alto de las **Monta√±as de los Andes**, los Incas enfrentaron el desaf√≠o extremo de las laderas empinadas y el clima variable. Su soluci√≥n fue la **agricultura en terrazas**. Al construir enormes muros de piedra para crear campos planos y escalonados, no solo estabilizaron las laderas contra la **erosi√≥n**, sino que tambi√©n crearon **microclimas**. Estos sistemas escalonados captaban y conservaban las preciosas lluvias, permiti√©ndoles cultivar eficientemente cosechas como la papa y la quinua a altitudes de hasta 12,000 pies.",

                        "fr": "Vivant en altitude dans les **montagnes des Andes**, les Incas ont √©t√© confront√©s au d√©fi extr√™me des pentes raides et d'un climat variable. Leur solution fut l'**agriculture en terrasses**. En construisant des murs de pierre massifs pour cr√©er des champs plats et √©tag√©s, ils ont non seulement stabilis√© les pentes contre l'**√©rosion**, mais ont √©galement cr√©√© des **microclimats**. Ces syst√®mes √©tag√©s captaient et conservaient les pr√©cieuses eaux de pluie, leur permettant de cultiver efficacement des cultures comme la pomme de terre et le quinoa √† des altitudes allant jusqu'√† 12 000 pieds."

                    },

                    "interaction": { "type": "buildTerrace", "prompt": { "en": "Click to simulate building a Terrace and log your observation.", "es": "Haga clic para simular la construcci√≥n de una Terraza y registrar su observaci√≥n.", "fr": "Cliquez pour simuler la construction d'une Terraza y enregistrer su observation." } },

                }

            },

            "sentence_frames": {

                "central_idea": {

                    "en": "The primary way ancient civilizations adapted to their environments was by __________.",

                    "es": "La forma principal en que las civilizaciones antiguas se adaptaron a sus entornos fue mediante __________.",

                    "fr": "La principale fa√ßon dont les civilisations antiques se sont adapt√©es √† leurs environnements fut de __________."

                },

                "detail_prompt": {

                    "en": "The first key detail that supports this idea is the use of ______ by the ______ civilization, which addressed the challenge of ______.",

                    "es": "El primer detalle clave que apoya esta idea es el uso de ______ por la civilizaci√≥n de los ______, que abord√≥ el desaf√≠o de ______.",

                    "fr": "Le premier d√©tail cl√© qui soutient cette id√©e est l'utilisation de ______ par la civilisation ______, qui a relev√© le d√©fi de ______."

                }

            }

        };

 

        // --- Firebase Initialization and Authentication ---

 

        async function initializeFirebase() {

            const dbStatusEl = document.getElementById('db-status');

            dbStatusEl.textContent = 'Connecting...';

            dbStatusEl.className = 'px-3 py-1 text-xs font-medium rounded-full bg-gray-600 text-gray-200';

           

            if (!firebaseConfig || !firebaseConfig.apiKey.startsWith('AIzaSy')) { // Basic check for placeholder key

                dbStatusEl.textContent = 'DB Error: Placeholder Config';

                dbStatusEl.className = 'px-3 py-1 text-xs font-medium rounded-full bg-red-800 text-red-200';

                console.error("Firebase config is missing or is using a placeholder. Code will run, but persistence will not work.");

                // Allow the app to run without persistence for demonstration

                currentUserId = 'demo-user-' + Math.random().toString(36).substring(2, 8);

                isDbConnected = false;

                dbStatusEl.textContent = `Demo User: ${currentUserId}`;

                dbStatusEl.className = 'px-3 py-1 text-xs font-medium rounded-full bg-yellow-700 text-yellow-100';

                loadWork(true); // Load with fallback only

                return;

            }

 

            try {

                const app = initializeApp(firebaseConfig);

                db = getFirestore(app);

                auth = getAuth(app);

 

                // Removed signInWithCustomToken since it's an internal-only flow and not provided

                await signInAnonymously(auth);

 

                await new Promise(resolve => onAuthStateChanged(auth, user => {

                    if (user) {

                        currentUserId = user.uid;

                    } else {

                        // Fallback if sign-in fails

                        currentUserId = crypto.randomUUID();

                    }

                    isDbConnected = true;

                    dbStatusEl.textContent = `User ID: ${currentUserId.substring(0, 8)}...`;

                    dbStatusEl.className = 'px-3 py-1 text-xs font-medium rounded-full bg-green-700 text-green-100';

                    resolve();

                }));

 

                loadWork(); // Load with persistence

 

            } catch (error) {

                dbStatusEl.textContent = 'DB Error: Auth Failed';

                dbStatusEl.className = 'px-3 py-1 text-xs font-medium rounded-full bg-red-800 text-red-200';

                console.error("Firebase initialization or authentication failed:", error);

                // Fallback to local user

                currentUserId = 'demo-user-fallback';

                isDbConnected = false;

            }

        }

       

        // --- Firestore Data Paths and Functions ---

       

        function getStudentWorkDocRef() {

            if (!db || !currentUserId) return null;

            return doc(db, 'artifacts', appId, 'users', currentUserId, 'responseFrames', 'mainAssignment');

        }

 

        function getTeacherCollectionRef() {

            if (!db) return null;

            // CRITICAL FIX: The path to a teacher collection must include a final document reference for setDoc

            // The teacher list should listen to the 'studentResponses' collection, but writing should be to a doc.

            return collection(db, 'artifacts', appId, 'public', 'data', 'studentResponses');

        }

 

        /**

         * Saves work to Firestore (and potentially a public teacher collection).

         * @param {string} field - The specific field to update (e.g., 'centralIdea').

         * @param {string} value - The value for the field.

         * @param {Object} completedHotspotsData - The complete object of completed hotspots.

         */

        async function saveWork(field, value, completedHotspotsData) {

            const saveStatusEl = document.getElementById('save-status');

            if (!isDbConnected || !currentUserId) {

                // If not connected, save locally for now (not implemented, but good practice)

                saveStatusEl.textContent = 'Demo Mode: Data Not Saved to Cloud';

                return;

            }

 

            const docRef = getStudentWorkDocRef();

            const teacherDocRef = doc(getTeacherCollectionRef(), currentUserId); // Doc reference for the teacher collection

           

            saveStatusEl.textContent = 'Saving...';

 

            const updateData = {};

            if (field) updateData[field] = value;

            if (completedHotspotsData) updateData.completedHotspots = completedHotspotsData;

           

            try {

                const timestamp = new Date().toISOString();

                updateData.lastUpdated = timestamp;

                updateData.userId = currentUserId;

 

                await setDoc(docRef, updateData, { merge: true });

                await setDoc(teacherDocRef, updateData, { merge: true }); // Save to public teacher view

 

                saveStatusEl.textContent = `Saved automatically at ${new Date().toLocaleTimeString()}`;

            } catch (error) {

                saveStatusEl.textContent = 'Save Failed!';

                console.error("Error saving work to Firestore:", error);

            }

        }

 

        /**

         * Loads student work from Firestore and sets up a real-time listener.

         * @param {boolean} isDemo - Flag to indicate if running in demo mode (no listener)

         */

        function loadWork(isDemo = false) {

            if (!isDbConnected || !currentUserId || isDemo) return;

 

            const docRef = getStudentWorkDocRef();

           

            onSnapshot(docRef, (docSnap) => {

                if (docSnap.exists()) {

                    const data = docSnap.data();

                   

                    if (data.centralIdea) document.getElementById('central-idea-input').value = data.centralIdea;

                    if (data.detail1) document.getElementById('detail-1-input').value = data.detail1;

                    if (data.detail2) document.getElementById('detail-2-input').value = data.detail2;

                   

                    if (data.completedHotspots) {

                        completedHotspots = data.completedHotspots; // CRITICAL FIX: Update global object

                        Object.keys(completedHotspots).forEach(hotspotId => {

                            if (completedHotspots[hotspotId] === true) {

                                const cardId = hotspotId.replace(/_/g, '-') + '-card';

                                const card = document.getElementById(cardId);

                               

                                if (card) {

                                    card.classList.add('completed');

                                    const statusElementId = hotspotId.replace(/_/g, '-') + '-status';

                                    const statusElement = document.getElementById(statusElementId);

                                    if(statusElement) statusElement.classList.remove('hidden');

                                }

                            }

                        });

                    }

                }

            }, (error) => {

                console.error("Error loading work in real-time:", error);

            });

        }

 

        /**

         * Loads submissions for the teacher view.

         */

        function loadTeacherSubmissions() {

            const submissionsListEl = document.getElementById('submissions-list');

            submissionsListEl.innerHTML = '';

            submissionsListEl.innerHTML = `<p class="text-gray-500" id="loading-submissions">${getLocalizedText('ui.loading_submissions')}</p>`;

 

            if (!isDbConnected) {

                submissionsListEl.innerHTML = `<p class="text-red-500">Cannot load teacher data: Database connection failed.</p>`;

                return;

            }

 

            const colRef = getTeacherCollectionRef();

            // Query to listen to the top few submissions

            const q = query(colRef, limit(10));

 

            onSnapshot(q, (snapshot) => {

                const submissions = [];

                snapshot.forEach(doc => {

                    const data = doc.data();

                    submissions.push(data);

                });

               

                submissionsListEl.innerHTML = ''; // Clear loading message

 

                if (submissions.length === 0) {

                    submissionsListEl.innerHTML = `<p class="text-gray-500">No submissions found yet.</p>`;

                    return;

                }

 

                submissions.forEach(sub => {

                    const hotspotCount = sub.completedHotspots ? Object.values(sub.completedHotspots).filter(v => v).length : 0;

                    submissionsListEl.innerHTML += `

                        <div class="bg-gray-800 p-4 rounded-lg shadow-md border-l-4 border-blue-500">

                            <p class="font-bold text-white mb-1">Student: ${sub.userId ? sub.userId.substring(0, 8) + '...' : 'N/A'}</p>

                            <p class="text-sm text-gray-400">Last Updated: ${new Date(sub.lastUpdated).toLocaleTimeString()}</p>

                            <p class="text-sm text-green-400 mt-2">Hotspots Completed: ${hotspotCount}/3</p>

                            <p class="mt-2 text-gray-300">Central Idea: ${sub.centralIdea || 'Not started'}</p>

                            <p class="text-gray-300">Detail 1: ${sub.detail1 || 'Not started'}</p>

                        </div>

                    `;

                });

            }, (error) => {

                console.error("Error loading teacher submissions:", error);

                submissionsListEl.innerHTML = `<p class="text-red-500">Error loading data: ${error.message}</p>`;

            });

        }

 

        // --- UI/Localization & Event Handlers ---

 

        let currentLocale = APP_DATA.locale;

        let audioCtx = null;

        let ttsAudio = null;

 

        function initAudio() {

            if (!audioCtx) {

                try {

                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();

                } catch (e) {

                    console.error("Audio Context initialization failed:", e);

                }

            }

            if (audioCtx && audioCtx.state === 'suspended') {

                audioCtx.resume().catch(e => console.error("Failed to resume AudioContext:", e));

            }

        }

       

        // CRITICAL FIX: The TTS functionality is missing. A functional mock is added.

        function playVoiceover(hotspotId) {

            initAudio();

            const narrationText = getLocalizedText(`hotspots.${hotspotId}.narration`);

            console.log(`Simulating voiceover for: ${narrationText}`);

           

            // Use browser's built-in Web Speech API as a mock for the voiceover

            if ('speechSynthesis' in window) {

                if (ttsAudio) window.speechSynthesis.cancel();

                ttsAudio = new SpeechSynthesisUtterance(narrationText);

                ttsAudio.lang = currentLocale;

                window.speechSynthesis.speak(ttsAudio);

            } else {

                alert(`[TTS] Narration for ${hotspotId}: ${narrationText}`);

            }

        }

 

        function getLocalizedText(path, locale = currentLocale) {

            const parts = path.split('.');

            let data = APP_DATA;

            for (const part of parts) {

                if (data && data.hasOwnProperty(part)) {

                    data = data[part];

                } else {

                    return `[Missing Text: ${path}]`;

                }

            }

            if (typeof data === 'object' && data !== null && data.hasOwnProperty(locale)) {

                return data[locale];

            }

            return data;

        }

 

        function updateTimerDisplay() {

            const timeElapsed = Date.now() - sessionStartTime;

            const remainingTimeMs = Math.max(0, (1800 * 1000) - timeElapsed); // 30 minutes limit

            const totalSeconds = Math.floor(remainingTimeMs / 1000);

            const minutes = String(Math.floor(totalSeconds / 60)).padStart(2, '0');

            const seconds = String(totalSeconds % 60).padStart(2, '0');

           

            const timerEl = document.getElementById('session-timer');

            const timerText = getLocalizedText('ui.session_timer');

            timerEl.textContent = timerText.replace('{mm}', minutes).replace('{ss}', seconds);

 

            if (remainingTimeMs === 0 && timerInterval) {

                clearInterval(timerInterval);

                timerEl.textContent = "TIME EXPIRED";

            }

        }

       

        function render() {

            document.getElementById('choose-language').textContent = getLocalizedText('ui.choose_language');

            document.getElementById('explore-mode-btn').textContent = getLocalizedText('ui.explore_mode');

            document.getElementById('teacher-view-btn').textContent = getLocalizedText('ui.teacher_view');

            document.getElementById('response-frame-title').textContent = getLocalizedText('ui.response_frame_title');

            document.getElementById('export-analytics-btn').textContent = getLocalizedText('ui.export_analytics');

 

            Object.entries(APP_DATA.hotspots).forEach(([id, data]) => {

                const elementIdBase = id.replace(/_/g, '-');

               

                const titleEl = document.getElementById(`${elementIdBase}-title`);

                const shortEl = document.getElementById(`${elementIdBase}-short`);

                const promptEl = document.getElementById(`${elementIdBase}-prompt`);

 

                if (titleEl) titleEl.textContent = data.title[currentLocale];

                if (shortEl) shortEl.textContent = data.short[currentLocale];

                if (promptEl) promptEl.textContent = data.interaction.prompt[currentLocale];

            });

 

            document.getElementById('central-idea-frame').textContent = getLocalizedText('sentence_frames.central_idea', currentLocale);

            const detailPrompt = getLocalizedText('sentence_frames.detail_prompt', currentLocale);

            document.getElementById('detail-prompt-1').textContent = detailPrompt.replace(/______/g, '_________');

            document.getElementById('detail-prompt-2').textContent = detailPrompt.replace(/______/g, '_________');

        }

 

        // --- Canvas Visualization Logic ---

 

        let offset = 0; // Global animation offset

       

        /** Draws the visualization based on the hotspot ID. */

        function drawVisualization(hotspotId, canvas, ctx) {

            if (!ctx) return;

 

            // Clear Canvas with a semi-transparent black overlay for context depth

            ctx.clearRect(0, 0, canvas.width, canvas.height); // CRITICAL FIX: Clear the canvas properly

            ctx.fillStyle = 'rgba(0, 0, 0, 0.4)';

            ctx.fillRect(0, 0, canvas.width, canvas.height);

 

            const w = canvas.width;

            const h = canvas.height;

            offset += 0.02; // Slower animation

 

            switch (hotspotId) {

                case 'maya_river':

                    // Simulate water flow/ripple (Cenote)

                    ctx.beginPath();

                    ctx.fillStyle = 'rgba(66, 153, 225, 0.6)'; // Blue water

                    ctx.arc(w / 2, h / 2, Math.min(w, h) / 3, 0, 2 * Math.PI);

                    ctx.fill();

 

                    // Ripple effect

                    for (let i = 0; i < 4; i++) {

                        const radius = Math.min(w, h) / 4 + Math.sin(offset + i * 1.5) * 20;

                        ctx.beginPath();

                        ctx.strokeStyle = 'rgba(129, 230, 217, 0.8)'; // Cyan ripple

                        ctx.lineWidth = 2;

                        ctx.arc(w / 2, h / 2, radius, 0, 2 * Math.PI);

                        ctx.stroke();

                    }

                    break;

                case 'aztec_chinampa':

                    // Simulate Chinampas (Rectangular plots)

                    for (let i = 0; i < 5; i++) {

                        const x = w * (0.1 + i * 0.18);

                        const y = h * 0.3 + Math.sin(offset + i) * 30;

                        const plotWidth = w * 0.15;

                        const plotHeight = h * 0.4;

 

                        // Water (Blue)

                        ctx.fillStyle = 'rgba(49, 130, 206, 0.3)';

                        ctx.fillRect(0, 0, w, h);

 

                        // Land plot (Green/Brown)

                        ctx.fillStyle = 'rgba(56, 161, 105, 0.9)';

                        ctx.fillRect(x, y, plotWidth, plotHeight);

 

                        // Animated crops (Dots)

                        for (let j = 0; j < 5; j++) {

                            ctx.beginPath();

                            ctx.fillStyle = 'rgba(255, 255, 0, 0.8)';

                            ctx.arc(x + plotWidth * 0.2 + j * (plotWidth * 0.15), y + plotHeight * 0.8 + Math.sin(offset * 5 + i * j) * 5, 3, 0, 2 * Math.PI);

                            ctx.fill();

                        }

                    }

                    break;

                case 'inca_terrace':

                    // Simulate Terrace Farming (Steps)

                    for (let i = 0; i < 6; i++) {

                        const stepHeight = h / 6;

                        const y = h - (i + 1) * stepHeight;

                       

                        // Stone wall (Gray)

                        ctx.fillStyle = 'rgba(113, 128, 150, 0.8)';

                        ctx.fillRect(0, y, w, 10);

 

                        // Soil/Field (Brown/Green)

                        ctx.fillStyle = 'rgba(107, 70, 50, 0.7)';

                        ctx.fillRect(0, y - stepHeight + 10, w, stepHeight - 10);

                       

                        // Animated plants (Lines)

                        for(let j = 0; j < 20; j++) {

                             ctx.beginPath();

                             ctx.strokeStyle = 'rgba(198, 246, 213, 0.9)';

                             ctx.lineWidth = 1;

                             const plantX = w / 20 * j + Math.sin(offset + i + j) * 5;

                             ctx.moveTo(plantX, y - stepHeight + 15);

                             ctx.lineTo(plantX, y - 20 - (i*5));

                             ctx.stroke();

                        }

                    }

                    break;

                default:

                    ctx.fillStyle = '#FF0000';

                    ctx.font = '30px Arial';

                    ctx.fillText('Select a Hotspot', w / 2 - 100, h / 2);

            }

 

            // Loop the animation

            animationFrameId = requestAnimationFrame(() => drawVisualization(hotspotId, canvas, ctx));

        }

 

 

        // --- Main Initialization and Listeners ---

 

        document.addEventListener('DOMContentLoaded', () => {

            initializeFirebase();

            render();

            timerInterval = setInterval(updateTimerDisplay, 1000); // Start timer

 

            // Language Selector

            document.getElementById('language-selector').addEventListener('change', (e) => {

                currentLocale = e.target.value;

                APP_DATA.locale = currentLocale;

                render();

            });

 

            // Input Debounce for auto-saving

            let saveTimeout;

            document.querySelectorAll('.assignment-input').forEach(input => {

                input.addEventListener('input', (e) => {

                    clearTimeout(saveTimeout);

                    const field = e.target.dataset.field;

                    const value = e.target.value;

                    saveTimeout = setTimeout(() => {

                        saveWork(field, value, completedHotspots);

                    }, 1000); // Wait 1 second after last input

                });

            });

 

            // Hotspot Card Click to Open Modal

            document.querySelectorAll('.hotspot-card').forEach(card => {

                card.addEventListener('click', (e) => {

                    // Prevent opening modal if clicking the voiceover button

                    if (e.target.closest('.play-voiceover-btn')) return;

 

                    const hotspotId = card.dataset.hotspotId;

                    const data = APP_DATA.hotspots[hotspotId];

                    const modal = document.getElementById('visualization-modal');

                    const canvas = document.getElementById('visualization-canvas');

                    const ctx = canvas.getContext('2d');

 

                    if (!data) return;

 

                    // Set Modal Content

                    document.getElementById('modal-title').textContent = data.title[currentLocale];

                    document.getElementById('modal-narration').innerHTML = data.narration[currentLocale]; // Use innerHTML to allow **bolding**

                    document.getElementById('modal-interaction-prompt').textContent = data.interaction.prompt[currentLocale];

                    document.getElementById('scene-image').src = data.scene_url; // Set context image

 

                    // Show Modal

                    modal.style.display = 'flex'; // CRITICAL FIX: Set to 'flex' to make it visible and centered

 

                    // Stop any existing animation and start new one

                    if (animationFrameId) cancelAnimationFrame(animationFrameId);

                   

                    // CRITICAL FIX: Set canvas size based on wrapper's rendered size

                    const wrapper = document.getElementById('canvas-wrapper');

                    canvas.width = wrapper.clientWidth;

                    canvas.height = wrapper.clientHeight;

 

                    drawVisualization(hotspotId, canvas, ctx);

                    initAudio(); // Initialize audio context on first user interaction

                });

            });

 

            // Modal Interaction (Canvas Click to Complete Hotspot)

            document.getElementById('visualization-canvas').addEventListener('click', () => {

                const modal = document.getElementById('visualization-modal');

                const hotspotTitleEl = document.getElementById('modal-title');

               

                // Extract hotspotId from the title (e.g., "Maya: Cenotes (..)" -> "maya_river")

                const currentTitle = hotspotTitleEl.textContent;

                const entry = Object.entries(APP_DATA.hotspots).find(([id, data]) => data.title[currentLocale] === currentTitle);

               

                if (entry) {

                    const hotspotId = entry[0];

                    completedHotspots[hotspotId] = true;

                   

                    // Update UI and save progress

                    const cardId = hotspotId.replace(/_/g, '-') + '-card';

                    const card = document.getElementById(cardId);

                    if(card) {

                        card.classList.add('completed');

                        document.getElementById(hotspotId.replace(/_/g, '-') + '-status').classList.remove('hidden');

                    }

                   

                    saveWork(null, null, completedHotspots); // Save the updated completedHotspots object

 

                    // Close the modal

                    modal.style.display = 'none';

                    if (animationFrameId) cancelAnimationFrame(animationFrameId);

                }

            });

 

            // Close Modal Button

            document.getElementById('modal-close-btn').addEventListener('click', () => {

                document.getElementById('visualization-modal').style.display = 'none';

                if (animationFrameId) cancelAnimationFrame(animationFrameId);

                if (ttsAudio) window.speechSynthesis.cancel();

            });

 

            // Close Modal on outside click (window)

            window.addEventListener('click', (event) => {

                const modal = document.getElementById('visualization-modal');

                if (event.target === modal) {

                    modal.style.display = 'none';

                    if (animationFrameId) cancelAnimationFrame(animationFrameId);

                    if (ttsAudio) window.speechSynthesis.cancel();

                }

            });

 

            // Voiceover Button

            document.querySelectorAll('.play-voiceover-btn').forEach(btn => {

                btn.addEventListener('click', (e) => {

                    const hotspotId = e.currentTarget.dataset.hotspot;

                    playVoiceover(hotspotId);

                });

            });

 

            // Teacher/Student View Toggle

            const exploreView = document.getElementById('explore-mode-view');

            const teacherView = document.getElementById('teacher-view-content');

            const exploreBtn = document.getElementById('explore-mode-btn');

            const teacherBtn = document.getElementById('teacher-view-btn');

 

            exploreBtn.addEventListener('click', () => {

                exploreView.classList.remove('hidden');

                teacherView.classList.add('hidden');

                exploreBtn.classList.replace('bg-gray-600', 'bg-blue-600');

                teacherBtn.classList.replace('bg-blue-600', 'bg-gray-600');

            });

 

            teacherBtn.addEventListener('click', () => {

                exploreView.classList.add('hidden');

                teacherView.classList.remove('hidden');

                teacherBtn.classList.replace('bg-gray-600', 'bg-blue-600');

                exploreBtn.classList.replace('bg-blue-600', 'bg-gray-600');

                loadTeacherSubmissions(); // Load data when switching to teacher view

            });

 

            // Window resize handler to maintain aspect ratio on canvas

            window.addEventListener('resize', () => {

                const modal = document.getElementById('visualization-modal');

                if (modal.style.display === 'flex') {

                    const canvas = document.getElementById('visualization-canvas');

                    const wrapper = document.getElementById('canvas-wrapper');

                    canvas.width = wrapper.clientWidth;

                    canvas.height = wrapper.clientHeight;

                    // Restart animation to redraw with new dimensions

                    if (animationFrameId) cancelAnimationFrame(animationFrameId);

                    // This relies on knowing the currently open hotspot, which is tricky.

                    // A simple redraw without a full loop restart will suffice for a static change.

                }

            });

           

            // Initial call to ensure Explore mode is visible on load

            exploreBtn.click();

        });

    </script>

</body>

</html> <!DOCTYPE html>

<html lang="en">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Ancient Civilizations Virtual Field Trip</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <style>

        /* Custom styles for aesthetic font and a richer, darker theme */

        body {

            font-family: 'Inter', sans-serif;

            background-color: #1a202c; /* Dark background for immersive feel */

            color: #e2e8f0;

        }

        header {

            background-color: #2d3748; /* Darker grey header */

        }

        h1, h2, h3 {

            color: #ffffff;

        }

        .hotspot-card {

            transition: all 0.3s ease;

            cursor: pointer;

            min-height: 250px;

            background-color: #2d3748; /* Card background */

            border-color: #4a5568;

        }

        .hotspot-card:hover {

            transform: translateY(-4px);

            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);

            border-color: #4299e1; /* Blue hover border */

        }

       

        /* Hotspot Completion State */

        .completed {

            border-color: #38a169 !important; /* Green 600 */

            background-color: #2f4744 !important; /* Darker green background */

        }

 

        /* Modal Styles - The Field Trip Viewer */

        .modal {

            display: none;

            position: fixed;

            z-index: 1000;

            left: 0;

            top: 0;

            width: 100%;

            height: 100%;

            overflow: auto;

            background-color: rgba(0, 0, 0, 0.95);

            /* Added flex properties to center the modal content */

            display: flex; /* CRITICAL FIX: Changed from 'none' to 'flex' by JS, but 'flex' is needed when visible */

            justify-content: center;

            align-items: center;

        }

        .modal-content {

            background-color: #2d3748;

            margin: auto;

            padding: 24px;

            border-radius: 16px;

            width: 95%;

            max-width: 1000px;

            position: relative;

            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8);

            border: 2px solid #4a5568;

        }

        .close-btn {

            color: #a0aec0;

            position: absolute;

            top: 15px;

            right: 25px;

            font-size: 36px;

            font-weight: bold;

            line-height: 1;

        }

        .close-btn:hover,

        .close-btn:focus {

            color: #ffffff;

            text-decoration: none;

            cursor: pointer;

        }

 

        /* Canvas container for 16:9 aspect ratio */

        .aspect-visualization {

            aspect-ratio: 16 / 9;

        }

    </style>

</head>

<body class="p-4 md:p-8">

 

    <div id="app" class="max-w-7xl mx-auto">

       

        <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 p-4 rounded-xl shadow-2xl">

            <h1 class="text-3xl font-bold text-white mb-4 sm:mb-0">Ancient Civilizations Virtual Field Trip</h1>

 

            <div class="flex flex-col md:flex-row items-start md:items-center space-y-4 md:space-y-0 md:space-x-8">

                <div class="flex items-center space-x-4">

                    <div id="db-status" class="px-3 py-1 text-xs font-medium rounded-full"></div>

                   

                    <p id="choose-language" class="text-gray-400"></p>

                    <select id="language-selector" class="p-2 border border-gray-600 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-700 text-white">

                        <option value="en">English (en)</option>

                        <option value="es">Espa√±ol (es)</option>

                        <option value="fr">Fran√ßais (fr)</option>

                    </select>

                </div>

            </div>

        </header>

 

        <div class="flex flex-wrap gap-4 mb-8">

            <button id="explore-mode-btn" class="flex-1 min-w-[150px] px-4 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-150"></button>

            <button id="teacher-view-btn" class="flex-1 min-w-[150px] px-4 py-3 bg-gray-600 text-white font-semibold rounded-lg shadow-md hover:bg-gray-700 transition duration-150"></button>

            <div id="session-timer" class="flex-1 min-w-[150px] flex items-center justify-center bg-yellow-900 text-yellow-300 font-bold p-3 rounded-lg shadow-inner"></div>

            <button id="export-analytics-btn" class="flex-1 min-w-[150px] px-4 py-3 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition duration-150">Export Analytics</button>

        </div>

       

        <div id="explore-mode-view">

            <h2 class="text-2xl font-semibold text-gray-200 mb-6">Field Trip Destinations: Engineering Adaptation</h2>

            <div id="hotspots-container" class="grid md:grid-cols-3 gap-6 mb-12">

               

                <div id="maya-river-card" data-hotspot-id="maya_river" class="hotspot-card interaction-card p-6 rounded-xl shadow-lg border-t-4 border-gray-600">

                    <div class="flex justify-between items-start mb-3">

                        <h3 class="text-xl font-bold text-white" id="maya-river-title"></h3>

                        <button class="play-voiceover-btn text-2xl text-purple-400 hover:text-purple-300 transition duration-150" data-hotspot="maya_river">üéôÔ∏è</button>

                    </div>

                    <p class="text-sm text-gray-400 mb-4" id="maya-river-short"></p>

                    <div class="space-y-3">

                        <div class="p-3 bg-green-900 rounded-lg text-sm interaction-prompt text-green-200" id="maya-river-prompt"></div>

                    </div>

                    <div class="mt-4 text-sm font-semibold text-green-400 hidden" id="maya-river-status">FIELD TRIP COMPLETED</div>

                </div>

 

                <div id="aztec-chinampa-card" data-hotspot-id="aztec_chinampa" class="hotspot-card interaction-card p-6 rounded-xl shadow-lg border-t-4 border-gray-600">

                    <div class="flex justify-between items-start mb-3">

                        <h3 class="text-xl font-bold text-white" id="aztec-chinampa-title"></h3>

                        <button class="play-voiceover-btn text-2xl text-purple-400 hover:text-purple-300 transition duration-150" data-hotspot="aztec_chinampa">üéôÔ∏è</button>

                    </div>

                    <p class="text-sm text-gray-400 mb-4" id="aztec-chinampa-short"></p>

                    <div class="space-y-3">

                        <div class="p-3 bg-red-900 rounded-lg text-sm interaction-prompt text-red-200" id="aztec-chinampa-prompt"></div>

                    </div>

                    <div class="mt-4 text-sm font-semibold text-green-400 hidden" id="aztec-chinampa-status">FIELD TRIP COMPLETED</div>

                </div>

 

                <div id="inca-terrace-card" data-hotspot-id="inca_terrace" class="hotspot-card interaction-card p-6 rounded-xl shadow-lg border-t-4 border-gray-600">

                    <div class="flex justify-between items-start mb-3">

                        <h3 class="text-xl font-bold text-white" id="inca-terrace-title"></h3>

                        <button class="play-voiceover-btn text-2xl text-purple-400 hover:text-purple-300 transition duration-150" data-hotspot="inca_terrace">üéôÔ∏è</button>

                    </div>

                    <p class="text-sm text-gray-400 mb-4" id="inca-terrace-short"></p>

                    <div class="space-y-3">

                        <div class="p-3 bg-blue-900 rounded-lg text-sm interaction-prompt text-blue-200" id="inca-terrace-prompt"></div>

                    </div>

                    <div class="mt-4 text-sm font-semibold text-green-400 hidden" id="inca-terrace-status">FIELD TRIP COMPLETED</div>

                </div>

            </div>

 

            <div class="bg-indigo-900 p-6 rounded-xl shadow-inner border-t-2 border-indigo-700">

                <h2 class="text-xl font-bold text-indigo-200 mb-4" id="response-frame-title"></h2>

               

                <p id="save-status" class="text-sm text-gray-400 mb-4">Saving status: Waiting for input...</p>

 

                <div class="space-y-4">

                    <div class="bg-gray-800 p-4 rounded-lg shadow-md">

                        <p class="text-gray-300 mb-2 font-semibold" id="central-idea-frame"></p>

                        <input type="text" data-field="centralIdea" id="central-idea-input" placeholder="Start your summary here..." class="assignment-input w-full p-2 border border-gray-600 rounded-md focus:ring-indigo-500 focus:border-indigo-500 bg-gray-700 text-white">

                    </div>

                   

                    <div class="bg-gray-800 p-4 rounded-lg shadow-md">

                        <p class="text-gray-300 mb-2 font-semibold" id="detail-prompt-1"></p>

                        <input type="text" data-field="detail1" id="detail-1-input" placeholder="Explain your first supporting detail and its evidence..." class="assignment-input w-full p-2 border border-gray-600 rounded-md focus:ring-indigo-500 focus:border-indigo-500 bg-gray-700 text-white">

                    </div>

 

                    <div class="bg-gray-800 p-4 rounded-lg shadow-md">

                        <p class="text-gray-300 mb-2 font-semibold" id="detail-prompt-2"></p>

                        <input type="text" data-field="detail2" id="detail-2-input" placeholder="Explain your second supporting detail and its evidence..." class="assignment-input w-full p-2 border border-gray-600 rounded-md focus:ring-indigo-500 focus:border-indigo-500 bg-gray-700 text-white">

                    </div>

                </div>

            </div>

        </div>

 

        <div id="teacher-view-content" class="hidden">

            <h2 class="text-3xl font-bold text-gray-200 mb-6 border-b border-gray-600 pb-2">Teacher Dashboard: Student Submissions</h2>

            <div id="submissions-list" class="space-y-6">

                <p class="text-gray-500" id="loading-submissions">Loading student submissions...</p>

                </div>

        </div>

    </div>

 

    <div id="visualization-modal" class="modal">

        <div class="modal-content">

            <span class="close-btn" id="modal-close-btn">&times;</span>

            <h3 class="text-2xl font-bold mb-4 text-white" id="modal-title"></h3>

           

            <div id="canvas-wrapper" class="aspect-visualization relative rounded-xl mb-4 border-4 border-gray-600 shadow-2xl overflow-hidden">

                <img id="scene-image" class="absolute inset-0 w-full h-full object-cover opacity-30" src="https://placehold.co/900x500/1e293b/a5b4fc?text=Field+Trip+Destination+Context" onerror="this.src='https://placehold.co/900x500/1e293b/a5b4fc?text=Field+Trip+Destination+Context'" alt="Context image for the ancient site">

                <canvas id="visualization-canvas" class="w-full h-full absolute inset-0"></canvas>

            </div>

           

            <p id="modal-narration" class="text-gray-300 text-lg leading-relaxed"></p>

            <p class="mt-4 text-md font-semibold text-purple-400" id="modal-interaction-prompt"></p>

        </div>

    </div>

 

    <script type="module">

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // CRITICAL FIX: Removed signInWithCustomToken as it's not used in the public flow

        import { getFirestore, doc, setDoc, onSnapshot, collection, query, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

       

        // Set log level for debugging

        setLogLevel('debug');

 

        // Global variables provided by the environment

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id-12345';

        // Use a safe default for firebase config if it's not defined

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {

            apiKey: "AIzaSyDEFAULTKEY", // Placeholder

            authDomain: "default-project.firebaseapp.com", // Placeholder

            projectId: "default-project-12345", // Placeholder

            storageBucket: "default-project-12345.appspot.com", // Placeholder

            messagingSenderId: "123456789012", // Placeholder

            appId: appId // Placeholder

        };

        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

 

        let db = null;

        let auth = null;

        let currentUserId = null;

        let isDbConnected = false;

        let animationFrameId = null; // To control the canvas animation loop

        let sessionStartTime = Date.now();

        let timerInterval = null;

        let completedHotspots = {}; // CRITICAL FIX: Initialize completedHotspots object

 

        // --- Core Application Data (for Localization and Structure) ---

        const APP_DATA = {

            "locale": "en",

            "ui": {

                "choose_language": { "en": "Language:", "es": "Idioma:", "fr": "Langue:" },

                "explore_mode": { "en": "Start Field Trip", "es": "Comenzar Viaje", "fr": "D√©marrer l'Excursion" },

                "teacher_view": { "en": "Teacher Dashboard", "es": "Panel del Profesor", "fr": "Tableau de Bord du Professeur" },

                "response_frame_title": { "en": "Assignment: Synthesize Adaptation Strategies", "es": "Tarea: Sintetizar Estrategias de Adaptaci√≥n", "fr": "Devoir: Synth√©tiser les Strat√©gies d'Adaptation" },

                "session_timer": { "en": "Time Remaining: {mm}:{ss}", "es": "Tiempo Restante: {mm}:{ss}", "fr": "Temps Restant: {mm}:{ss}" },

                "export_analytics": { "en": "Export Analytics", "es": "Exportar Anal√≠ticas", "fr": "Exporter l'Analyse" }, // Added export button text

                "loading_submissions": { "en": "Loading student submissions...", "es": "Cargando entregas de estudiantes...", "fr": "Chargement des soumissions..." } // Added submissions text

            },

            "hotspots": {

                "maya_river": {

                    "title": { "en": "Maya: Cenotes (Water & Trade Hub)", "es": "Maya: Cenotes (Agua y Comercio)", "fr": "Maya: C√©notes (Eau et Commerce)" },

                    "short": { "en": "Explore the natural water sources critical for survival and trade in the Yucat√°n.", "es": "Explore las fuentes de agua naturales cr√≠ticas para la supervivencia y el comercio en Yucat√°n.", "fr": "Explorez les sources d'eau naturelles cruciales pour la survie et le commerce au Yucat√°n." },

                    "scene_url": "https://placehold.co/900x500/165511/F0F0F0?text=Maya+Yucatan+Jungle+Site",

                    "narration": {

                        "en": "The Mayan civilization thrived in the dense, tropical rainforest of the Yucat√°n Peninsula, where surface rivers were scarce. To adapt, they relied heavily on **Cenotes**, natural pits formed by the collapse of limestone bedrock, which exposed deep underground water. These Cenotes were not only essential for **drinking and agriculture**, but also served as vital **ceremonial sites and trade hubs**, connecting settlements across the region.",

                        "es": "La civilizaci√≥n Maya prosper√≥ en la densa selva tropical de la Pen√≠nsula de Yucat√°n, donde los r√≠os superficiales eran escasos. Para adaptarse, dependieron en gran medida de los **Cenotes**, pozos naturales formados por el colapso de la roca caliza que expon√≠an agua subterr√°nea profunda. Estos Cenotes no solo eran esenciales para **beber y la agricultura**, sino que tambi√©n serv√≠an como **sitios ceremoniales y centros comerciales** vitales, conectando asentamientos a lo largo de la regi√≥n.",

                        "fr": "La civilisation Maya a prosp√©r√© dans la dense for√™t tropicale de la p√©ninsule du Yucat√°n, o√π les rivi√®res de surface √©taient rares. Pour s'adapter, ils ont fortement d√©pendu des **C√©notes**, des fosses naturelles form√©es par l'effondrement du socle calcaire qui exposaient de profondes nappes d'eau souterraines. Ces C√©notes √©taient non seulement essentiels pour **la boisson et l'agriculture**, mais servaient √©galement de **sites c√©r√©moniels vitaux et de carrefours commerciaux**, reliant les colonies √† travers la r√©gion."

                    },

                    "interaction": { "type": "placeResource", "prompt": { "en": "Click to place a Trade Post and log your observation.", "es": "Haga clic para colocar un Puesto Comercial y registrar su observaci√≥n.", "fr": "Cliquez pour placer un Poste de Commerce et enregistrer votre observation." } },

                },

                "aztec_chinampa": {

                    "title": { "en": "Aztec: Chinampas (Floating Gardens)", "es": "Azteca: Chinampas (Jardines Flotantes)", "fr": "Azt√®que: Chinampas (Jardins Flottants)" },

                    "short": { "en": "Study the ingenious agricultural system that fed the massive capital of Tenochtitlan.", "es": "Estudie el ingenioso sistema agr√≠cola que aliment√≥ la enorme capital de Tenochtitlan.", "fr": "√âtudiez le syst√®me agricole ing√©nieux qui a nourri la capitale massive de Tenochtitlan." },

                    "scene_url": "https://placehold.co/900x500/104351/F0F0F0?text=Aztec+Lake+Texcoco+Site",

                    "narration": {

                        "en": "The Aztec capital, Tenochtitlan, was built on a swampy island in Lake Texcoco. To overcome the lack of arable land and feed a growing population of hundreds of thousands, the Aztecs engineered **Chinampas**, or 'floating gardens'. These were highly fertile, rectangular plots of land created by layering mud, vegetation, and decaying matter onto the lakebed, providing **multiple harvests a year** and a stable food supply.",

                        "es": "La capital Azteca, Tenochtitlan, fue construida en una isla pantanosa en el Lago Texcoco. Para superar la falta de tierra cultivable y alimentar a una poblaci√≥n creciente de cientos de miles, los Aztecas ingeniaron **Chinampas**, o 'jardines flotantes'. Eran parcelas de tierra rectangulares y muy f√©rtiles creadas al superponer barro, vegetaci√≥n y materia en descomposici√≥n sobre el lecho del lago, proporcionando **m√∫ltiples cosechas al a√±o** y un suministro estable de alimentos.",

                        "fr": "La capitale Azt√®que, Tenochtitlan, a √©t√© construite sur une √Æle mar√©cageuse du lac Texcoco. Pour pallier le manque de terres arables et nourrir une population croissante de centaines de milliers d'habitants, les Azt√®ques ont con√ßu les **Chinampas**, ou 'jardines flottants'. Il s'agissait de parcelles de terre rectangulaires tr√®s fertiles, cr√©√©es en superposant de la boude, de la v√©g√©tation et de la mati√®re en d√©composition sur le fond du lac, permettant **plusieurs r√©coltes par an** et un approvisionnement alimentaire stable."

                    },

                    "interaction": { "type": "buildChinampa", "prompt": { "en": "Click to simulate building a Chinampa and log your observation.", "es": "Haga clic para simuler la construcci√≥n de una Chinampa et enregistrer votre observation.", "fr": "Cliquez pour simuler la construction d'une Chinampa et enregistrer votre observation." } },

                },

                "inca_terrace": {

                    "title": { "en": "Inca: Terrace Farming (Andes)", "es": "Inca: Cultivo en Terrazas (Andes)", "fr": "Inca: Agriculture en Terrasses (Andes)" },

                    "short": { "en": "View the engineering marvel of stable, high-altitude agriculture in the steep Andean mountains.", "es": "Vea la maravilla de ingenier√≠a de la agricultura estable a gran altura en las escarpadas monta√±as andinas.", "fr": "D√©couvrez la merveille d'ing√©nierie de l'agriculture stable en haute altitude dans les montagnes abruptes." },

                    "scene_url": "https://placehold.co/900x500/5A5A5A/F0F0F0?text=Inca+Andes+Mountain+Site",

                    "narration": {

                        "en": "Living high in the **Andes Mountains**, the Inca faced the extreme challenge of steep slopes and variable climate. Their solution was **terrace farming**. By constructing massive stone walls to create flat, stepped fields, they not only stabilized the mountain slopes against **erosion** but also created **microclimates**. These tiered systems captured and conserved precious rainfall, allowing them to cultivate crops like potatoes and quinoa efficiently at altitudes up to 12,000 feet.",

                        "es": "Viviendo en lo alto de las **Monta√±as de los Andes**, los Incas enfrentaron el desaf√≠o extremo de las laderas empinadas y el clima variable. Su soluci√≥n fue la **agricultura en terrazas**. Al construir enormes muros de piedra para crear campos planos y escalonados, no solo estabilizaron las laderas contra la **erosi√≥n**, sino que tambi√©n crearon **microclimas**. Estos sistemas escalonados captaban y conservaban las preciosas lluvias, permiti√©ndoles cultivar eficientemente cosechas como la papa y la quinua a altitudes de hasta 12,000 pies.",

                        "fr": "Vivant en altitude dans les **montagnes des Andes**, les Incas ont √©t√© confront√©s au d√©fi extr√™me des pentes raides et d'un climat variable. Leur solution fut l'**agriculture en terrasses**. En construisant des murs de pierre massifs pour cr√©er des champs plats et √©tag√©s, ils ont non seulement stabilis√© les pentes contre l'**√©rosion**, mais ont √©galement cr√©√© des **microclimats**. Ces syst√®mes √©tag√©s captaient et conservaient les pr√©cieuses eaux de pluie, leur permettant de cultiver efficacement des cultures comme la pomme de terre et le quinoa √† des altitudes allant jusqu'√† 12 000 pieds."

                    },

                    "interaction": { "type": "buildTerrace", "prompt": { "en": "Click to simulate building a Terrace and log your observation.", "es": "Haga clic para simular la construcci√≥n de una Terraza y registrar su observaci√≥n.", "fr": "Cliquez pour simuler la construction d'une Terraza y enregistrer su observation." } },

                }

            },

            "sentence_frames": {

                "central_idea": {

                    "en": "The primary way ancient civilizations adapted to their environments was by __________.",

                    "es": "La forma principal en que las civilizaciones antiguas se adaptaron a sus entornos fue mediante __________.",

                    "fr": "La principale fa√ßon dont les civilisations antiques se sont adapt√©es √† leurs environnements fut de __________."

                },

                "detail_prompt": {

                    "en": "The first key detail that supports this idea is the use of ______ by the ______ civilization, which addressed the challenge of ______.",

                    "es": "El primer detalle clave que apoya esta idea es el uso de ______ por la civilizaci√≥n de los ______, que abord√≥ el desaf√≠o de ______.",

                    "fr": "Le premier d√©tail cl√© qui soutient cette id√©e est l'utilisation de ______ par la civilisation ______, qui a relev√© le d√©fi de ______."

                }

            }

        };

 

        // --- Firebase Initialization and Authentication ---

 

        async function initializeFirebase() {

            const dbStatusEl = document.getElementById('db-status');

            dbStatusEl.textContent = 'Connecting...';

            dbStatusEl.className = 'px-3 py-1 text-xs font-medium rounded-full bg-gray-600 text-gray-200';

           

            if (!firebaseConfig || !firebaseConfig.apiKey.startsWith('AIzaSy')) { // Basic check for placeholder key

                dbStatusEl.textContent = 'DB Error: Placeholder Config';

                dbStatusEl.className = 'px-3 py-1 text-xs font-medium rounded-full bg-red-800 text-red-200';

                console.error("Firebase config is missing or is using a placeholder. Code will run, but persistence will not work.");

                // Allow the app to run without persistence for demonstration

                currentUserId = 'demo-user-' + Math.random().toString(36).substring(2, 8);

                isDbConnected = false;

                dbStatusEl.textContent = `Demo User: ${currentUserId}`;

                dbStatusEl.className = 'px-3 py-1 text-xs font-medium rounded-full bg-yellow-700 text-yellow-100';

                loadWork(true); // Load with fallback only

                return;

            }

 

            try {

                const app = initializeApp(firebaseConfig);

                db = getFirestore(app);

                auth = getAuth(app);

 

                // Removed signInWithCustomToken since it's an internal-only flow and not provided

                await signInAnonymously(auth);

 

                await new Promise(resolve => onAuthStateChanged(auth, user => {

                    if (user) {

                        currentUserId = user.uid;

                    } else {

                        // Fallback if sign-in fails

                        currentUserId = crypto.randomUUID();

                    }

                    isDbConnected = true;

                    dbStatusEl.textContent = `User ID: ${currentUserId.substring(0, 8)}...`;

                    dbStatusEl.className = 'px-3 py-1 text-xs font-medium rounded-full bg-green-700 text-green-100';

                    resolve();

                }));

 

                loadWork(); // Load with persistence

 

            } catch (error) {

                dbStatusEl.textContent = 'DB Error: Auth Failed';

                dbStatusEl.className = 'px-3 py-1 text-xs font-medium rounded-full bg-red-800 text-red-200';

                console.error("Firebase initialization or authentication failed:", error);

                // Fallback to local user

                currentUserId = 'demo-user-fallback';

                isDbConnected = false;

            }

        }

       

        // --- Firestore Data Paths and Functions ---

       

        function getStudentWorkDocRef() {

            if (!db || !currentUserId) return null;

            return doc(db, 'artifacts', appId, 'users', currentUserId, 'responseFrames', 'mainAssignment');

        }

 

        function getTeacherCollectionRef() {

            if (!db) return null;

            // CRITICAL FIX: The path to a teacher collection must include a final document reference for setDoc

            // The teacher list should listen to the 'studentResponses' collection, but writing should be to a doc.

            return collection(db, 'artifacts', appId, 'public', 'data', 'studentResponses');

        }

 

        /**

         * Saves work to Firestore (and potentially a public teacher collection).

         * @param {string} field - The specific field to update (e.g., 'centralIdea').

         * @param {string} value - The value for the field.

         * @param {Object} completedHotspotsData - The complete object of completed hotspots.

         */

        async function saveWork(field, value, completedHotspotsData) {

            const saveStatusEl = document.getElementById('save-status');

            if (!isDbConnected || !currentUserId) {

                // If not connected, save locally for now (not implemented, but good practice)

                saveStatusEl.textContent = 'Demo Mode: Data Not Saved to Cloud';

                return;

            }

 

            const docRef = getStudentWorkDocRef();

            const teacherDocRef = doc(getTeacherCollectionRef(), currentUserId); // Doc reference for the teacher collection

           

            saveStatusEl.textContent = 'Saving...';

 

            const updateData = {};

            if (field) updateData[field] = value;

            if (completedHotspotsData) updateData.completedHotspots = completedHotspotsData;

           

            try {

                const timestamp = new Date().toISOString();

                updateData.lastUpdated = timestamp;

                updateData.userId = currentUserId;

 

                await setDoc(docRef, updateData, { merge: true });

                await setDoc(teacherDocRef, updateData, { merge: true }); // Save to public teacher view

 

                saveStatusEl.textContent = `Saved automatically at ${new Date().toLocaleTimeString()}`;

            } catch (error) {

                saveStatusEl.textContent = 'Save Failed!';

                console.error("Error saving work to Firestore:", error);

            }

        }

 

        /**

         * Loads student work from Firestore and sets up a real-time listener.

         * @param {boolean} isDemo - Flag to indicate if running in demo mode (no listener)

         */

        function loadWork(isDemo = false) {

            if (!isDbConnected || !currentUserId || isDemo) return;

 

            const docRef = getStudentWorkDocRef();

           

            onSnapshot(docRef, (docSnap) => {

                if (docSnap.exists()) {

                    const data = docSnap.data();

                   

                    if (data.centralIdea) document.getElementById('central-idea-input').value = data.centralIdea;

                    if (data.detail1) document.getElementById('detail-1-input').value = data.detail1;

                    if (data.detail2) document.getElementById('detail-2-input').value = data.detail2;

                   

                    if (data.completedHotspots) {

                        completedHotspots = data.completedHotspots; // CRITICAL FIX: Update global object

                        Object.keys(completedHotspots).forEach(hotspotId => {

                            if (completedHotspots[hotspotId] === true) {

                                const cardId = hotspotId.replace(/_/g, '-') + '-card';

                                const card = document.getElementById(cardId);

                               

                                if (card) {

                                    card.classList.add('completed');

                                    const statusElementId = hotspotId.replace(/_/g, '-') + '-status';

                                    const statusElement = document.getElementById(statusElementId);

                                    if(statusElement) statusElement.classList.remove('hidden');

                                }

                            }

                        });

                    }

                }

            }, (error) => {

                console.error("Error loading work in real-time:", error);

            });

        }

 

        /**

         * Loads submissions for the teacher view.

         */

        function loadTeacherSubmissions() {

            const submissionsListEl = document.getElementById('submissions-list');

            submissionsListEl.innerHTML = '';

            submissionsListEl.innerHTML = `<p class="text-gray-500" id="loading-submissions">${getLocalizedText('ui.loading_submissions')}</p>`;

 

            if (!isDbConnected) {

                submissionsListEl.innerHTML = `<p class="text-red-500">Cannot load teacher data: Database connection failed.</p>`;

                return;

            }

 

            const colRef = getTeacherCollectionRef();

            // Query to listen to the top few submissions

            const q = query(colRef, limit(10));

 

            onSnapshot(q, (snapshot) => {

                const submissions = [];

                snapshot.forEach(doc => {

                    const data = doc.data();

                    submissions.push(data);

                });

               

                submissionsListEl.innerHTML = ''; // Clear loading message

 

                if (submissions.length === 0) {

                    submissionsListEl.innerHTML = `<p class="text-gray-500">No submissions found yet.</p>`;

                    return;

                }

 

                submissions.forEach(sub => {

                    const hotspotCount = sub.completedHotspots ? Object.values(sub.completedHotspots).filter(v => v).length : 0;

                    submissionsListEl.innerHTML += `

                        <div class="bg-gray-800 p-4 rounded-lg shadow-md border-l-4 border-blue-500">

                            <p class="font-bold text-white mb-1">Student: ${sub.userId ? sub.userId.substring(0, 8) + '...' : 'N/A'}</p>

                            <p class="text-sm text-gray-400">Last Updated: ${new Date(sub.lastUpdated).toLocaleTimeString()}</p>

                            <p class="text-sm text-green-400 mt-2">Hotspots Completed: ${hotspotCount}/3</p>

                            <p class="mt-2 text-gray-300">Central Idea: ${sub.centralIdea || 'Not started'}</p>

                            <p class="text-gray-300">Detail 1: ${sub.detail1 || 'Not started'}</p>

                        </div>

                    `;

                });

            }, (error) => {

                console.error("Error loading teacher submissions:", error);

                submissionsListEl.innerHTML = `<p class="text-red-500">Error loading data: ${error.message}</p>`;

            });

        }

 

        // --- UI/Localization & Event Handlers ---

 

        let currentLocale = APP_DATA.locale;

        let audioCtx = null;

        let ttsAudio = null;

 

        function initAudio() {

            if (!audioCtx) {

                try {

                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();

                } catch (e) {

                    console.error("Audio Context initialization failed:", e);

                }

            }

            if (audioCtx && audioCtx.state === 'suspended') {

                audioCtx.resume().catch(e => console.error("Failed to resume AudioContext:", e));

            }

        }

       

        // CRITICAL FIX: The TTS functionality is missing. A functional mock is added.

        function playVoiceover(hotspotId) {

            initAudio();

            const narrationText = getLocalizedText(`hotspots.${hotspotId}.narration`);

            console.log(`Simulating voiceover for: ${narrationText}`);

           

            // Use browser's built-in Web Speech API as a mock for the voiceover

            if ('speechSynthesis' in window) {

                if (ttsAudio) window.speechSynthesis.cancel();

                ttsAudio = new SpeechSynthesisUtterance(narrationText);

                ttsAudio.lang = currentLocale;

                window.speechSynthesis.speak(ttsAudio);

            } else {

                alert(`[TTS] Narration for ${hotspotId}: ${narrationText}`);

            }

        }

 

        function getLocalizedText(path, locale = currentLocale) {

            const parts = path.split('.');

            let data = APP_DATA;

            for (const part of parts) {

                if (data && data.hasOwnProperty(part)) {

                    data = data[part];

                } else {

                    return `[Missing Text: ${path}]`;

                }

            }

            if (typeof data === 'object' && data !== null && data.hasOwnProperty(locale)) {

                return data[locale];

            }

            return data;

        }

 

        function updateTimerDisplay() {

            const timeElapsed = Date.now() - sessionStartTime;

            const remainingTimeMs = Math.max(0, (1800 * 1000) - timeElapsed); // 30 minutes limit

            const totalSeconds = Math.floor(remainingTimeMs / 1000);

            const minutes = String(Math.floor(totalSeconds / 60)).padStart(2, '0');

            const seconds = String(totalSeconds % 60).padStart(2, '0');

           

            const timerEl = document.getElementById('session-timer');

            const timerText = getLocalizedText('ui.session_timer');

            timerEl.textContent = timerText.replace('{mm}', minutes).replace('{ss}', seconds);

 

            if (remainingTimeMs === 0 && timerInterval) {

                clearInterval(timerInterval);

                timerEl.textContent = "TIME EXPIRED";

            }

        }

       

        function render() {

            document.getElementById('choose-language').textContent = getLocalizedText('ui.choose_language');

            document.getElementById('explore-mode-btn').textContent = getLocalizedText('ui.explore_mode');

            document.getElementById('teacher-view-btn').textContent = getLocalizedText('ui.teacher_view');

            document.getElementById('response-frame-title').textContent = getLocalizedText('ui.response_frame_title');

            document.getElementById('export-analytics-btn').textContent = getLocalizedText('ui.export_analytics');

 

            Object.entries(APP_DATA.hotspots).forEach(([id, data]) => {

                const elementIdBase = id.replace(/_/g, '-');

               

                const titleEl = document.getElementById(`${elementIdBase}-title`);

                const shortEl = document.getElementById(`${elementIdBase}-short`);

                const promptEl = document.getElementById(`${elementIdBase}-prompt`);

 

                if (titleEl) titleEl.textContent = data.title[currentLocale];

                if (shortEl) shortEl.textContent = data.short[currentLocale];

                if (promptEl) promptEl.textContent = data.interaction.prompt[currentLocale];

            });

 

            document.getElementById('central-idea-frame').textContent = getLocalizedText('sentence_frames.central_idea', currentLocale);

            const detailPrompt = getLocalizedText('sentence_frames.detail_prompt', currentLocale);

            document.getElementById('detail-prompt-1').textContent = detailPrompt.replace(/______/g, '_________');

            document.getElementById('detail-prompt-2').textContent = detailPrompt.replace(/______/g, '_________');

        }

 

        // --- Canvas Visualization Logic ---

 

        let offset = 0; // Global animation offset

       

        /** Draws the visualization based on the hotspot ID. */

        function drawVisualization(hotspotId, canvas, ctx) {

            if (!ctx) return;

 

            // Clear Canvas with a semi-transparent black overlay for context depth

            ctx.clearRect(0, 0, canvas.width, canvas.height); // CRITICAL FIX: Clear the canvas properly

            ctx.fillStyle = 'rgba(0, 0, 0, 0.4)';

            ctx.fillRect(0, 0, canvas.width, canvas.height);

 

            const w = canvas.width;

            const h = canvas.height;

            offset += 0.02; // Slower animation

 

            switch (hotspotId) {

                case 'maya_river':

                    // Simulate water flow/ripple (Cenote)

                    ctx.beginPath();

                    ctx.fillStyle = 'rgba(66, 153, 225, 0.6)'; // Blue water

                    ctx.arc(w / 2, h / 2, Math.min(w, h) / 3, 0, 2 * Math.PI);

                    ctx.fill();

 

                    // Ripple effect

                    for (let i = 0; i < 4; i++) {

                        const radius = Math.min(w, h) / 4 + Math.sin(offset + i * 1.5) * 20;

                        ctx.beginPath();

                        ctx.strokeStyle = 'rgba(129, 230, 217, 0.8)'; // Cyan ripple

                        ctx.lineWidth = 2;

                        ctx.arc(w / 2, h / 2, radius, 0, 2 * Math.PI);

                        ctx.stroke();

                    }

                    break;

                case 'aztec_chinampa':

                    // Simulate Chinampas (Rectangular plots)

                    for (let i = 0; i < 5; i++) {

                        const x = w * (0.1 + i * 0.18);

                        const y = h * 0.3 + Math.sin(offset + i) * 30;

                        const plotWidth = w * 0.15;

                        const plotHeight = h * 0.4;

 

                        // Water (Blue)

                        ctx.fillStyle = 'rgba(49, 130, 206, 0.3)';

                        ctx.fillRect(0, 0, w, h);

 

                        // Land plot (Green/Brown)

                        ctx.fillStyle = 'rgba(56, 161, 105, 0.9)';

                        ctx.fillRect(x, y, plotWidth, plotHeight);

 

                        // Animated crops (Dots)

                        for (let j = 0; j < 5; j++) {

                            ctx.beginPath();

                            ctx.fillStyle = 'rgba(255, 255, 0, 0.8)';

                            ctx.arc(x + plotWidth * 0.2 + j * (plotWidth * 0.15), y + plotHeight * 0.8 + Math.sin(offset * 5 + i * j) * 5, 3, 0, 2 * Math.PI);

                            ctx.fill();

                        }

                    }

                    break;

                case 'inca_terrace':

                    // Simulate Terrace Farming (Steps)

                    for (let i = 0; i < 6; i++) {

                        const stepHeight = h / 6;

                        const y = h - (i + 1) * stepHeight;

                       

                        // Stone wall (Gray)

                        ctx.fillStyle = 'rgba(113, 128, 150, 0.8)';

                        ctx.fillRect(0, y, w, 10);

 

                        // Soil/Field (Brown/Green)

                        ctx.fillStyle = 'rgba(107, 70, 50, 0.7)';

                        ctx.fillRect(0, y - stepHeight + 10, w, stepHeight - 10);

                       

                        // Animated plants (Lines)

                        for(let j = 0; j < 20; j++) {

                             ctx.beginPath();

                             ctx.strokeStyle = 'rgba(198, 246, 213, 0.9)';

                             ctx.lineWidth = 1;

                             const plantX = w / 20 * j + Math.sin(offset + i + j) * 5;

                             ctx.moveTo(plantX, y - stepHeight + 15);

                             ctx.lineTo(plantX, y - 20 - (i*5));

                             ctx.stroke();

                        }

                    }

                    break;

                default:

                    ctx.fillStyle = '#FF0000';

                    ctx.font = '30px Arial';

                    ctx.fillText('Select a Hotspot', w / 2 - 100, h / 2);

            }

 

            // Loop the animation

            animationFrameId = requestAnimationFrame(() => drawVisualization(hotspotId, canvas, ctx));

        }

 

 

        // --- Main Initialization and Listeners ---

 

        document.addEventListener('DOMContentLoaded', () => {

            initializeFirebase();

            render();

            timerInterval = setInterval(updateTimerDisplay, 1000); // Start timer

 

            // Language Selector

            document.getElementById('language-selector').addEventListener('change', (e) => {

                currentLocale = e.target.value;

                APP_DATA.locale = currentLocale;

                render();

            });

 

            // Input Debounce for auto-saving

            let saveTimeout;

            document.querySelectorAll('.assignment-input').forEach(input => {

                input.addEventListener('input', (e) => {

                    clearTimeout(saveTimeout);

                    const field = e.target.dataset.field;

                    const value = e.target.value;

                    saveTimeout = setTimeout(() => {

                        saveWork(field, value, completedHotspots);

                    }, 1000); // Wait 1 second after last input

                });

            });

 

            // Hotspot Card Click to Open Modal

            document.querySelectorAll('.hotspot-card').forEach(card => {

                card.addEventListener('click', (e) => {

                    // Prevent opening modal if clicking the voiceover button

                    if (e.target.closest('.play-voiceover-btn')) return;

 

                    const hotspotId = card.dataset.hotspotId;

                    const data = APP_DATA.hotspots[hotspotId];

                    const modal = document.getElementById('visualization-modal');

                    const canvas = document.getElementById('visualization-canvas');

                    const ctx = canvas.getContext('2d');

 

                    if (!data) return;

 

                    // Set Modal Content

                    document.getElementById('modal-title').textContent = data.title[currentLocale];

                    document.getElementById('modal-narration').innerHTML = data.narration[currentLocale]; // Use innerHTML to allow **bolding**

                    document.getElementById('modal-interaction-prompt').textContent = data.interaction.prompt[currentLocale];

                    document.getElementById('scene-image').src = data.scene_url; // Set context image

 

                    // Show Modal

                    modal.style.display = 'flex'; // CRITICAL FIX: Set to 'flex' to make it visible and centered

 

                    // Stop any existing animation and start new one

                    if (animationFrameId) cancelAnimationFrame(animationFrameId);

                   

                    // CRITICAL FIX: Set canvas size based on wrapper's rendered size

                    const wrapper = document.getElementById('canvas-wrapper');

                    canvas.width = wrapper.clientWidth;

                    canvas.height = wrapper.clientHeight;

 

                    drawVisualization(hotspotId, canvas, ctx);

                    initAudio(); // Initialize audio context on first user interaction

                });

            });

 

            // Modal Interaction (Canvas Click to Complete Hotspot)

            document.getElementById('visualization-canvas').addEventListener('click', () => {

                const modal = document.getElementById('visualization-modal');

                const hotspotTitleEl = document.getElementById('modal-title');

               

                // Extract hotspotId from the title (e.g., "Maya: Cenotes (..)" -> "maya_river")

                const currentTitle = hotspotTitleEl.textContent;

                const entry = Object.entries(APP_DATA.hotspots).find(([id, data]) => data.title[currentLocale] === currentTitle);

               

                if (entry) {

                    const hotspotId = entry[0];

                    completedHotspots[hotspotId] = true;

                   

                    // Update UI and save progress

                    const cardId = hotspotId.replace(/_/g, '-') + '-card';

                    const card = document.getElementById(cardId);

                    if(card) {

                        card.classList.add('completed');

                        document.getElementById(hotspotId.replace(/_/g, '-') + '-status').classList.remove('hidden');

                    }

                   

                    saveWork(null, null, completedHotspots); // Save the updated completedHotspots object

 

                    // Close the modal

                    modal.style.display = 'none';

                    if (animationFrameId) cancelAnimationFrame(animationFrameId);

                }

            });

 

            // Close Modal Button

            document.getElementById('modal-close-btn').addEventListener('click', () => {

                document.getElementById('visualization-modal').style.display = 'none';

                if (animationFrameId) cancelAnimationFrame(animationFrameId);

                if (ttsAudio) window.speechSynthesis.cancel();

            });

 

            // Close Modal on outside click (window)

            window.addEventListener('click', (event) => {

                const modal = document.getElementById('visualization-modal');

                if (event.target === modal) {

                    modal.style.display = 'none';

                    if (animationFrameId) cancelAnimationFrame(animationFrameId);

                    if (ttsAudio) window.speechSynthesis.cancel();

                }

            });

 

            // Voiceover Button

            document.querySelectorAll('.play-voiceover-btn').forEach(btn => {

                btn.addEventListener('click', (e) => {

                    const hotspotId = e.currentTarget.dataset.hotspot;

                    playVoiceover(hotspotId);

                });

            });

 

            // Teacher/Student View Toggle

            const exploreView = document.getElementById('explore-mode-view');

            const teacherView = document.getElementById('teacher-view-content');

            const exploreBtn = document.getElementById('explore-mode-btn');

            const teacherBtn = document.getElementById('teacher-view-btn');

 

            exploreBtn.addEventListener('click', () => {

                exploreView.classList.remove('hidden');

                teacherView.classList.add('hidden');

                exploreBtn.classList.replace('bg-gray-600', 'bg-blue-600');

                teacherBtn.classList.replace('bg-blue-600', 'bg-gray-600');

            });

 

            teacherBtn.addEventListener('click', () => {

                exploreView.classList.add('hidden');

                teacherView.classList.remove('hidden');

                teacherBtn.classList.replace('bg-gray-600', 'bg-blue-600');

                exploreBtn.classList.replace('bg-blue-600', 'bg-gray-600');

                loadTeacherSubmissions(); // Load data when switching to teacher view

            });

 

            // Window resize handler to maintain aspect ratio on canvas

            window.addEventListener('resize', () => {

                const modal = document.getElementById('visualization-modal');

                if (modal.style.display === 'flex') {

                    const canvas = document.getElementById('visualization-canvas');

                    const wrapper = document.getElementById('canvas-wrapper');

                    canvas.width = wrapper.clientWidth;

                    canvas.height = wrapper.clientHeight;

                    // Restart animation to redraw with new dimensions

                    if (animationFrameId) cancelAnimationFrame(animationFrameId);

                    // This relies on knowing the currently open hotspot, which is tricky.

                    // A simple redraw without a full loop restart will suffice for a static change.

                }

            });

           

            // Initial call to ensure Explore mode is visible on load

            exploreBtn.click();

        });

    </script>

</body>

</html>
