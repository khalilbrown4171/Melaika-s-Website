<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="2487.7">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica; min-height: 14.0px}
  </style>
</head>
<body>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;title&gt;Ancient Civilizations Virtual Field Trip&lt;/title&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;script src="https://cdn.tailwindcss.com"&gt;&lt;/script&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&amp;display=swap" rel="stylesheet"&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;style&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>/* Custom styles for aesthetic font and a richer, darker theme */</p>
<p class="p1"><span class="Apple-converted-space">        </span>body {</p>
<p class="p1"><span class="Apple-converted-space">            </span>font-family: 'Inter', sans-serif;</p>
<p class="p1"><span class="Apple-converted-space">            </span>background-color: #1a202c; /* Dark background for immersive feel */</p>
<p class="p1"><span class="Apple-converted-space">            </span>color: #e2e8f0;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>header {</p>
<p class="p1"><span class="Apple-converted-space">            </span>background-color: #2d3748; /* Darker grey header */</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>h1, h2, h3 {</p>
<p class="p1"><span class="Apple-converted-space">            </span>color: #ffffff;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>.hotspot-card {</p>
<p class="p1"><span class="Apple-converted-space">            </span>transition: all 0.3s ease;</p>
<p class="p1"><span class="Apple-converted-space">            </span>cursor: pointer;</p>
<p class="p1"><span class="Apple-converted-space">            </span>min-height: 250px;</p>
<p class="p1"><span class="Apple-converted-space">            </span>background-color: #2d3748; /* Card background */</p>
<p class="p1"><span class="Apple-converted-space">            </span>border-color: #4a5568;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>.hotspot-card:hover {</p>
<p class="p1"><span class="Apple-converted-space">            </span>transform: translateY(-4px);</p>
<p class="p1"><span class="Apple-converted-space">            </span>box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);</p>
<p class="p1"><span class="Apple-converted-space">            </span>border-color: #4299e1; /* Blue hover border */</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>/* Hotspot Completion State */</p>
<p class="p1"><span class="Apple-converted-space">        </span>.completed {</p>
<p class="p1"><span class="Apple-converted-space">            </span>border-color: #38a169 !important; /* Green 600 */</p>
<p class="p1"><span class="Apple-converted-space">            </span>background-color: #2f4744 !important; /* Darker green background */</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>/* Modal Styles - The Field Trip Viewer */</p>
<p class="p1"><span class="Apple-converted-space">        </span>.modal {</p>
<p class="p1"><span class="Apple-converted-space">            </span>display: none;</p>
<p class="p1"><span class="Apple-converted-space">            </span>position: fixed;</p>
<p class="p1"><span class="Apple-converted-space">            </span>z-index: 1000;</p>
<p class="p1"><span class="Apple-converted-space">            </span>left: 0;</p>
<p class="p1"><span class="Apple-converted-space">            </span>top: 0;</p>
<p class="p1"><span class="Apple-converted-space">            </span>width: 100%;</p>
<p class="p1"><span class="Apple-converted-space">            </span>height: 100%;</p>
<p class="p1"><span class="Apple-converted-space">            </span>overflow: auto;</p>
<p class="p1"><span class="Apple-converted-space">            </span>background-color: rgba(0, 0, 0, 0.95);<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>/* Added flex properties to center the modal content */</p>
<p class="p1"><span class="Apple-converted-space">            </span>display: flex; /* CRITICAL FIX: Changed from 'none' to 'flex' by JS, but 'flex' is needed when visible */</p>
<p class="p1"><span class="Apple-converted-space">            </span>justify-content: center;</p>
<p class="p1"><span class="Apple-converted-space">            </span>align-items: center;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>.modal-content {</p>
<p class="p1"><span class="Apple-converted-space">            </span>background-color: #2d3748;</p>
<p class="p1"><span class="Apple-converted-space">            </span>margin: auto;</p>
<p class="p1"><span class="Apple-converted-space">            </span>padding: 24px;</p>
<p class="p1"><span class="Apple-converted-space">            </span>border-radius: 16px;</p>
<p class="p1"><span class="Apple-converted-space">            </span>width: 95%;</p>
<p class="p1"><span class="Apple-converted-space">            </span>max-width: 1000px;</p>
<p class="p1"><span class="Apple-converted-space">            </span>position: relative;</p>
<p class="p1"><span class="Apple-converted-space">            </span>box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8);</p>
<p class="p1"><span class="Apple-converted-space">            </span>border: 2px solid #4a5568;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>.close-btn {</p>
<p class="p1"><span class="Apple-converted-space">            </span>color: #a0aec0;</p>
<p class="p1"><span class="Apple-converted-space">            </span>position: absolute;</p>
<p class="p1"><span class="Apple-converted-space">            </span>top: 15px;</p>
<p class="p1"><span class="Apple-converted-space">            </span>right: 25px;</p>
<p class="p1"><span class="Apple-converted-space">            </span>font-size: 36px;</p>
<p class="p1"><span class="Apple-converted-space">            </span>font-weight: bold;</p>
<p class="p1"><span class="Apple-converted-space">            </span>line-height: 1;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>.close-btn:hover,</p>
<p class="p1"><span class="Apple-converted-space">        </span>.close-btn:focus {</p>
<p class="p1"><span class="Apple-converted-space">            </span>color: #ffffff;</p>
<p class="p1"><span class="Apple-converted-space">            </span>text-decoration: none;</p>
<p class="p1"><span class="Apple-converted-space">            </span>cursor: pointer;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>/* Canvas container for 16:9 aspect ratio */</p>
<p class="p1"><span class="Apple-converted-space">        </span>.aspect-visualization {</p>
<p class="p1"><span class="Apple-converted-space">            </span>aspect-ratio: 16 / 9;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/style&gt;</p>
<p class="p1">&lt;/head&gt;</p>
<p class="p1">&lt;body class="p-4 md:p-8"&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div id="app" class="max-w-7xl mx-auto"&gt;</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 p-4 rounded-xl shadow-2xl"&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;h1 class="text-3xl font-bold text-white mb-4 sm:mb-0"&gt;Ancient Civilizations Virtual Field Trip&lt;/h1&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;div class="flex flex-col md:flex-row items-start md:items-center space-y-4 md:space-y-0 md:space-x-8"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;div class="flex items-center space-x-4"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div id="db-status" class="px-3 py-1 text-xs font-medium rounded-full"&gt;&lt;/div&gt;</p>
<p class="p2"><span class="Apple-converted-space">                    </span></p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;p id="choose-language" class="text-gray-400"&gt;&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;select id="language-selector" class="p-2 border border-gray-600 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-700 text-white"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;option value="en"&gt;English (en)&lt;/option&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;option value="es"&gt;Espa√±ol (es)&lt;/option&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;option value="fr"&gt;Fran√ßais (fr)&lt;/option&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/select&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;/header&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;div class="flex flex-wrap gap-4 mb-8"&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;button id="explore-mode-btn" class="flex-1 min-w-[150px] px-4 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-150"&gt;&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;button id="teacher-view-btn" class="flex-1 min-w-[150px] px-4 py-3 bg-gray-600 text-white font-semibold rounded-lg shadow-md hover:bg-gray-700 transition duration-150"&gt;&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;div id="session-timer" class="flex-1 min-w-[150px] flex items-center justify-center bg-yellow-900 text-yellow-300 font-bold p-3 rounded-lg shadow-inner"&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;button id="export-analytics-btn" class="flex-1 min-w-[150px] px-4 py-3 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition duration-150"&gt;Export Analytics&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;/div&gt;</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;div id="explore-mode-view"&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;h2 class="text-2xl font-semibold text-gray-200 mb-6"&gt;Field Trip Destinations: Engineering Adaptation&lt;/h2&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;div id="hotspots-container" class="grid md:grid-cols-3 gap-6 mb-12"&gt;</p>
<p class="p2"><span class="Apple-converted-space">                </span></p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;div id="maya-river-card" data-hotspot-id="maya_river" class="hotspot-card interaction-card p-6 rounded-xl shadow-lg border-t-4 border-gray-600"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div class="flex justify-between items-start mb-3"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;h3 class="text-xl font-bold text-white" id="maya-river-title"&gt;&lt;/h3&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;button class="play-voiceover-btn text-2xl text-purple-400 hover:text-purple-300 transition duration-150" data-hotspot="maya_river"&gt;üéôÔ∏è&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;p class="text-sm text-gray-400 mb-4" id="maya-river-short"&gt;&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div class="space-y-3"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div class="p-3 bg-green-900 rounded-lg text-sm interaction-prompt text-green-200" id="maya-river-prompt"&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div class="mt-4 text-sm font-semibold text-green-400 hidden" id="maya-river-status"&gt;FIELD TRIP COMPLETED&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;div id="aztec-chinampa-card" data-hotspot-id="aztec_chinampa" class="hotspot-card interaction-card p-6 rounded-xl shadow-lg border-t-4 border-gray-600"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div class="flex justify-between items-start mb-3"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;h3 class="text-xl font-bold text-white" id="aztec-chinampa-title"&gt;&lt;/h3&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;button class="play-voiceover-btn text-2xl text-purple-400 hover:text-purple-300 transition duration-150" data-hotspot="aztec_chinampa"&gt;üéôÔ∏è&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;p class="text-sm text-gray-400 mb-4" id="aztec-chinampa-short"&gt;&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div class="space-y-3"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div class="p-3 bg-red-900 rounded-lg text-sm interaction-prompt text-red-200" id="aztec-chinampa-prompt"&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div class="mt-4 text-sm font-semibold text-green-400 hidden" id="aztec-chinampa-status"&gt;FIELD TRIP COMPLETED&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;div id="inca-terrace-card" data-hotspot-id="inca_terrace" class="hotspot-card interaction-card p-6 rounded-xl shadow-lg border-t-4 border-gray-600"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div class="flex justify-between items-start mb-3"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;h3 class="text-xl font-bold text-white" id="inca-terrace-title"&gt;&lt;/h3&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;button class="play-voiceover-btn text-2xl text-purple-400 hover:text-purple-300 transition duration-150" data-hotspot="inca_terrace"&gt;üéôÔ∏è&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;p class="text-sm text-gray-400 mb-4" id="inca-terrace-short"&gt;&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div class="space-y-3"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div class="p-3 bg-blue-900 rounded-lg text-sm interaction-prompt text-blue-200" id="inca-terrace-prompt"&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div class="mt-4 text-sm font-semibold text-green-400 hidden" id="inca-terrace-status"&gt;FIELD TRIP COMPLETED&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;div class="bg-indigo-900 p-6 rounded-xl shadow-inner border-t-2 border-indigo-700"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;h2 class="text-xl font-bold text-indigo-200 mb-4" id="response-frame-title"&gt;&lt;/h2&gt;</p>
<p class="p2"><span class="Apple-converted-space">                </span></p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;p id="save-status" class="text-sm text-gray-400 mb-4"&gt;Saving status: Waiting for input...&lt;/p&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;div class="space-y-4"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div class="bg-gray-800 p-4 rounded-lg shadow-md"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;p class="text-gray-300 mb-2 font-semibold" id="central-idea-frame"&gt;&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;input type="text" data-field="centralIdea" id="central-idea-input" placeholder="Start your summary here..." class="assignment-input w-full p-2 border border-gray-600 rounded-md focus:ring-indigo-500 focus:border-indigo-500 bg-gray-700 text-white"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</p>
<p class="p2"><span class="Apple-converted-space">                    </span></p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div class="bg-gray-800 p-4 rounded-lg shadow-md"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;p class="text-gray-300 mb-2 font-semibold" id="detail-prompt-1"&gt;&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;input type="text" data-field="detail1" id="detail-1-input" placeholder="Explain your first supporting detail and its evidence..." class="assignment-input w-full p-2 border border-gray-600 rounded-md focus:ring-indigo-500 focus:border-indigo-500 bg-gray-700 text-white"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div class="bg-gray-800 p-4 rounded-lg shadow-md"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;p class="text-gray-300 mb-2 font-semibold" id="detail-prompt-2"&gt;&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;input type="text" data-field="detail2" id="detail-2-input" placeholder="Explain your second supporting detail and its evidence..." class="assignment-input w-full p-2 border border-gray-600 rounded-md focus:ring-indigo-500 focus:border-indigo-500 bg-gray-700 text-white"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;div id="teacher-view-content" class="hidden"&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;h2 class="text-3xl font-bold text-gray-200 mb-6 border-b border-gray-600 pb-2"&gt;Teacher Dashboard: Student Submissions&lt;/h2&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;div id="submissions-list" class="space-y-6"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;p class="text-gray-500" id="loading-submissions"&gt;Loading student submissions...&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div id="visualization-modal" class="modal"&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;div class="modal-content"&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;span class="close-btn" id="modal-close-btn"&gt;&amp;times;&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;h3 class="text-2xl font-bold mb-4 text-white" id="modal-title"&gt;&lt;/h3&gt;</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;div id="canvas-wrapper" class="aspect-visualization relative rounded-xl mb-4 border-4 border-gray-600 shadow-2xl overflow-hidden"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;img id="scene-image" class="absolute inset-0 w-full h-full object-cover opacity-30" src="https://placehold.co/900x500/1e293b/a5b4fc?text=Field+Trip+Destination+Context" onerror="this.src='https://placehold.co/900x500/1e293b/a5b4fc?text=Field+Trip+Destination+Context'" alt="Context image for the ancient site"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;canvas id="visualization-canvas" class="w-full h-full absolute inset-0"&gt;&lt;/canvas&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;/div&gt;</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;p id="modal-narration" class="text-gray-300 text-lg leading-relaxed"&gt;&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;p class="mt-4 text-md font-semibold text-purple-400" id="modal-interaction-prompt"&gt;&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;script type="module"&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";</p>
<p class="p1"><span class="Apple-converted-space">        </span>import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";</p>
<p class="p1"><span class="Apple-converted-space">        </span>// CRITICAL FIX: Removed signInWithCustomToken as it's not used in the public flow</p>
<p class="p1"><span class="Apple-converted-space">        </span>import { getFirestore, doc, setDoc, onSnapshot, collection, query, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";</p>
<p class="p1"><span class="Apple-converted-space">        </span>import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>// Set log level for debugging</p>
<p class="p1"><span class="Apple-converted-space">        </span>setLogLevel('debug');</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>// Global variables provided by the environment</p>
<p class="p1"><span class="Apple-converted-space">        </span>const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id-12345';</p>
<p class="p1"><span class="Apple-converted-space">        </span>// Use a safe default for firebase config if it's not defined</p>
<p class="p1"><span class="Apple-converted-space">        </span>const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {</p>
<p class="p1"><span class="Apple-converted-space">            </span>apiKey: "AIzaSyDEFAULTKEY", // Placeholder</p>
<p class="p1"><span class="Apple-converted-space">            </span>authDomain: "default-project.firebaseapp.com", // Placeholder</p>
<p class="p1"><span class="Apple-converted-space">            </span>projectId: "default-project-12345", // Placeholder</p>
<p class="p1"><span class="Apple-converted-space">            </span>storageBucket: "default-project-12345.appspot.com", // Placeholder</p>
<p class="p1"><span class="Apple-converted-space">            </span>messagingSenderId: "123456789012", // Placeholder</p>
<p class="p1"><span class="Apple-converted-space">            </span>appId: appId // Placeholder</p>
<p class="p1"><span class="Apple-converted-space">        </span>};</p>
<p class="p1"><span class="Apple-converted-space">        </span>const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;<span class="Apple-converted-space"> </span></p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>let db = null;</p>
<p class="p1"><span class="Apple-converted-space">        </span>let auth = null;</p>
<p class="p1"><span class="Apple-converted-space">        </span>let currentUserId = null;</p>
<p class="p1"><span class="Apple-converted-space">        </span>let isDbConnected = false;</p>
<p class="p1"><span class="Apple-converted-space">        </span>let animationFrameId = null; // To control the canvas animation loop</p>
<p class="p1"><span class="Apple-converted-space">        </span>let sessionStartTime = Date.now();</p>
<p class="p1"><span class="Apple-converted-space">        </span>let timerInterval = null;</p>
<p class="p1"><span class="Apple-converted-space">        </span>let completedHotspots = {}; // CRITICAL FIX: Initialize completedHotspots object</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>// --- Core Application Data (for Localization and Structure) ---</p>
<p class="p1"><span class="Apple-converted-space">        </span>const APP_DATA = {</p>
<p class="p1"><span class="Apple-converted-space">            </span>"locale": "en",</p>
<p class="p1"><span class="Apple-converted-space">            </span>"ui": {</p>
<p class="p1"><span class="Apple-converted-space">                </span>"choose_language": { "en": "Language:", "es": "Idioma:", "fr": "Langue:" },</p>
<p class="p1"><span class="Apple-converted-space">                </span>"explore_mode": { "en": "Start Field Trip", "es": "Comenzar Viaje", "fr": "D√©marrer l'Excursion" },</p>
<p class="p1"><span class="Apple-converted-space">                </span>"teacher_view": { "en": "Teacher Dashboard", "es": "Panel del Profesor", "fr": "Tableau de Bord du Professeur" },</p>
<p class="p1"><span class="Apple-converted-space">                </span>"response_frame_title": { "en": "Assignment: Synthesize Adaptation Strategies", "es": "Tarea: Sintetizar Estrategias de Adaptaci√≥n", "fr": "Devoir: Synth√©tiser les Strat√©gies d'Adaptation" },</p>
<p class="p1"><span class="Apple-converted-space">                </span>"session_timer": { "en": "Time Remaining: {mm}:{ss}", "es": "Tiempo Restante: {mm}:{ss}", "fr": "Temps Restant: {mm}:{ss}" },</p>
<p class="p1"><span class="Apple-converted-space">                </span>"export_analytics": { "en": "Export Analytics", "es": "Exportar Anal√≠ticas", "fr": "Exporter l'Analyse" }, // Added export button text</p>
<p class="p1"><span class="Apple-converted-space">                </span>"loading_submissions": { "en": "Loading student submissions...", "es": "Cargando entregas de estudiantes...", "fr": "Chargement des soumissions..." } // Added submissions text</p>
<p class="p1"><span class="Apple-converted-space">            </span>},</p>
<p class="p1"><span class="Apple-converted-space">            </span>"hotspots": {</p>
<p class="p1"><span class="Apple-converted-space">                </span>"maya_river": {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>"title": { "en": "Maya: Cenotes (Water &amp; Trade Hub)", "es": "Maya: Cenotes (Agua y Comercio)", "fr": "Maya: C√©notes (Eau et Commerce)" },</p>
<p class="p1"><span class="Apple-converted-space">                    </span>"short": { "en": "Explore the natural water sources critical for survival and trade in the Yucat√°n.", "es": "Explore las fuentes de agua naturales cr√≠ticas para la supervivencia y el comercio en Yucat√°n.", "fr": "Explorez les sources d'eau naturelles cruciales pour la survie et le commerce au Yucat√°n." },</p>
<p class="p1"><span class="Apple-converted-space">                    </span>"scene_url": "https://placehold.co/900x500/165511/F0F0F0?text=Maya+Yucatan+Jungle+Site",</p>
<p class="p1"><span class="Apple-converted-space">                    </span>"narration": {<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">                        </span>"en": "The Mayan civilization thrived in the dense, tropical rainforest of the Yucat√°n Peninsula, where surface rivers were scarce. To adapt, they relied heavily on **Cenotes**, natural pits formed by the collapse of limestone bedrock, which exposed deep underground water. These Cenotes were not only essential for **drinking and agriculture**, but also served as vital **ceremonial sites and trade hubs**, connecting settlements across the region.",</p>
<p class="p1"><span class="Apple-converted-space">                        </span>"es": "La civilizaci√≥n Maya prosper√≥ en la densa selva tropical de la Pen√≠nsula de Yucat√°n, donde los r√≠os superficiales eran escasos. Para adaptarse, dependieron en gran medida de los **Cenotes**, pozos naturales formados por el colapso de la roca caliza que expon√≠an agua subterr√°nea profunda. Estos Cenotes no solo eran esenciales para **beber y la agricultura**, sino que tambi√©n serv√≠an como **sitios ceremoniales y centros comerciales** vitales, conectando asentamientos a lo largo de la regi√≥n.",</p>
<p class="p1"><span class="Apple-converted-space">                        </span>"fr": "La civilisation Maya a prosp√©r√© dans la dense for√™t tropicale de la p√©ninsule du Yucat√°n, o√π les rivi√®res de surface √©taient rares. Pour s'adapter, ils ont fortement d√©pendu des **C√©notes**, des fosses naturelles form√©es par l'effondrement du socle calcaire qui exposaient de profondes nappes d'eau souterraines. Ces C√©notes √©taient non seulement essentiels pour **la boisson et l'agriculture**, mais servaient √©galement de **sites c√©r√©moniels vitaux et de carrefours commerciaux**, reliant les colonies √† travers la r√©gion."</p>
<p class="p1"><span class="Apple-converted-space">                    </span>},</p>
<p class="p1"><span class="Apple-converted-space">                    </span>"interaction": { "type": "placeResource", "prompt": { "en": "Click to place a Trade Post and log your observation.", "es": "Haga clic para colocar un Puesto Comercial y registrar su observaci√≥n.", "fr": "Cliquez pour placer un Poste de Commerce et enregistrer votre observation." } },</p>
<p class="p1"><span class="Apple-converted-space">                </span>},</p>
<p class="p1"><span class="Apple-converted-space">                </span>"aztec_chinampa": {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>"title": { "en": "Aztec: Chinampas (Floating Gardens)", "es": "Azteca: Chinampas (Jardines Flotantes)", "fr": "Azt√®que: Chinampas (Jardins Flottants)" },</p>
<p class="p1"><span class="Apple-converted-space">                    </span>"short": { "en": "Study the ingenious agricultural system that fed the massive capital of Tenochtitlan.", "es": "Estudie el ingenioso sistema agr√≠cola que aliment√≥ la enorme capital de Tenochtitlan.", "fr": "√âtudiez le syst√®me agricole ing√©nieux qui a nourri la capitale massive de Tenochtitlan." },</p>
<p class="p1"><span class="Apple-converted-space">                    </span>"scene_url": "https://placehold.co/900x500/104351/F0F0F0?text=Aztec+Lake+Texcoco+Site",</p>
<p class="p1"><span class="Apple-converted-space">                    </span>"narration": {<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">                        </span>"en": "The Aztec capital, Tenochtitlan, was built on a swampy island in Lake Texcoco. To overcome the lack of arable land and feed a growing population of hundreds of thousands, the Aztecs engineered **Chinampas**, or 'floating gardens'. These were highly fertile, rectangular plots of land created by layering mud, vegetation, and decaying matter onto the lakebed, providing **multiple harvests a year** and a stable food supply.",</p>
<p class="p1"><span class="Apple-converted-space">                        </span>"es": "La capital Azteca, Tenochtitlan, fue construida en una isla pantanosa en el Lago Texcoco. Para superar la falta de tierra cultivable y alimentar a una poblaci√≥n creciente de cientos de miles, los Aztecas ingeniaron **Chinampas**, o 'jardines flotantes'. Eran parcelas de tierra rectangulares y muy f√©rtiles creadas al superponer barro, vegetaci√≥n y materia en descomposici√≥n sobre el lecho del lago, proporcionando **m√∫ltiples cosechas al a√±o** y un suministro estable de alimentos.",</p>
<p class="p1"><span class="Apple-converted-space">                        </span>"fr": "La capitale Azt√®que, Tenochtitlan, a √©t√© construite sur une √Æle mar√©cageuse du lac Texcoco. Pour pallier le manque de terres arables et nourrir une population croissante de centaines de milliers d'habitants, les Azt√®ques ont con√ßu les **Chinampas**, ou 'jardines flottants'. Il s'agissait de parcelles de terre rectangulaires tr√®s fertiles, cr√©√©es en superposant de la boude, de la v√©g√©tation et de la mati√®re en d√©composition sur le fond du lac, permettant **plusieurs r√©coltes par an** et un approvisionnement alimentaire stable."</p>
<p class="p1"><span class="Apple-converted-space">                    </span>},</p>
<p class="p1"><span class="Apple-converted-space">                    </span>"interaction": { "type": "buildChinampa", "prompt": { "en": "Click to simulate building a Chinampa and log your observation.", "es": "Haga clic para simuler la construcci√≥n de una Chinampa et enregistrer votre observation.", "fr": "Cliquez pour simuler la construction d'une Chinampa et enregistrer votre observation." } },</p>
<p class="p1"><span class="Apple-converted-space">                </span>},</p>
<p class="p1"><span class="Apple-converted-space">                </span>"inca_terrace": {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>"title": { "en": "Inca: Terrace Farming (Andes)", "es": "Inca: Cultivo en Terrazas (Andes)", "fr": "Inca: Agriculture en Terrasses (Andes)" },</p>
<p class="p1"><span class="Apple-converted-space">                    </span>"short": { "en": "View the engineering marvel of stable, high-altitude agriculture in the steep Andean mountains.", "es": "Vea la maravilla de ingenier√≠a de la agricultura estable a gran altura en las escarpadas monta√±as andinas.", "fr": "D√©couvrez la merveille d'ing√©nierie de l'agriculture stable en haute altitude dans les montagnes abruptes." },</p>
<p class="p1"><span class="Apple-converted-space">                    </span>"scene_url": "https://placehold.co/900x500/5A5A5A/F0F0F0?text=Inca+Andes+Mountain+Site",</p>
<p class="p1"><span class="Apple-converted-space">                    </span>"narration": {<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">                        </span>"en": "Living high in the **Andes Mountains**, the Inca faced the extreme challenge of steep slopes and variable climate. Their solution was **terrace farming**. By constructing massive stone walls to create flat, stepped fields, they not only stabilized the mountain slopes against **erosion** but also created **microclimates**. These tiered systems captured and conserved precious rainfall, allowing them to cultivate crops like potatoes and quinoa efficiently at altitudes up to 12,000 feet.",</p>
<p class="p1"><span class="Apple-converted-space">                        </span>"es": "Viviendo en lo alto de las **Monta√±as de los Andes**, los Incas enfrentaron el desaf√≠o extremo de las laderas empinadas y el clima variable. Su soluci√≥n fue la **agricultura en terrazas**. Al construir enormes muros de piedra para crear campos planos y escalonados, no solo estabilizaron las laderas contra la **erosi√≥n**, sino que tambi√©n crearon **microclimas**. Estos sistemas escalonados captaban y conservaban las preciosas lluvias, permiti√©ndoles cultivar eficientemente cosechas como la papa y la quinua a altitudes de hasta 12,000 pies.",</p>
<p class="p1"><span class="Apple-converted-space">                        </span>"fr": "Vivant en altitude dans les **montagnes des Andes**, les Incas ont √©t√© confront√©s au d√©fi extr√™me des pentes raides et d'un climat variable. Leur solution fut l'**agriculture en terrasses**. En construisant des murs de pierre massifs pour cr√©er des champs plats et √©tag√©s, ils ont non seulement stabilis√© les pentes contre l'**√©rosion**, mais ont √©galement cr√©√© des **microclimats**. Ces syst√®mes √©tag√©s captaient et conservaient les pr√©cieuses eaux de pluie, leur permettant de cultiver efficacement des cultures comme la pomme de terre et le quinoa √† des altitudes allant jusqu'√† 12 000 pieds."</p>
<p class="p1"><span class="Apple-converted-space">                    </span>},</p>
<p class="p1"><span class="Apple-converted-space">                    </span>"interaction": { "type": "buildTerrace", "prompt": { "en": "Click to simulate building a Terrace and log your observation.", "es": "Haga clic para simular la construcci√≥n de una Terraza y registrar su observaci√≥n.", "fr": "Cliquez pour simuler la construction d'une Terraza y enregistrer su observation." } },</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>},</p>
<p class="p1"><span class="Apple-converted-space">            </span>"sentence_frames": {</p>
<p class="p1"><span class="Apple-converted-space">                </span>"central_idea": {<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">                    </span>"en": "The primary way ancient civilizations adapted to their environments was by __________.",</p>
<p class="p1"><span class="Apple-converted-space">                    </span>"es": "La forma principal en que las civilizaciones antiguas se adaptaron a sus entornos fue mediante __________.",</p>
<p class="p1"><span class="Apple-converted-space">                    </span>"fr": "La principale fa√ßon dont les civilisations antiques se sont adapt√©es √† leurs environnements fut de __________."</p>
<p class="p1"><span class="Apple-converted-space">                </span>},</p>
<p class="p1"><span class="Apple-converted-space">                </span>"detail_prompt": {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>"en": "The first key detail that supports this idea is the use of ______ by the ______ civilization, which addressed the challenge of ______.",</p>
<p class="p1"><span class="Apple-converted-space">                    </span>"es": "El primer detalle clave que apoya esta idea es el uso de ______ por la civilizaci√≥n de los ______, que abord√≥ el desaf√≠o de ______.",</p>
<p class="p1"><span class="Apple-converted-space">                    </span>"fr": "Le premier d√©tail cl√© qui soutient cette id√©e est l'utilisation de ______ par la civilisation ______, qui a relev√© le d√©fi de ______."</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>};</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>// --- Firebase Initialization and Authentication ---</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>async function initializeFirebase() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const dbStatusEl = document.getElementById('db-status');</p>
<p class="p1"><span class="Apple-converted-space">            </span>dbStatusEl.textContent = 'Connecting...';</p>
<p class="p1"><span class="Apple-converted-space">            </span>dbStatusEl.className = 'px-3 py-1 text-xs font-medium rounded-full bg-gray-600 text-gray-200';</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>if (!firebaseConfig || !firebaseConfig.apiKey.startsWith('AIzaSy')) { // Basic check for placeholder key</p>
<p class="p1"><span class="Apple-converted-space">                </span>dbStatusEl.textContent = 'DB Error: Placeholder Config';</p>
<p class="p1"><span class="Apple-converted-space">                </span>dbStatusEl.className = 'px-3 py-1 text-xs font-medium rounded-full bg-red-800 text-red-200';</p>
<p class="p1"><span class="Apple-converted-space">                </span>console.error("Firebase config is missing or is using a placeholder. Code will run, but persistence will not work.");</p>
<p class="p1"><span class="Apple-converted-space">                </span>// Allow the app to run without persistence for demonstration</p>
<p class="p1"><span class="Apple-converted-space">                </span>currentUserId = 'demo-user-' + Math.random().toString(36).substring(2, 8);</p>
<p class="p1"><span class="Apple-converted-space">                </span>isDbConnected = false;</p>
<p class="p1"><span class="Apple-converted-space">                </span>dbStatusEl.textContent = `Demo User: ${currentUserId}`;</p>
<p class="p1"><span class="Apple-converted-space">                </span>dbStatusEl.className = 'px-3 py-1 text-xs font-medium rounded-full bg-yellow-700 text-yellow-100';</p>
<p class="p1"><span class="Apple-converted-space">                </span>loadWork(true); // Load with fallback only</p>
<p class="p1"><span class="Apple-converted-space">                </span>return;</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>try {</p>
<p class="p1"><span class="Apple-converted-space">                </span>const app = initializeApp(firebaseConfig);</p>
<p class="p1"><span class="Apple-converted-space">                </span>db = getFirestore(app);</p>
<p class="p1"><span class="Apple-converted-space">                </span>auth = getAuth(app);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                </span>// Removed signInWithCustomToken since it's an internal-only flow and not provided</p>
<p class="p1"><span class="Apple-converted-space">                </span>await signInAnonymously(auth);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                </span>await new Promise(resolve =&gt; onAuthStateChanged(auth, user =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>if (user) {</p>
<p class="p1"><span class="Apple-converted-space">                        </span>currentUserId = user.uid;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">                        </span>// Fallback if sign-in fails</p>
<p class="p1"><span class="Apple-converted-space">                        </span>currentUserId = crypto.randomUUID();<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">                    </span>}</p>
<p class="p1"><span class="Apple-converted-space">                    </span>isDbConnected = true;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>dbStatusEl.textContent = `User ID: ${currentUserId.substring(0, 8)}...`;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>dbStatusEl.className = 'px-3 py-1 text-xs font-medium rounded-full bg-green-700 text-green-100';</p>
<p class="p1"><span class="Apple-converted-space">                    </span>resolve();</p>
<p class="p1"><span class="Apple-converted-space">                </span>}));</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                </span>loadWork(); // Load with persistence</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>} catch (error) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>dbStatusEl.textContent = 'DB Error: Auth Failed';</p>
<p class="p1"><span class="Apple-converted-space">                </span>dbStatusEl.className = 'px-3 py-1 text-xs font-medium rounded-full bg-red-800 text-red-200';</p>
<p class="p1"><span class="Apple-converted-space">                </span>console.error("Firebase initialization or authentication failed:", error);</p>
<p class="p1"><span class="Apple-converted-space">                </span>// Fallback to local user</p>
<p class="p1"><span class="Apple-converted-space">                </span>currentUserId = 'demo-user-fallback';</p>
<p class="p1"><span class="Apple-converted-space">                </span>isDbConnected = false;</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>// --- Firestore Data Paths and Functions ---</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>function getStudentWorkDocRef() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (!db || !currentUserId) return null;</p>
<p class="p1"><span class="Apple-converted-space">            </span>return doc(db, 'artifacts', appId, 'users', currentUserId, 'responseFrames', 'mainAssignment');</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function getTeacherCollectionRef() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (!db) return null;</p>
<p class="p1"><span class="Apple-converted-space">            </span>// CRITICAL FIX: The path to a teacher collection must include a final document reference for setDoc</p>
<p class="p1"><span class="Apple-converted-space">            </span>// The teacher list should listen to the 'studentResponses' collection, but writing should be to a doc.</p>
<p class="p1"><span class="Apple-converted-space">            </span>return collection(db, 'artifacts', appId, 'public', 'data', 'studentResponses');</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>/**</p>
<p class="p1"><span class="Apple-converted-space">         </span>* Saves work to Firestore (and potentially a public teacher collection).</p>
<p class="p1"><span class="Apple-converted-space">         </span>* @param {string} field - The specific field to update (e.g., 'centralIdea').</p>
<p class="p1"><span class="Apple-converted-space">         </span>* @param {string} value - The value for the field.</p>
<p class="p1"><span class="Apple-converted-space">         </span>* @param {Object} completedHotspotsData - The complete object of completed hotspots.</p>
<p class="p1"><span class="Apple-converted-space">         </span>*/</p>
<p class="p1"><span class="Apple-converted-space">        </span>async function saveWork(field, value, completedHotspotsData) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const saveStatusEl = document.getElementById('save-status');</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (!isDbConnected || !currentUserId) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>// If not connected, save locally for now (not implemented, but good practice)</p>
<p class="p1"><span class="Apple-converted-space">                </span>saveStatusEl.textContent = 'Demo Mode: Data Not Saved to Cloud';</p>
<p class="p1"><span class="Apple-converted-space">                </span>return;</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>const docRef = getStudentWorkDocRef();</p>
<p class="p1"><span class="Apple-converted-space">            </span>const teacherDocRef = doc(getTeacherCollectionRef(), currentUserId); // Doc reference for the teacher collection</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>saveStatusEl.textContent = 'Saving...';</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>const updateData = {};</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (field) updateData[field] = value;</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (completedHotspotsData) updateData.completedHotspots = completedHotspotsData;</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>try {</p>
<p class="p1"><span class="Apple-converted-space">                </span>const timestamp = new Date().toISOString();</p>
<p class="p1"><span class="Apple-converted-space">                </span>updateData.lastUpdated = timestamp;</p>
<p class="p1"><span class="Apple-converted-space">                </span>updateData.userId = currentUserId;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                </span>await setDoc(docRef, updateData, { merge: true });</p>
<p class="p1"><span class="Apple-converted-space">                </span>await setDoc(teacherDocRef, updateData, { merge: true }); // Save to public teacher view</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                </span>saveStatusEl.textContent = `Saved automatically at ${new Date().toLocaleTimeString()}`;</p>
<p class="p1"><span class="Apple-converted-space">            </span>} catch (error) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>saveStatusEl.textContent = 'Save Failed!';</p>
<p class="p1"><span class="Apple-converted-space">                </span>console.error("Error saving work to Firestore:", error);</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>/**</p>
<p class="p1"><span class="Apple-converted-space">         </span>* Loads student work from Firestore and sets up a real-time listener.</p>
<p class="p1"><span class="Apple-converted-space">         </span>* @param {boolean} isDemo - Flag to indicate if running in demo mode (no listener)</p>
<p class="p1"><span class="Apple-converted-space">         </span>*/</p>
<p class="p1"><span class="Apple-converted-space">        </span>function loadWork(isDemo = false) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (!isDbConnected || !currentUserId || isDemo) return;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>const docRef = getStudentWorkDocRef();</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>onSnapshot(docRef, (docSnap) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (docSnap.exists()) {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>const data = docSnap.data();</p>
<p class="p2"><span class="Apple-converted-space">                    </span></p>
<p class="p1"><span class="Apple-converted-space">                    </span>if (data.centralIdea) document.getElementById('central-idea-input').value = data.centralIdea;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>if (data.detail1) document.getElementById('detail-1-input').value = data.detail1;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>if (data.detail2) document.getElementById('detail-2-input').value = data.detail2;</p>
<p class="p2"><span class="Apple-converted-space">                    </span></p>
<p class="p1"><span class="Apple-converted-space">                    </span>if (data.completedHotspots) {</p>
<p class="p1"><span class="Apple-converted-space">                        </span>completedHotspots = data.completedHotspots; // CRITICAL FIX: Update global object</p>
<p class="p1"><span class="Apple-converted-space">                        </span>Object.keys(completedHotspots).forEach(hotspotId =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                            </span>if (completedHotspots[hotspotId] === true) {</p>
<p class="p1"><span class="Apple-converted-space">                                </span>const cardId = hotspotId.replace(/_/g, '-') + '-card';</p>
<p class="p1"><span class="Apple-converted-space">                                </span>const card = document.getElementById(cardId);</p>
<p class="p2"><span class="Apple-converted-space">                                </span></p>
<p class="p1"><span class="Apple-converted-space">                                </span>if (card) {</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>card.classList.add('completed');</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>const statusElementId = hotspotId.replace(/_/g, '-') + '-status';</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>const statusElement = document.getElementById(statusElementId);</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>if(statusElement) statusElement.classList.remove('hidden');</p>
<p class="p1"><span class="Apple-converted-space">                                </span>}</p>
<p class="p1"><span class="Apple-converted-space">                            </span>}</p>
<p class="p1"><span class="Apple-converted-space">                        </span>});</p>
<p class="p1"><span class="Apple-converted-space">                    </span>}</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>}, (error) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>console.error("Error loading work in real-time:", error);</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>/**</p>
<p class="p1"><span class="Apple-converted-space">         </span>* Loads submissions for the teacher view.</p>
<p class="p1"><span class="Apple-converted-space">         </span>*/</p>
<p class="p1"><span class="Apple-converted-space">        </span>function loadTeacherSubmissions() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const submissionsListEl = document.getElementById('submissions-list');</p>
<p class="p1"><span class="Apple-converted-space">            </span>submissionsListEl.innerHTML = '';</p>
<p class="p1"><span class="Apple-converted-space">            </span>submissionsListEl.innerHTML = `&lt;p class="text-gray-500" id="loading-submissions"&gt;${getLocalizedText('ui.loading_submissions')}&lt;/p&gt;`;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>if (!isDbConnected) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>submissionsListEl.innerHTML = `&lt;p class="text-red-500"&gt;Cannot load teacher data: Database connection failed.&lt;/p&gt;`;</p>
<p class="p1"><span class="Apple-converted-space">                </span>return;</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>const colRef = getTeacherCollectionRef();</p>
<p class="p1"><span class="Apple-converted-space">            </span>// Query to listen to the top few submissions</p>
<p class="p1"><span class="Apple-converted-space">            </span>const q = query(colRef, limit(10));</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>onSnapshot(q, (snapshot) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>const submissions = [];</p>
<p class="p1"><span class="Apple-converted-space">                </span>snapshot.forEach(doc =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>const data = doc.data();</p>
<p class="p1"><span class="Apple-converted-space">                    </span>submissions.push(data);</p>
<p class="p1"><span class="Apple-converted-space">                </span>});</p>
<p class="p2"><span class="Apple-converted-space">                </span></p>
<p class="p1"><span class="Apple-converted-space">                </span>submissionsListEl.innerHTML = ''; // Clear loading message</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                </span>if (submissions.length === 0) {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>submissionsListEl.innerHTML = `&lt;p class="text-gray-500"&gt;No submissions found yet.&lt;/p&gt;`;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>return;</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                </span>submissions.forEach(sub =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>const hotspotCount = sub.completedHotspots ? Object.values(sub.completedHotspots).filter(v =&gt; v).length : 0;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>submissionsListEl.innerHTML += `</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div class="bg-gray-800 p-4 rounded-lg shadow-md border-l-4 border-blue-500"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;p class="font-bold text-white mb-1"&gt;Student: ${sub.userId ? sub.userId.substring(0, 8) + '...' : 'N/A'}&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;p class="text-sm text-gray-400"&gt;Last Updated: ${new Date(sub.lastUpdated).toLocaleTimeString()}&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;p class="text-sm text-green-400 mt-2"&gt;Hotspots Completed: ${hotspotCount}/3&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;p class="mt-2 text-gray-300"&gt;Central Idea: ${sub.centralIdea || 'Not started'}&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;p class="text-gray-300"&gt;Detail 1: ${sub.detail1 || 'Not started'}&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>`;</p>
<p class="p1"><span class="Apple-converted-space">                </span>});</p>
<p class="p1"><span class="Apple-converted-space">            </span>}, (error) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>console.error("Error loading teacher submissions:", error);</p>
<p class="p1"><span class="Apple-converted-space">                </span>submissionsListEl.innerHTML = `&lt;p class="text-red-500"&gt;Error loading data: ${error.message}&lt;/p&gt;`;</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>// --- UI/Localization &amp; Event Handlers ---</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>let currentLocale = APP_DATA.locale;</p>
<p class="p1"><span class="Apple-converted-space">        </span>let audioCtx = null;</p>
<p class="p1"><span class="Apple-converted-space">        </span>let ttsAudio = null;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function initAudio() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (!audioCtx) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>try {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>audioCtx = new (window.AudioContext || window.webkitAudioContext)();</p>
<p class="p1"><span class="Apple-converted-space">                </span>} catch (e) {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>console.error("Audio Context initialization failed:", e);</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (audioCtx &amp;&amp; audioCtx.state === 'suspended') {</p>
<p class="p1"><span class="Apple-converted-space">                </span>audioCtx.resume().catch(e =&gt; console.error("Failed to resume AudioContext:", e));</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>// CRITICAL FIX: The TTS functionality is missing. A functional mock is added.</p>
<p class="p1"><span class="Apple-converted-space">        </span>function playVoiceover(hotspotId) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>initAudio();</p>
<p class="p1"><span class="Apple-converted-space">            </span>const narrationText = getLocalizedText(`hotspots.${hotspotId}.narration`);</p>
<p class="p1"><span class="Apple-converted-space">            </span>console.log(`Simulating voiceover for: ${narrationText}`);</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Use browser's built-in Web Speech API as a mock for the voiceover</p>
<p class="p1"><span class="Apple-converted-space">            </span>if ('speechSynthesis' in window) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (ttsAudio) window.speechSynthesis.cancel();</p>
<p class="p1"><span class="Apple-converted-space">                </span>ttsAudio = new SpeechSynthesisUtterance(narrationText);</p>
<p class="p1"><span class="Apple-converted-space">                </span>ttsAudio.lang = currentLocale;</p>
<p class="p1"><span class="Apple-converted-space">                </span>window.speechSynthesis.speak(ttsAudio);</p>
<p class="p1"><span class="Apple-converted-space">            </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">                </span>alert(`[TTS] Narration for ${hotspotId}: ${narrationText}`);</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function getLocalizedText(path, locale = currentLocale) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const parts = path.split('.');</p>
<p class="p1"><span class="Apple-converted-space">            </span>let data = APP_DATA;</p>
<p class="p1"><span class="Apple-converted-space">            </span>for (const part of parts) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (data &amp;&amp; data.hasOwnProperty(part)) {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>data = data[part];</p>
<p class="p1"><span class="Apple-converted-space">                </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>return `[Missing Text: ${path}]`;</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (typeof data === 'object' &amp;&amp; data !== null &amp;&amp; data.hasOwnProperty(locale)) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>return data[locale];</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>return data;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function updateTimerDisplay() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const timeElapsed = Date.now() - sessionStartTime;</p>
<p class="p1"><span class="Apple-converted-space">            </span>const remainingTimeMs = Math.max(0, (1800 * 1000) - timeElapsed); // 30 minutes limit</p>
<p class="p1"><span class="Apple-converted-space">            </span>const totalSeconds = Math.floor(remainingTimeMs / 1000);</p>
<p class="p1"><span class="Apple-converted-space">            </span>const minutes = String(Math.floor(totalSeconds / 60)).padStart(2, '0');</p>
<p class="p1"><span class="Apple-converted-space">            </span>const seconds = String(totalSeconds % 60).padStart(2, '0');</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>const timerEl = document.getElementById('session-timer');</p>
<p class="p1"><span class="Apple-converted-space">            </span>const timerText = getLocalizedText('ui.session_timer');</p>
<p class="p1"><span class="Apple-converted-space">            </span>timerEl.textContent = timerText.replace('{mm}', minutes).replace('{ss}', seconds);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>if (remainingTimeMs === 0 &amp;&amp; timerInterval) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>clearInterval(timerInterval);</p>
<p class="p1"><span class="Apple-converted-space">                </span>timerEl.textContent = "TIME EXPIRED";</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>function render() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById('choose-language').textContent = getLocalizedText('ui.choose_language');</p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById('explore-mode-btn').textContent = getLocalizedText('ui.explore_mode');</p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById('teacher-view-btn').textContent = getLocalizedText('ui.teacher_view');</p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById('response-frame-title').textContent = getLocalizedText('ui.response_frame_title');</p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById('export-analytics-btn').textContent = getLocalizedText('ui.export_analytics');</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>Object.entries(APP_DATA.hotspots).forEach(([id, data]) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>const elementIdBase = id.replace(/_/g, '-');</p>
<p class="p2"><span class="Apple-converted-space">                </span></p>
<p class="p1"><span class="Apple-converted-space">                </span>const titleEl = document.getElementById(`${elementIdBase}-title`);</p>
<p class="p1"><span class="Apple-converted-space">                </span>const shortEl = document.getElementById(`${elementIdBase}-short`);</p>
<p class="p1"><span class="Apple-converted-space">                </span>const promptEl = document.getElementById(`${elementIdBase}-prompt`);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                </span>if (titleEl) titleEl.textContent = data.title[currentLocale];</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (shortEl) shortEl.textContent = data.short[currentLocale];</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (promptEl) promptEl.textContent = data.interaction.prompt[currentLocale];</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById('central-idea-frame').textContent = getLocalizedText('sentence_frames.central_idea', currentLocale);</p>
<p class="p1"><span class="Apple-converted-space">            </span>const detailPrompt = getLocalizedText('sentence_frames.detail_prompt', currentLocale);</p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById('detail-prompt-1').textContent = detailPrompt.replace(/______/g, '_________');</p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById('detail-prompt-2').textContent = detailPrompt.replace(/______/g, '_________');</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>// --- Canvas Visualization Logic ---</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>let offset = 0; // Global animation offset</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>/** Draws the visualization based on the hotspot ID. */</p>
<p class="p1"><span class="Apple-converted-space">        </span>function drawVisualization(hotspotId, canvas, ctx) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (!ctx) return;<span class="Apple-converted-space"> </span></p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Clear Canvas with a semi-transparent black overlay for context depth</p>
<p class="p1"><span class="Apple-converted-space">            </span>ctx.clearRect(0, 0, canvas.width, canvas.height); // CRITICAL FIX: Clear the canvas properly</p>
<p class="p1"><span class="Apple-converted-space">            </span>ctx.fillStyle = 'rgba(0, 0, 0, 0.4)';<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>ctx.fillRect(0, 0, canvas.width, canvas.height);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>const w = canvas.width;</p>
<p class="p1"><span class="Apple-converted-space">            </span>const h = canvas.height;</p>
<p class="p1"><span class="Apple-converted-space">            </span>offset += 0.02; // Slower animation</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>switch (hotspotId) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>case 'maya_river':</p>
<p class="p1"><span class="Apple-converted-space">                    </span>// Simulate water flow/ripple (Cenote)</p>
<p class="p1"><span class="Apple-converted-space">                    </span>ctx.beginPath();</p>
<p class="p1"><span class="Apple-converted-space">                    </span>ctx.fillStyle = 'rgba(66, 153, 225, 0.6)'; // Blue water</p>
<p class="p1"><span class="Apple-converted-space">                    </span>ctx.arc(w / 2, h / 2, Math.min(w, h) / 3, 0, 2 * Math.PI);</p>
<p class="p1"><span class="Apple-converted-space">                    </span>ctx.fill();</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                    </span>// Ripple effect</p>
<p class="p1"><span class="Apple-converted-space">                    </span>for (let i = 0; i &lt; 4; i++) {</p>
<p class="p1"><span class="Apple-converted-space">                        </span>const radius = Math.min(w, h) / 4 + Math.sin(offset + i * 1.5) * 20;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>ctx.beginPath();</p>
<p class="p1"><span class="Apple-converted-space">                        </span>ctx.strokeStyle = 'rgba(129, 230, 217, 0.8)'; // Cyan ripple</p>
<p class="p1"><span class="Apple-converted-space">                        </span>ctx.lineWidth = 2;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>ctx.arc(w / 2, h / 2, radius, 0, 2 * Math.PI);</p>
<p class="p1"><span class="Apple-converted-space">                        </span>ctx.stroke();</p>
<p class="p1"><span class="Apple-converted-space">                    </span>}</p>
<p class="p1"><span class="Apple-converted-space">                    </span>break;</p>
<p class="p1"><span class="Apple-converted-space">                </span>case 'aztec_chinampa':</p>
<p class="p1"><span class="Apple-converted-space">                    </span>// Simulate Chinampas (Rectangular plots)</p>
<p class="p1"><span class="Apple-converted-space">                    </span>for (let i = 0; i &lt; 5; i++) {</p>
<p class="p1"><span class="Apple-converted-space">                        </span>const x = w * (0.1 + i * 0.18);</p>
<p class="p1"><span class="Apple-converted-space">                        </span>const y = h * 0.3 + Math.sin(offset + i) * 30;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>const plotWidth = w * 0.15;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>const plotHeight = h * 0.4;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                        </span>// Water (Blue)</p>
<p class="p1"><span class="Apple-converted-space">                        </span>ctx.fillStyle = 'rgba(49, 130, 206, 0.3)';</p>
<p class="p1"><span class="Apple-converted-space">                        </span>ctx.fillRect(0, 0, w, h);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                        </span>// Land plot (Green/Brown)</p>
<p class="p1"><span class="Apple-converted-space">                        </span>ctx.fillStyle = 'rgba(56, 161, 105, 0.9)';</p>
<p class="p1"><span class="Apple-converted-space">                        </span>ctx.fillRect(x, y, plotWidth, plotHeight);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                        </span>// Animated crops (Dots)</p>
<p class="p1"><span class="Apple-converted-space">                        </span>for (let j = 0; j &lt; 5; j++) {</p>
<p class="p1"><span class="Apple-converted-space">                            </span>ctx.beginPath();</p>
<p class="p1"><span class="Apple-converted-space">                            </span>ctx.fillStyle = 'rgba(255, 255, 0, 0.8)';</p>
<p class="p1"><span class="Apple-converted-space">                            </span>ctx.arc(x + plotWidth * 0.2 + j * (plotWidth * 0.15), y + plotHeight * 0.8 + Math.sin(offset * 5 + i * j) * 5, 3, 0, 2 * Math.PI);</p>
<p class="p1"><span class="Apple-converted-space">                            </span>ctx.fill();</p>
<p class="p1"><span class="Apple-converted-space">                        </span>}</p>
<p class="p1"><span class="Apple-converted-space">                    </span>}</p>
<p class="p1"><span class="Apple-converted-space">                    </span>break;</p>
<p class="p1"><span class="Apple-converted-space">                </span>case 'inca_terrace':</p>
<p class="p1"><span class="Apple-converted-space">                    </span>// Simulate Terrace Farming (Steps)</p>
<p class="p1"><span class="Apple-converted-space">                    </span>for (let i = 0; i &lt; 6; i++) {</p>
<p class="p1"><span class="Apple-converted-space">                        </span>const stepHeight = h / 6;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>const y = h - (i + 1) * stepHeight;</p>
<p class="p2"><span class="Apple-converted-space">                        </span></p>
<p class="p1"><span class="Apple-converted-space">                        </span>// Stone wall (Gray)</p>
<p class="p1"><span class="Apple-converted-space">                        </span>ctx.fillStyle = 'rgba(113, 128, 150, 0.8)';<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">                        </span>ctx.fillRect(0, y, w, 10);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                        </span>// Soil/Field (Brown/Green)</p>
<p class="p1"><span class="Apple-converted-space">                        </span>ctx.fillStyle = 'rgba(107, 70, 50, 0.7)';<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">                        </span>ctx.fillRect(0, y - stepHeight + 10, w, stepHeight - 10);</p>
<p class="p2"><span class="Apple-converted-space">                        </span></p>
<p class="p1"><span class="Apple-converted-space">                        </span>// Animated plants (Lines)</p>
<p class="p1"><span class="Apple-converted-space">                        </span>for(let j = 0; j &lt; 20; j++) {</p>
<p class="p1"><span class="Apple-converted-space">                             </span>ctx.beginPath();</p>
<p class="p1"><span class="Apple-converted-space">                             </span>ctx.strokeStyle = 'rgba(198, 246, 213, 0.9)';</p>
<p class="p1"><span class="Apple-converted-space">                             </span>ctx.lineWidth = 1;</p>
<p class="p1"><span class="Apple-converted-space">                             </span>const plantX = w / 20 * j + Math.sin(offset + i + j) * 5;</p>
<p class="p1"><span class="Apple-converted-space">                             </span>ctx.moveTo(plantX, y - stepHeight + 15);</p>
<p class="p1"><span class="Apple-converted-space">                             </span>ctx.lineTo(plantX, y - 20 - (i*5));</p>
<p class="p1"><span class="Apple-converted-space">                             </span>ctx.stroke();</p>
<p class="p1"><span class="Apple-converted-space">                        </span>}</p>
<p class="p1"><span class="Apple-converted-space">                    </span>}</p>
<p class="p1"><span class="Apple-converted-space">                    </span>break;</p>
<p class="p1"><span class="Apple-converted-space">                </span>default:</p>
<p class="p1"><span class="Apple-converted-space">                    </span>ctx.fillStyle = '#FF0000';</p>
<p class="p1"><span class="Apple-converted-space">                    </span>ctx.font = '30px Arial';</p>
<p class="p1"><span class="Apple-converted-space">                    </span>ctx.fillText('Select a Hotspot', w / 2 - 100, h / 2);</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Loop the animation</p>
<p class="p1"><span class="Apple-converted-space">            </span>animationFrameId = requestAnimationFrame(() =&gt; drawVisualization(hotspotId, canvas, ctx));</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>// --- Main Initialization and Listeners ---</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>document.addEventListener('DOMContentLoaded', () =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">            </span>initializeFirebase();</p>
<p class="p1"><span class="Apple-converted-space">            </span>render();</p>
<p class="p1"><span class="Apple-converted-space">            </span>timerInterval = setInterval(updateTimerDisplay, 1000); // Start timer</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Language Selector</p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById('language-selector').addEventListener('change', (e) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>currentLocale = e.target.value;</p>
<p class="p1"><span class="Apple-converted-space">                </span>APP_DATA.locale = currentLocale;</p>
<p class="p1"><span class="Apple-converted-space">                </span>render();</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Input Debounce for auto-saving</p>
<p class="p1"><span class="Apple-converted-space">            </span>let saveTimeout;</p>
<p class="p1"><span class="Apple-converted-space">            </span>document.querySelectorAll('.assignment-input').forEach(input =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>input.addEventListener('input', (e) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>clearTimeout(saveTimeout);</p>
<p class="p1"><span class="Apple-converted-space">                    </span>const field = e.target.dataset.field;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>const value = e.target.value;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>saveTimeout = setTimeout(() =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                        </span>saveWork(field, value, completedHotspots);</p>
<p class="p1"><span class="Apple-converted-space">                    </span>}, 1000); // Wait 1 second after last input</p>
<p class="p1"><span class="Apple-converted-space">                </span>});</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Hotspot Card Click to Open Modal</p>
<p class="p1"><span class="Apple-converted-space">            </span>document.querySelectorAll('.hotspot-card').forEach(card =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>card.addEventListener('click', (e) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>// Prevent opening modal if clicking the voiceover button</p>
<p class="p1"><span class="Apple-converted-space">                    </span>if (e.target.closest('.play-voiceover-btn')) return;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                    </span>const hotspotId = card.dataset.hotspotId;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>const data = APP_DATA.hotspots[hotspotId];</p>
<p class="p1"><span class="Apple-converted-space">                    </span>const modal = document.getElementById('visualization-modal');</p>
<p class="p1"><span class="Apple-converted-space">                    </span>const canvas = document.getElementById('visualization-canvas');</p>
<p class="p1"><span class="Apple-converted-space">                    </span>const ctx = canvas.getContext('2d');</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                    </span>if (!data) return;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                    </span>// Set Modal Content</p>
<p class="p1"><span class="Apple-converted-space">                    </span>document.getElementById('modal-title').textContent = data.title[currentLocale];</p>
<p class="p1"><span class="Apple-converted-space">                    </span>document.getElementById('modal-narration').innerHTML = data.narration[currentLocale]; // Use innerHTML to allow **bolding**</p>
<p class="p1"><span class="Apple-converted-space">                    </span>document.getElementById('modal-interaction-prompt').textContent = data.interaction.prompt[currentLocale];</p>
<p class="p1"><span class="Apple-converted-space">                    </span>document.getElementById('scene-image').src = data.scene_url; // Set context image</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                    </span>// Show Modal</p>
<p class="p1"><span class="Apple-converted-space">                    </span>modal.style.display = 'flex'; // CRITICAL FIX: Set to 'flex' to make it visible and centered</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                    </span>// Stop any existing animation and start new one</p>
<p class="p1"><span class="Apple-converted-space">                    </span>if (animationFrameId) cancelAnimationFrame(animationFrameId);</p>
<p class="p2"><span class="Apple-converted-space">                    </span></p>
<p class="p1"><span class="Apple-converted-space">                    </span>// CRITICAL FIX: Set canvas size based on wrapper's rendered size</p>
<p class="p1"><span class="Apple-converted-space">                    </span>const wrapper = document.getElementById('canvas-wrapper');</p>
<p class="p1"><span class="Apple-converted-space">                    </span>canvas.width = wrapper.clientWidth;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>canvas.height = wrapper.clientHeight;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                    </span>drawVisualization(hotspotId, canvas, ctx);</p>
<p class="p1"><span class="Apple-converted-space">                    </span>initAudio(); // Initialize audio context on first user interaction</p>
<p class="p1"><span class="Apple-converted-space">                </span>});</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Modal Interaction (Canvas Click to Complete Hotspot)</p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById('visualization-canvas').addEventListener('click', () =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>const modal = document.getElementById('visualization-modal');</p>
<p class="p1"><span class="Apple-converted-space">                </span>const hotspotTitleEl = document.getElementById('modal-title');</p>
<p class="p2"><span class="Apple-converted-space">                </span></p>
<p class="p1"><span class="Apple-converted-space">                </span>// Extract hotspotId from the title (e.g., "Maya: Cenotes (..)" -&gt; "maya_river")</p>
<p class="p1"><span class="Apple-converted-space">                </span>const currentTitle = hotspotTitleEl.textContent;</p>
<p class="p1"><span class="Apple-converted-space">                </span>const entry = Object.entries(APP_DATA.hotspots).find(([id, data]) =&gt; data.title[currentLocale] === currentTitle);</p>
<p class="p2"><span class="Apple-converted-space">                </span></p>
<p class="p1"><span class="Apple-converted-space">                </span>if (entry) {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>const hotspotId = entry[0];</p>
<p class="p1"><span class="Apple-converted-space">                    </span>completedHotspots[hotspotId] = true;</p>
<p class="p2"><span class="Apple-converted-space">                    </span></p>
<p class="p1"><span class="Apple-converted-space">                    </span>// Update UI and save progress</p>
<p class="p1"><span class="Apple-converted-space">                    </span>const cardId = hotspotId.replace(/_/g, '-') + '-card';</p>
<p class="p1"><span class="Apple-converted-space">                    </span>const card = document.getElementById(cardId);</p>
<p class="p1"><span class="Apple-converted-space">                    </span>if(card) {</p>
<p class="p1"><span class="Apple-converted-space">                        </span>card.classList.add('completed');</p>
<p class="p1"><span class="Apple-converted-space">                        </span>document.getElementById(hotspotId.replace(/_/g, '-') + '-status').classList.remove('hidden');</p>
<p class="p1"><span class="Apple-converted-space">                    </span>}</p>
<p class="p2"><span class="Apple-converted-space">                    </span></p>
<p class="p1"><span class="Apple-converted-space">                    </span>saveWork(null, null, completedHotspots); // Save the updated completedHotspots object</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                    </span>// Close the modal</p>
<p class="p1"><span class="Apple-converted-space">                    </span>modal.style.display = 'none';</p>
<p class="p1"><span class="Apple-converted-space">                    </span>if (animationFrameId) cancelAnimationFrame(animationFrameId);</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Close Modal Button</p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById('modal-close-btn').addEventListener('click', () =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>document.getElementById('visualization-modal').style.display = 'none';</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (animationFrameId) cancelAnimationFrame(animationFrameId);</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (ttsAudio) window.speechSynthesis.cancel();</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Close Modal on outside click (window)</p>
<p class="p1"><span class="Apple-converted-space">            </span>window.addEventListener('click', (event) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>const modal = document.getElementById('visualization-modal');</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (event.target === modal) {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>modal.style.display = 'none';</p>
<p class="p1"><span class="Apple-converted-space">                    </span>if (animationFrameId) cancelAnimationFrame(animationFrameId);</p>
<p class="p1"><span class="Apple-converted-space">                    </span>if (ttsAudio) window.speechSynthesis.cancel();</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Voiceover Button</p>
<p class="p1"><span class="Apple-converted-space">            </span>document.querySelectorAll('.play-voiceover-btn').forEach(btn =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>btn.addEventListener('click', (e) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>const hotspotId = e.currentTarget.dataset.hotspot;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>playVoiceover(hotspotId);</p>
<p class="p1"><span class="Apple-converted-space">                </span>});</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Teacher/Student View Toggle</p>
<p class="p1"><span class="Apple-converted-space">            </span>const exploreView = document.getElementById('explore-mode-view');</p>
<p class="p1"><span class="Apple-converted-space">            </span>const teacherView = document.getElementById('teacher-view-content');</p>
<p class="p1"><span class="Apple-converted-space">            </span>const exploreBtn = document.getElementById('explore-mode-btn');</p>
<p class="p1"><span class="Apple-converted-space">            </span>const teacherBtn = document.getElementById('teacher-view-btn');</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>exploreBtn.addEventListener('click', () =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>exploreView.classList.remove('hidden');</p>
<p class="p1"><span class="Apple-converted-space">                </span>teacherView.classList.add('hidden');</p>
<p class="p1"><span class="Apple-converted-space">                </span>exploreBtn.classList.replace('bg-gray-600', 'bg-blue-600');</p>
<p class="p1"><span class="Apple-converted-space">                </span>teacherBtn.classList.replace('bg-blue-600', 'bg-gray-600');</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>teacherBtn.addEventListener('click', () =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>exploreView.classList.add('hidden');</p>
<p class="p1"><span class="Apple-converted-space">                </span>teacherView.classList.remove('hidden');</p>
<p class="p1"><span class="Apple-converted-space">                </span>teacherBtn.classList.replace('bg-gray-600', 'bg-blue-600');</p>
<p class="p1"><span class="Apple-converted-space">                </span>exploreBtn.classList.replace('bg-blue-600', 'bg-gray-600');</p>
<p class="p1"><span class="Apple-converted-space">                </span>loadTeacherSubmissions(); // Load data when switching to teacher view</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Window resize handler to maintain aspect ratio on canvas</p>
<p class="p1"><span class="Apple-converted-space">            </span>window.addEventListener('resize', () =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>const modal = document.getElementById('visualization-modal');</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (modal.style.display === 'flex') {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>const canvas = document.getElementById('visualization-canvas');</p>
<p class="p1"><span class="Apple-converted-space">                    </span>const wrapper = document.getElementById('canvas-wrapper');</p>
<p class="p1"><span class="Apple-converted-space">                    </span>canvas.width = wrapper.clientWidth;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>canvas.height = wrapper.clientHeight;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>// Restart animation to redraw with new dimensions</p>
<p class="p1"><span class="Apple-converted-space">                    </span>if (animationFrameId) cancelAnimationFrame(animationFrameId);</p>
<p class="p1"><span class="Apple-converted-space">                    </span>// This relies on knowing the currently open hotspot, which is tricky.</p>
<p class="p1"><span class="Apple-converted-space">                    </span>// A simple redraw without a full loop restart will suffice for a static change.</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Initial call to ensure Explore mode is visible on load</p>
<p class="p1"><span class="Apple-converted-space">            </span>exploreBtn.click();<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>});</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/script&gt;</p>
<p class="p1">&lt;/body&gt;</p>
<p class="p1">&lt;/html&gt;</p>
</body>
</html>
